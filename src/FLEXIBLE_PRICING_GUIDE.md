# 灵活资源定价系统使用指南 📊

## 🎯 系统概述

费米集群的灵活资源定价系统支持**分层定价策略**，为所有算力、网络、存储资源提供灵活的价格配置能力。

### 核心特性

- ✅ **默认定价**：全局默认价格，作为基准
- ✅ **可用区定价**：不同可用区可设置不同价格
- ✅ **资源池定价**：针对特定资源池的差异化定价
- ✅ **节点定价**：最细粒度的节点级定价
- ✅ **定价继承**：资源若无额外配置则自动使用上层定价

---

## 📐 定价继承规则

### 优先级顺序

```
节点价格 > 资源池价格 > 可用区价格 > 默认价格
```

### 继承示例

假设要查询 `可用区A` 中 `资源池1` 的 `节点001` 上的 `A100-40GB GPU` 价格：

```
1. 系统首先查找：节点001 的 A100-40GB 定价
   └─ 如果找到 → 使用节点价格 ✅
   
2. 如果节点未配置，查找：资源池1 的 A100-40GB 定价
   └─ 如果找到 → 使用资源池价格 ✅
   
3. 如果资源池未配置，查找：可用区A 的 A100-40GB 定价
   └─ 如果找到 → 使用可用区价格 ✅
   
4. 如果可用区未配置，使用：默认 A100-40GB 定价
   └─ 使用默认价格 ✅
```

### 优势

- **灵活性**：支持不同粒度的差异化定价
- **简化运维**：只需配置差异部分，其他自动继承
- **降低成本**：针对性优化高/低成本资源的定价

---

## 🚀 快速开始

### 访问定价管理页面

```
http://localhost:5173/flexible-pricing-management
```

或通过导航：
```
费用中心 → 计费配置 → 价格管理
```

---

## 📋 功能说明

### 1. 查看定价规则

页面支持多种视图：

#### 📑 标签页视图
- **全部**：显示所有定价规则
- **默认定价**：全局默认价格
- **可用区**：按可用区分组的价格
- **资源池**：按资源池分组的价格
- **节点**：按节点分组的价格

#### 🔍 筛选功能
- **范围筛选**：按定价范围过滤（默认/可用区/资源池/节点）
- **资源类型筛选**：按资源类型过滤（GPU/CPU/内存/存储/网络）
- **搜索**：搜索资源规格、名称、描述

---

### 2. 创建定价规则

点击**"新建定价规则"**按钮，填写以下信息：

#### 必填字段

1. **定价范围** *
   - `默认定价`：全局默认价格，优先级最低
   - `可用区定价`：特定可用区价格，覆盖默认价格
   - `资源池定价`：特定资源池价格，覆盖可用区价格
   - `节点定价`：特定节点价格，优先级最高

2. **资源类型** *
   - GPU
   - CPU
   - 内存
   - 存储
   - 网络

3. **单价** *
   - 数值，保留两位小数
   - 货币单位：CNY（人民币）

4. **计费单位** *
   - 示例：`卡·小时`, `核·小时`, `GB·小时`, `GB·月`

5. **计费周期** *
   - 按小时（hourly）
   - 按天（daily）
   - 按月（monthly）

6. **生效日期** *
   - 规则开始生效的日期时间

#### 可选字段

1. **范围ID**（非默认定价时必填）
   - 可用区ID、资源池ID 或 节点ID
   - 示例：`zone-001`, `pool-gpu-high`, `node-gpu-001`

2. **范围名称**
   - 显示名称，便于识别
   - 示例：`成都可用区A`, `高性能GPU资源池`

3. **资源规格**
   - 具体的资源型号
   - 示例：`A100-40GB`, `A100-80GB`, `V100-32GB`, `SSD`, `HDD`

4. **失效日期**
   - 规则结束生效的日期时间
   - 不填表示永久有效

5. **描述**
   - 定价规则的说明信息

6. **启用状态**
   - 开关按钮，控制规则是否生效

---

### 3. 编辑定价规则

点击表格中的**编辑**按钮，修改定价规则信息。

**注意**：
- 修改后立即生效（如果启用状态为开）
- 建议在修改前备份原有配置

---

### 4. 删除定价规则

点击表格中的**删除**按钮，确认后删除规则。

**警告**：
- 删除后立即生效，使用该规则的资源将回退到上层定价
- 删除操作不可恢复，请谨慎操作

---

### 5. 测试定价查询

点击**"测试定价查询"**按钮，可以测试分层定价的实际效果。

#### 测试步骤

1. 选择资源类型（如：GPU）
2. 输入资源规格（如：A100-40GB）
3. 可选输入：
   - 可用区ID（如：zone-001）
   - 资源池ID（如：pool-001）
   - 节点ID（如：node-001）
4. 点击**"查询定价"**

#### 查询结果

系统会显示：
- **单价**：实际应用的价格
- **计费单位**：如 `卡·小时`
- **定价继承链**：展示价格的来源路径
- **应用的定价规则**：具体使用了哪条规则

---

## 💡 最佳实践

### 1. 合理设置默认定价

**建议**：
- 为所有资源类型设置默认定价
- 默认价格应该是**最常见场景**的价格
- 定期审查并更新默认价格

**示例**：
```
GPU定价：
- A100-40GB: ¥25.0/卡·小时
- A100-80GB: ¥35.0/卡·小时
- V100-32GB: ¥18.0/卡·小时
- T4-16GB: ¥8.0/卡·小时

CPU定价：
- CPU核心: ¥0.5/核·小时

内存定价：
- 内存: ¥0.1/GB·小时

存储定价：
- SSD: ¥0.5/GB·月
- HDD: ¥0.2/GB·月

网络定价：
- 出网流量: ¥0.8/GB
- 入网流量: ¥0.0/GB（免费）
```

---

### 2. 可用区差异化定价

**使用场景**：
- 不同地域的成本差异
- 电力成本高低
- 机房等级差异

**示例**：
```
成都可用区A（电力成本低）：
- A100-40GB: ¥23.0/卡·小时（比默认便宜¥2）

北京可用区A（机房等级高）：
- SSD: ¥0.6/GB·月（比默认贵¥0.1）
```

---

### 3. 资源池专项定价

**使用场景**：
- 高性能资源池（高配置）
- 低成本资源池（老旧设备）
- 专用资源池（特定项目）

**示例**：
```
高性能GPU资源池：
- V100-32GB: ¥20.0/卡·小时（比默认贵¥2）
  原因：配置更好的NVMe存储和万兆网络

低成本计算资源池：
- CPU核心: ¥0.3/核·小时（比默认便宜¥0.2）
  原因：使用老旧服务器，适合开发测试
```

---

### 4. 节点级精细定价

**使用场景**：
- 测试新设备（优惠价吸引用户测试）
- 即将下线设备（低价促销）
- 特殊用途节点（专用定价）

**示例**：
```
节点GPU-001（新设备测试）：
- A100-40GB: ¥22.0/卡·小时（优惠价）
  原因：刚上线，需要用户测试稳定性

节点GPU-099（即将下线）：
- V100-32GB: ¥15.0/卡·小时（清库存价）
  原因：设备老化，计划下线
```

---

## 📊 定价示例场景

### 场景1：标准GPU训练任务

**需求**：用户需要在成都可用区A租用2张A100-40GB，训练24小时

**定价查询**：
```typescript
queryPricing({
  resourceType: 'gpu',
  resourceSpec: 'A100-40GB',
  zoneId: 'zone-001', // 成都可用区A
  poolId: undefined,
  nodeId: undefined,
})
```

**结果**：
```
单价: ¥23.0/卡·小时
继承链: zone:zone-001 (成都可用区A定价覆盖了默认价格)
总费用: 2卡 × 24小时 × ¥23.0 = ¥1,104.0
```

---

### 场景2：高性能资源池GPU任务

**需求**：用户在高性能GPU资源池租用1张V100，运行12小时

**定价查询**：
```typescript
queryPricing({
  resourceType: 'gpu',
  resourceSpec: 'V100-32GB',
  zoneId: 'zone-001',
  poolId: 'pool-001', // 高性能GPU资源池
  nodeId: undefined,
})
```

**结果**：
```
单价: ¥20.0/卡·小时
继承链: pool:pool-001 (资源池定价覆盖了可用区和默认价格)
总费用: 1卡 × 12小时 × ¥20.0 = ¥240.0
```

---

### 场景3：特定节点GPU任务

**需求**：用户在节点GPU-001上租用1张A100-40GB，运行48小时

**定价查询**：
```typescript
queryPricing({
  resourceType: 'gpu',
  resourceSpec: 'A100-40GB',
  zoneId: 'zone-001',
  poolId: 'pool-001',
  nodeId: 'node-001', // 节点GPU-001
})
```

**结果**：
```
单价: ¥22.0/卡·小时
继承链: node:node-001 (节点定价优先级最高)
总费用: 1卡 × 48小时 × ¥22.0 = ¥1,056.0
```

---

## 🔧 集成到计费系统

### 在代码中使用定价服务

```typescript
import { queryPricing, calculateResourceCost } from '@/services/pricingService';

// 1. 查询单个资源价格
const pricing = await queryPricing({
  resourceType: 'gpu',
  resourceSpec: 'A100-40GB',
  zoneId: 'zone-001',
  poolId: 'pool-001',
  nodeId: 'node-001',
});

console.log(`单价: ${pricing.pricePerUnit} ${pricing.unit}`);
console.log(`继承链: ${pricing.scopeChain.join(' → ')}`);

// 2. 计算资源总费用
const cost = await calculateResourceCost(
  'gpu',              // 资源类型
  'A100-40GB',        // 资源规格
  2,                  // 数量：2卡
  24,                 // 时长：24小时
  {
    zoneId: 'zone-001',
    poolId: 'pool-001',
    nodeId: 'node-001',
  }
);

console.log(`总费用: ¥${cost.totalCost.toFixed(2)}`);
console.log(`应用规则: ${cost.appliedRule.id}`);
```

---

## 📈 数据统计

### 查看定价覆盖率

```typescript
const allRules = await getAllPricingRules();

const stats = {
  total: allRules.length,
  default: allRules.filter(r => r.scope === 'default').length,
  zone: allRules.filter(r => r.scope === 'zone').length,
  pool: allRules.filter(r => r.scope === 'pool').length,
  node: allRules.filter(r => r.scope === 'node').length,
  enabled: allRules.filter(r => r.enabled).length,
  disabled: allRules.filter(r => !r.enabled).length,
};

console.log('定价规则统计:', stats);
```

---

## 🛡️ 安全建议

### 1. 权限控制

**建议**：
- 仅管理员可创建/修改/删除定价规则
- 普通用户只能查看定价信息
- 审计所有定价变更操作

### 2. 变更通知

**建议**：
- 定价变更前提前通知用户
- 重要变更需要审批流程
- 记录变更原因和责任人

### 3. 备份策略

**建议**：
- 定期导出定价配置
- 重大变更前手动备份
- 保留历史定价记录

---

## ❓ 常见问题

### Q1: 为什么我的定价没有生效？

**可能原因**：
1. 规则未启用（enabled = false）
2. 生效日期在未来
3. 已过失效日期
4. 范围ID填写错误

**解决方法**：
- 检查规则的启用状态
- 检查生效/失效日期
- 使用"测试定价查询"功能验证

---

### Q2: 如何批量修改某类资源的价格？

**方法1**：逐条编辑
- 在定价管理页面逐条修改

**方法2**：API批量操作（未来支持）
- 通过API批量创建/更新规则

**方法3**：导入导出（未来支持）
- 导出Excel，批量修改后导入

---

### Q3: 定价规则太多，如何管理？

**建议**：
- 使用描述字段添加备注
- 合理使用筛选和搜索功能
- 定期清理过期或无效规则
- 使用命名规范（如：zone-001-gpu-a100）

---

### Q4: 如何实现临时促销价格？

**方法**：
1. 创建新的定价规则
2. 设置较低的价格
3. 设置生效日期和失效日期
4. 促销结束后自动失效，回退到原价

**示例**：
```
双十一促销：
- A100-40GB: ¥20.0/卡·小时
- 生效: 2024-11-11 00:00
- 失效: 2024-11-11 23:59
```

---

## 📞 技术支持

- **文档版本**: v1.0.0
- **更新日期**: 2024-12-06
- **技术团队**: 费米集群开发团队
- **反馈渠道**: [创建Issue或联系管理员]

---

## 🎉 开始使用

现在你已经了解了灵活资源定价系统的所有功能，快去配置你的第一条定价规则吧！

**推荐步骤**：
1. 📍 访问 `http://localhost:5173/flexible-pricing-management`
2. 📋 查看默认定价规则（已预设）
3. ➕ 创建一条可用区定价规则
4. 🧪 使用"测试定价查询"验证
5. 🚀 将定价服务集成到你的应用中

祝使用愉快！💫
