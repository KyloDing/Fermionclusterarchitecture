# RBAC权限系统 - 快速测试指南

## 🚀 快速开始

### 测试账号

| 角色 | 用户名 | 密码 | 姓名 | 权限范围 |
|------|--------|------|------|---------|
| 系统管理员 | `admin` | `admin123` | 系统管理员 | 完全权限 |
| 普通用户 | `user` | `user123` | 张三 | 业务资源 |
| 开发者 | `developer` | `dev123` | 李四 | 业务资源+高级监控 |
| 运维人员 | `operator` | `ops123` | 王五 | 平台资源+监控调度 |

---

## 📝 测试用例

### 测试用例 1：系统管理员完全权限

**步骤：**
1. 使用 `admin / admin123` 登录
2. 查看侧边栏菜单
3. 依次访问以下页面：
   - 算力资源 → 计算节点
   - 算力资源 → GPU资源池
   - 资源调度 → 调度中心
   - 费用中心 → 计费配置
   - 用户与权限 → 用户管理

**预期结果：**
- ✅ 侧边栏显示所有菜单组（8个）
- ✅ 可以访问所有页面
- ✅ 登录后Toast显示："欢迎回来，系统管理员！角色：admin, user"
- ✅ "算力资源"组可见
- ✅ "资源调度"组可见
- ✅ "用户与权限"组可见
- ✅ 所有管理功能按钮可见

---

### 测试用例 2：普通用户受限权限

**步骤：**
1. 退出当前账号
2. 使用 `user / user123` 登录
3. 查看侧边栏菜单
4. 尝试访问 `/users` (用户管理页面)
5. 尝试访问 `/compute-nodes` (计算节点页面)

**预期结果：**
- ✅ 登录后Toast显示："欢迎回来，张三！角色：user"
- ✅ 侧边栏**不显示**以下菜单组：
  - ❌ 算力资源
  - ❌ 资源调度
  - ❌ 用户与权限
- ✅ 侧边栏**显示**以下菜单组：
  - ✅ 总览
  - ✅ AI工作负载
  - ✅ 数据资产
  - ✅ 存储管理
  - ✅ 费用中心
  - ✅ 监控中心
- ❌ 访问 `/users` 时显示权限拒绝提示或重定向
- ❌ 访问 `/compute-nodes` 时显示权限拒绝提示或重定向

---

### 测试用例 3：开发者增强权限

**步骤：**
1. 使用 `developer / dev123` 登录
2. 查看侧边栏菜单
3. 与普通用户对比

**预期结果：**
- ✅ 登录后Toast显示："欢迎回来，李四！角色：developer, user"
- ✅ 菜单显示与普通用户相同
- ✅ 但具有高级监控权限（在监控页面可以看到更多信息）
- ✅ 可以查看任务队列（如果该菜单项存在）

---

### 测试用例 4：运维人员权限

**步骤：**
1. 使用 `operator / ops123` 登录
2. 查看侧边栏菜单
3. 访问以下页面：
   - 算力资源 → 计算节点 (应该可以访问)
   - 算力资源 → GPU资源池 (应该可以访问)
   - 资源调度 → 调度中心 (应该可以访问)
   - 用户与权限 → 用户管理 (应该无法访问)
   - 费用中心 → 账户余额 (应该无法访问)

**预期结果：**
- ✅ 登录后Toast显示："欢迎回来，王五！角色：operator, user"
- ✅ 侧边栏**显示**：
  - ✅ 算力资源
  - ✅ 资源调度
  - ✅ 监控中心
- ✅ 侧边栏**不显示**：
  - ❌ 用户与权限
  - ❌ 费用中心（大部分菜单）
- ✅ 可以访问和管理平台资源
- ❌ 无法访问用户管理
- ❌ 无法访问费用相关页面

---

### 测试用例 5：菜单动态过滤

**步骤：**
1. 依次使用4个不同角色的账号登录
2. 记录每个角色看到的菜单组和菜单项数量

**预期结果：**

| 角色 | 总览 | 算力资源 | AI工作负载 | 数据资产 | 存储管理 | 资源调度 | 费用中心 | 监控中心 | 用户与权限 |
|------|------|---------|-----------|---------|---------|---------|---------|---------|----------|
| 管理员 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 普通用户 | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ | ❌ |
| 开发者 | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ | ❌ |
| 运维人员 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ❌ |

---

### 测试用例 6：页面权限保护

**前提：**需要在App.tsx中为相应页面添加PermissionGuard

**步骤：**
1. 使用普通用户账号登录
2. 在浏览器地址栏直接输入以下URL尝试访问：
   - `/users`
   - `/roles`
   - `/billing-config`
   - `/pricing-management`
   - `/compute-nodes`
   - `/gpu-pools`

**预期结果：**
- ❌ 所有页面应该显示权限拒绝提示或自动重定向到dashboard
- ✅ Toast提示："您没有权限访问此功能"

---

### 测试用例 7：功能按钮权限

**前提：**需要在相应页面添加PermissionButton

**步骤：**
1. 管理员登录，访问计算节点页面
2. 查看是否有"创建节点"、"编辑"、"删除"等按钮
3. 切换到普通用户登录（如果页面可访问）
4. 查看按钮是否隐藏

**预期结果（管理员）：**
- ✅ 显示所有管理按钮
- ✅ "创建节点"按钮可见
- ✅ "编辑"、"删除"按钮可见

**预期结果（普通用户）：**
- ❌ 管理按钮不可见或禁用
- ❌ 只能查看信息，无法操作

---

### 测试用例 8：资源所有权

**前提：**需要在资源列表页面实现ResourcePermission

**步骤：**
1. 使用普通用户A创建一个训练任务
2. 退出并使用普通用户B登录
3. 查看训练任务列表
4. 尝试操作用户A创建的训练任务

**预期结果：**
- ✅ 用户B只能看到自己创建的训练任务
- ❌ 用户B看不到用户A创建的训练任务
- ✅ 用户B可以编辑/删除自己的训练任务
- ❌ 用户B无法编辑/删除其他用户的训练任务

---

### 测试用例 9：费用中心权限

**步骤：**
1. 使用管理员登录，访问"费用中心"
2. 查看侧边栏"费用中心"组的菜单项
3. 切换到普通用户登录
4. 再次查看"费用中心"组的菜单项

**预期结果（管理员）：**
- ✅ 显示所有费用相关菜单：
  - 账户余额
  - 订单管理
  - 账单详情
  - 发票管理
  - 政府算力券
  - 计费配置 ✨
  - 定价管理 ✨
  - 折扣管理 ✨

**预期结果（普通用户）：**
- ✅ 只显示业务相关菜单：
  - 账户余额
  - 订单管理
  - 账单详情
  - 发票管理
  - 政府算力券
- ❌ 不显示管理菜单：
  - 计费配置
  - 定价管理
  - 折扣管理

---

### 测试用例 10：快速登录功能

**步骤：**
1. 访问登录页面
2. 切换到"账号密码"标签页
3. 观察测试账号区域
4. 点击不同角色的账号按钮

**预期结果：**
- ✅ 显示4个角色的快速登录按钮：
  - 系统管理员（红色badge：完全权限）
  - 普通用户（绿色badge：业务资源）
  - 开发者
  - 运维人员
- ✅ 点击按钮后自动填充用户名和密码
- ✅ 点击登录按钮可以直接登录
- ✅ 不同角色使用不同颜色的badge区分

---

## 🎯 关键测试点

### 1. 菜单显示
- [ ] 管理员可以看到9个菜单组
- [ ] 普通用户只能看到6个菜单组
- [ ] 运维人员可以看到7个菜单组
- [ ] 无权限的菜单组完全不显示

### 2. 页面访问
- [ ] 直接URL访问受保护页面被拦截
- [ ] 显示友好的权限拒绝提示
- [ ] 或自动重定向到有权限的页面

### 3. 功能按钮
- [ ] 管理功能按钮只对管理员显示
- [ ] 创建/编辑/删除按钮根据权限显示
- [ ] 普通用户看不到平台资源管理按钮

### 4. 数据过滤
- [ ] 普通用户只能看到自己的资源
- [ ] 管理员可以看到所有资源
- [ ] 运维人员可以看到所有资源（只读）

### 5. 登录体验
- [ ] Toast显示正确的用户名和角色
- [ ] 快速登录按钮工作正常
- [ ] 不同角色登录后跳转到dashboard

---

## 🐛 常见问题

### Q: 登录后看不到任何菜单？
**A**: 检查用户的roles字段是否正确设置。确保至少有一个角色。

### Q: 菜单过滤不生效？
**A**: 
1. 检查usePermissions hook是否正确导入
2. 检查menuItems中的requiredPermissions配置
3. 检查filterMenuByPermissions函数逻辑

### Q: 页面权限保护不生效？
**A**: 确保在App.tsx的路由配置中添加了PermissionGuard组件。

### Q: 切换账号后菜单没有更新？
**A**: 刷新页面或重新登录。确保AuthContext正确更新了用户信息。

---

## ✅ 测试通过标准

测试通过需要满足：
- [ ] 所有4个测试账号都能正常登录
- [ ] 菜单根据角色正确过滤
- [ ] 管理员可以访问所有页面
- [ ] 普通用户无法访问管理页面
- [ ] 快速登录功能正常工作
- [ ] Toast正确显示角色信息
- [ ] 无权限时显示友好提示

---

## 📞 问题反馈

如发现问题，请记录：
1. 使用的测试账号
2. 问题描述
3. 重现步骤
4. 预期结果 vs 实际结果
5. 浏览器控制台错误信息

---

## 🔄 持续改进

测试完成后需要：
1. [ ] 为所有受保护页面添加PermissionGuard
2. [ ] 为关键操作按钮添加PermissionButton
3. [ ] 实现资源所有权过滤逻辑
4. [ ] 添加更友好的权限拒绝页面
5. [ ] 完善权限审计日志
