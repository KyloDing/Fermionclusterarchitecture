# è´¹ç±³é›†ç¾¤è®¡è´¹ä¸ç®—åŠ›åˆ¸ä¼˜åŒ– - å®Œæ•´è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£åŸºäºåŸæœ‰è®¡è´¹ç³»ç»Ÿè®¾è®¡ï¼ˆèµ„æºè®¡é‡ã€å®šä»·å¼•æ“ã€è´¦å•ç”Ÿæˆã€è´¦æˆ·ç®¡ç†ã€è®¢å•ç®¡ç†ã€å‘ç¥¨ç®¡ç†ã€æ”¿åºœç®—åŠ›åˆ¸ï¼‰ï¼Œæ•´åˆ20+æ¡ä¼˜åŒ–ç‚¹ï¼Œå½¢æˆå®Œæ•´çš„åŠŸèƒ½å¢å¼ºæ–¹æ¡ˆã€‚

**ä¼˜åŒ–ç›®æ ‡**ï¼š
- ğŸ¯ æå‡ç”¨æˆ·ä½“éªŒï¼šä¸€é”®æ“ä½œã€æ™ºèƒ½æ¨èã€å®æ—¶åé¦ˆ
- ğŸ’¡ ä¼˜åŒ–æ”¯ä»˜æµç¨‹ï¼šæ··åˆæ”¯ä»˜ã€æ‰¹é‡å¤„ç†ã€è‡ªåŠ¨æŠµæ‰£
- ğŸ¢ æ”¯æŒä¼ä¸šåœºæ™¯ï¼šé»˜è®¤æ–¹æ¡ˆã€OAå¯¹æ¥ã€æƒé™ç®¡ç†
- ğŸ“Š å¢å¼ºå¯è§æ€§ï¼šèŠ‚çœå±•ç¤ºã€é¢„è­¦æé†’ã€ä½¿ç”¨çœ‹æ¿

---

## ğŸ“Š ä¼˜åŒ–ç‚¹ä¼˜å…ˆçº§æ€»è§ˆ

### P0 çº§åˆ«ï¼ˆ5æ˜Ÿï¼Œç«‹å³å®æ–½ï¼‰
1. ä¸€é”®å…¨é¢æŠµæ‰£ + ä¸€é”®é‡æ–°æ™ºèƒ½æ¨è
2. è®¢å•åˆ›å»ºé¡µç›´æ¥å±•ç¤ºé¢„ä¼°è´¹ç”¨ + å¯ç”¨ç®—åŠ›åˆ¸æŠµæ‰£
3. ä½™é¢ + ç®—åŠ›åˆ¸è‡ªåŠ¨æ··åˆæ”¯ä»˜
4. åˆ¸å¿«åˆ°æœŸ/ä½™é¢ä¸è¶³ 7å¤©å†…è‡ªåŠ¨ç½®é¡¶ + æ©™è‰²é«˜äº® + å¼¹çª—æé†’

### P1 çº§åˆ«ï¼ˆ4æ˜Ÿï¼Œä¼˜å…ˆå®æ–½ï¼‰
5. æ”¯æŒå•å¼ åˆ¸æ‹†åˆ†ä½¿ç”¨
6. æ”¯ä»˜é¡µå¢åŠ "ä¿å­˜ä¸ºé»˜è®¤åˆ¸é€‰æ‹©æ–¹æ¡ˆ"
7. è®¢å•åˆ—è¡¨ç›´æ¥å±•ç¤º"å·²æŠµæ‰£åˆ¸é‡‘é¢"å’Œ"å®ä»˜é‡‘é¢"
8. æ”¯æŒæ‰¹é‡æ”¯ä»˜
9. æ‰‹æœºç«¯æ”¯ä»˜æµç¨‹æç®€ç‰ˆ
10. æ¬ è´¹/ä½™é¢ä¸è¶³æ—¶"ä¸€é”®å……å€¼åˆšå¥½å¤Ÿå½“å‰è®¢å•çš„é‡‘é¢"

### P2 çº§åˆ«ï¼ˆ3æ˜Ÿï¼Œåç»­å®æ–½ï¼‰
11. ä¼ä¸šç®¡ç†å‘˜å¯è®¾ç½®"é¡¹ç›®é»˜è®¤åˆ¸"
12. åˆ¸ä½¿ç”¨è®°å½•æ”¯æŒå¯¼å‡º Excel
13. è´¹ç”¨ä¸­å¿ƒé¦–é¡µå¢åŠ "æœ¬æœˆå·²çœåˆ¸é‡‘é¢"å±•ç¤º
14. æ”¯æŒ"åˆ¸+ä½™é¢+å¾®ä¿¡/æ”¯ä»˜å®"æ··æ­
15. è®¢å•æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨è·³è½¬å›èµ„æºåˆ—è¡¨
16. å¢åŠ "åˆ¸å³å°†åˆ°æœŸæ—¥å†æé†’"è®¢é˜…

### P3 çº§åˆ«ï¼ˆ2æ˜Ÿï¼Œé•¿æœŸè§„åˆ’ï¼‰
17. è´¹ç”¨é¢„ä¼°å™¨å°ç¨‹åº/å…¬ä¼—å·ç‰ˆ
18. å¯¹æ¥ä¼ä¸šå¾®ä¿¡/é’‰é’‰å®¡æ‰¹æµ
19. æ”¯æŒ"åˆ¸è½¬èµ "ç»™åŒä¸€ç»„ç»‡å­è´¦å·
20. å¢åŠ "åˆ¸ä½¿ç”¨è¿›åº¦çœ‹æ¿"å¤§å±

---

## ğŸ¯ P0çº§ä¼˜åŒ–è¯¦ç»†è®¾è®¡ï¼ˆç«‹å³å®æ–½ï¼‰

### ä¼˜åŒ–1ï¼šä¸€é”®å…¨é¢æŠµæ‰£ + ä¸€é”®é‡æ–°æ™ºèƒ½æ¨è

#### åŠŸèƒ½æ–‡æ¡£

**éœ€æ±‚æè¿°**
- åœ¨æ”¯ä»˜å¼¹çª—ä¸­ï¼Œé»˜è®¤åº”ç”¨æ™ºèƒ½æ¨èçš„ç®—åŠ›åˆ¸ç»„åˆï¼Œå®ç°ä¸€é”®å…¨é¢æŠµæ‰£
- æ”¯æŒ"ä¸€é”®é‡æ–°æ¨è"æŒ‰é’®ï¼Œé‡æ–°è®¡ç®—æœ€ä¼˜ç»„åˆï¼ˆä¼˜å…ˆå¿«åˆ°æœŸåˆ¸ï¼‰
- ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜åˆ¸ç»„åˆï¼Œç”¨æˆ·å¯æ‰‹åŠ¨è°ƒæ•´

**ä¸šåŠ¡ä»·å€¼**
- âœ… å‡å°‘ç”¨æˆ·æ‰‹åŠ¨æ“ä½œï¼Œé™ä½å†³ç­–æˆæœ¬
- âœ… é¿å…ç®—åŠ›åˆ¸æµªè´¹ï¼Œæå‡ä½¿ç”¨ç‡
- âœ… æé«˜æ”¯ä»˜è½¬åŒ–ç‡ï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

**ä¸šåŠ¡è§„åˆ™**
```typescript
æ™ºèƒ½æ¨èè§„åˆ™ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š
1. ä¼˜å…ˆä½¿ç”¨7å¤©å†…åˆ°æœŸçš„åˆ¸
2. å…¶æ¬¡ä½¿ç”¨30å¤©å†…åˆ°æœŸçš„åˆ¸
3. åŒ¹é…è®¢å•ç±»å‹ï¼ˆGPU/å®ä¾‹/å­˜å‚¨ï¼‰
4. æŒ‰åˆ¸ä½™é¢ä»å°åˆ°å¤§ä½¿ç”¨ï¼ˆé¿å…å¤§é¢åˆ¸æµªè´¹ï¼‰
5. å°½é‡è¦†ç›–è®¢å•é‡‘é¢ï¼Œå®ç°å…¨é¢æŠµæ‰£

è¾¹ç•Œæ¡ä»¶ï¼š
- åˆ¸ä½™é¢ä¸è¶³æ—¶ï¼Œæç¤º"éƒ¨åˆ†æŠµæ‰£ï¼Œéœ€æ”¯ä»˜ Â¥X"
- å®Œå…¨æŠµæ‰£æ—¶æ˜¾ç¤º"å®ä»˜ Â¥0"
- æ— å¯ç”¨åˆ¸æ—¶ï¼Œæ˜¾ç¤º"æš‚æ— å¯ç”¨ç®—åŠ›åˆ¸"
```

**ä¾èµ–å…³ç³»**
- ä¾èµ–ï¼šåŸæœ‰ `voucherService.calculateVoucherDeduction()` é€»è¾‘
- ä¾èµ–ï¼šåŸæœ‰ `PaymentDialog.tsx` ç»„ä»¶
- å½±å“ï¼šæ”¯ä»˜æµç¨‹ã€ç”¨æˆ·ä½“éªŒ

#### äº¤äº’è®¾è®¡

**UI/UXæµç¨‹**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ”¯ä»˜å¯¹è¯æ¡†ï¼ˆPaymentDialogï¼‰                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  è®¢å•é‡‘é¢ï¼šÂ¥1,280.00                                    â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ¯ æ™ºèƒ½æ¨èå·²æŠµæ‰£ Â¥1,000.00                      â”‚  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â”‚ [ğŸ”„ ä¸€é”®é‡æ–°æ¨è]  [âœ¨ ä¸€é”®å…¨é¢æŠµæ‰£]             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  å·²é€‰ç®—åŠ›åˆ¸ï¼ˆ2å¼ ï¼‰ï¼š                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ âœ“ GOV-2024-AI-001 (å‰©ä½™ Â¥65,000)                â”‚  â”‚
â”‚  â”‚   ä½¿ç”¨é‡‘é¢ï¼šÂ¥500.00                              â”‚  â”‚
â”‚  â”‚   ğŸ“… 7å¤©ååˆ°æœŸ                                   â”‚  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â”‚ âœ“ GOV-2024-EDU-023 (å‰©ä½™ Â¥2,000)                â”‚  â”‚
â”‚  â”‚   ä½¿ç”¨é‡‘é¢ï¼šÂ¥500.00                              â”‚  â”‚
â”‚  â”‚   ğŸ“… 15å¤©ååˆ°æœŸ                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  å¯ç”¨ç®—åŠ›åˆ¸ï¼ˆ3å¼ ï¼‰ï¼š                                    â”‚
â”‚  â”‚ â˜ GOV-2024-TECH-001 (å‰©ä½™ Â¥30,000)              â”‚  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  æŠµæ‰£æ˜ç»†ï¼š                                             â”‚
â”‚  ç®—åŠ›åˆ¸æŠµæ‰£ï¼š-Â¥1,000.00                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                       â”‚
â”‚  å®ä»˜é‡‘é¢ï¼šÂ¥280.00                                      â”‚
â”‚                                                         â”‚
â”‚  [å–æ¶ˆ]                    [ç¡®è®¤æ”¯ä»˜ Â¥280.00]          â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’çŠ¶æ€æœº**

```
[åˆå§‹çŠ¶æ€] 
    â†“ æ‰“å¼€æ”¯ä»˜å¯¹è¯æ¡†
    â†“
[è‡ªåŠ¨æ™ºèƒ½æ¨è]
    â”‚ â†’ è°ƒç”¨ voucherService.getRecommendedVouchers()
    â”‚ â†’ è‡ªåŠ¨å‹¾é€‰æ¨èåˆ¸
    â”‚ â†’ è®¡ç®—æŠµæ‰£é‡‘é¢
    â”‚ â†’ æ›´æ–°å®ä»˜é‡‘é¢
    â†“
[æ˜¾ç¤ºæ¨èç»“æœ]
    â”‚
    â”œâ”€â”€â†’ [ç”¨æˆ·ç‚¹å‡»"ä¸€é”®å…¨é¢æŠµæ‰£"]
    â”‚        â†“
    â”‚    [å°è¯•å…¨é¢æŠµæ‰£]
    â”‚        â”‚ â†’ å¦‚æœåˆ¸è¶³å¤Ÿï¼šå®ä»˜ = Â¥0
    â”‚        â”‚ â†’ å¦‚æœåˆ¸ä¸è¶³ï¼šæ˜¾ç¤ºæç¤º"åˆ¸ä¸è¶³ï¼Œå»ºè®®å……å€¼"
    â”‚        â†“
    â”‚    [æ›´æ–°æ˜¾ç¤º]
    â”‚
    â”œâ”€â”€â†’ [ç”¨æˆ·ç‚¹å‡»"ä¸€é”®é‡æ–°æ¨è"]
    â”‚        â†“
    â”‚    [æ¸…ç©ºå½“å‰é€‰æ‹©]
    â”‚        â†“
    â”‚    [é‡æ–°è®¡ç®—æœ€ä¼˜ç»„åˆ]
    â”‚        â†“
    â”‚    [æ›´æ–°æ˜¾ç¤º]
    â”‚
    â””â”€â”€â†’ [ç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´]
             â†“
         [å®æ—¶è®¡ç®—æŠµæ‰£]
             â†“
         [æ›´æ–°å®ä»˜é‡‘é¢]
```

**ä¼ªä»£ç å®ç°**

```typescript
// PaymentDialog.tsx

const PaymentDialog = ({ orderId, orderAmount, onSuccess }) => {
  const [selectedVouchers, setSelectedVouchers] = useState<Voucher[]>([]);
  const [availableVouchers, setAvailableVouchers] = useState<Voucher[]>([]);
  const [deduction, setDeduction] = useState(0);
  const [finalAmount, setFinalAmount] = useState(orderAmount);
  const [loading, setLoading] = useState(false);

  // åˆå§‹åŠ è½½ï¼šè‡ªåŠ¨æ™ºèƒ½æ¨è
  useEffect(() => {
    loadAndRecommend();
  }, [orderAmount]);

  const loadAndRecommend = async () => {
    const vouchers = await voucherService.getAvailableVouchers(orderAmount);
    setAvailableVouchers(vouchers);
    
    // è‡ªåŠ¨æ™ºèƒ½æ¨è
    const recommended = voucherService.getRecommendedVouchers(
      vouchers,
      orderAmount
    );
    setSelectedVouchers(recommended);
    updateDeduction(recommended);
  };

  // æ›´æ–°æŠµæ‰£é‡‘é¢
  const updateDeduction = (vouchers: Voucher[]) => {
    const result = voucherService.calculateVoucherDeduction(
      vouchers,
      orderAmount
    );
    setDeduction(result.totalDeduction);
    setFinalAmount(orderAmount - result.totalDeduction);
  };

  // ä¸€é”®å…¨é¢æŠµæ‰£
  const handleOneClickFullDeduct = async () => {
    setLoading(true);
    try {
      const result = await voucherService.calculateFullDeduction(
        availableVouchers,
        orderAmount
      );
      
      if (result.canFullDeduct) {
        setSelectedVouchers(result.vouchers);
        setDeduction(orderAmount);
        setFinalAmount(0);
        toast.success('å·²å®ç°å…¨é¢æŠµæ‰£ï¼');
      } else {
        setSelectedVouchers(result.vouchers);
        setDeduction(result.maxDeduction);
        setFinalAmount(orderAmount - result.maxDeduction);
        toast.warning(
          `åˆ¸ä½™é¢ä¸è¶³ï¼Œæœ€å¤šå¯æŠµæ‰£ Â¥${result.maxDeduction.toFixed(2)}ï¼Œ` +
          `è¿˜éœ€æ”¯ä»˜ Â¥${(orderAmount - result.maxDeduction).toFixed(2)}`
        );
      }
    } catch (error) {
      toast.error('è®¡ç®—å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setLoading(false);
    }
  };

  // ä¸€é”®é‡æ–°æ¨è
  const handleReRecommend = async () => {
    setLoading(true);
    try {
      // æ¸…ç©ºå½“å‰é€‰æ‹©
      setSelectedVouchers([]);
      
      // é‡æ–°è·å–æœ€æ–°åˆ¸åˆ—è¡¨ï¼ˆå¯èƒ½æœ‰æ–°åˆ¸æˆ–çŠ¶æ€å˜åŒ–ï¼‰
      const vouchers = await voucherService.getAvailableVouchers(orderAmount);
      setAvailableVouchers(vouchers);
      
      // é‡æ–°æ¨è
      const recommended = voucherService.getRecommendedVouchers(
        vouchers,
        orderAmount
      );
      
      setSelectedVouchers(recommended);
      updateDeduction(recommended);
      
      toast.success('å·²é‡æ–°æ™ºèƒ½æ¨è');
    } catch (error) {
      toast.error('æ¨èå¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setLoading(false);
    }
  };

  // æ‰‹åŠ¨é€‰æ‹©/å–æ¶ˆåˆ¸
  const handleToggleVoucher = (voucher: Voucher) => {
    const isSelected = selectedVouchers.find(v => v.id === voucher.id);
    let newSelected: Voucher[];
    
    if (isSelected) {
      newSelected = selectedVouchers.filter(v => v.id !== voucher.id);
    } else {
      newSelected = [...selectedVouchers, voucher];
    }
    
    setSelectedVouchers(newSelected);
    updateDeduction(newSelected);
  };

  return (
    <Dialog open onOpenChange={onClose}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>ç¡®è®¤æ”¯ä»˜</DialogTitle>
        </DialogHeader>

        {/* è®¢å•é‡‘é¢ */}
        <div className="mb-4">
          <p className="text-slate-600">è®¢å•é‡‘é¢</p>
          <p className="text-2xl text-slate-900">
            Â¥{orderAmount.toFixed(2)}
          </p>
        </div>

        {/* æ™ºèƒ½æ¨èæç¤º */}
        {selectedVouchers.length > 0 && (
          <Alert className="bg-purple-50 border-purple-200">
            <Sparkles className="w-4 h-4 text-purple-600" />
            <AlertDescription>
              <strong className="text-purple-900">
                ğŸ¯ æ™ºèƒ½æ¨èå·²æŠµæ‰£ Â¥{deduction.toFixed(2)}
              </strong>
              <p className="text-sm text-slate-700 mt-1">
                å·²è‡ªåŠ¨é€‰æ‹© {selectedVouchers.length} å¼ åˆ¸ï¼Œ
                ä¼˜å…ˆä½¿ç”¨å¿«åˆ°æœŸçš„åˆ¸é¿å…æµªè´¹
              </p>
            </AlertDescription>
          </Alert>
        )}

        {/* ä¸€é”®æ“ä½œæŒ‰é’® */}
        <div className="flex gap-2">
          <Button
            variant="outline"
            onClick={handleReRecommend}
            disabled={loading}
            className="flex-1"
          >
            <RefreshCw className={`w-4 h-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
            ä¸€é”®é‡æ–°æ¨è
          </Button>
          <Button
            onClick={handleOneClickFullDeduct}
            disabled={loading}
            className="flex-1 bg-green-600 hover:bg-green-700"
          >
            <Zap className="w-4 h-4 mr-2" />
            ä¸€é”®å…¨é¢æŠµæ‰£
          </Button>
        </div>

        {/* å·²é€‰ç®—åŠ›åˆ¸åˆ—è¡¨ */}
        {selectedVouchers.length > 0 && (
          <div className="space-y-2">
            <Label>å·²é€‰ç®—åŠ›åˆ¸ï¼ˆ{selectedVouchers.length}å¼ ï¼‰</Label>
            {selectedVouchers.map(voucher => (
              <VoucherCard
                key={voucher.id}
                voucher={voucher}
                selected
                onToggle={handleToggleVoucher}
              />
            ))}
          </div>
        )}

        {/* å¯ç”¨ç®—åŠ›åˆ¸åˆ—è¡¨ */}
        <div className="space-y-2">
          <Label>
            å¯ç”¨ç®—åŠ›åˆ¸ï¼ˆ{availableVouchers.length - selectedVouchers.length}å¼ ï¼‰
          </Label>
          <div className="max-h-60 overflow-y-auto space-y-2">
            {availableVouchers
              .filter(v => !selectedVouchers.find(s => s.id === v.id))
              .map(voucher => (
                <VoucherCard
                  key={voucher.id}
                  voucher={voucher}
                  selected={false}
                  onToggle={handleToggleVoucher}
                />
              ))}
          </div>
        </div>

        {/* æŠµæ‰£æ˜ç»† */}
        <div className="border-t pt-4 space-y-2">
          <div className="flex justify-between text-sm">
            <span className="text-slate-600">ç®—åŠ›åˆ¸æŠµæ‰£</span>
            <span className="text-green-600">-Â¥{deduction.toFixed(2)}</span>
          </div>
          <div className="flex justify-between text-lg font-semibold">
            <span>å®ä»˜é‡‘é¢</span>
            <span className={finalAmount === 0 ? 'text-green-600' : 'text-slate-900'}>
              Â¥{finalAmount.toFixed(2)}
            </span>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>
            å–æ¶ˆ
          </Button>
          <Button onClick={handleConfirmPay} disabled={loading}>
            ç¡®è®¤æ”¯ä»˜ Â¥{finalAmount.toFixed(2)}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
};
```

#### APIæ”¹åŠ¨

**ä¿®æ”¹ç°æœ‰æ¥å£**

```typescript
// GET /api/vouchers/my
// æ–°å¢è¿”å›å­—æ®µ

interface VoucherResponse {
  // ... åŸæœ‰å­—æ®µ
  daysToExpire: number;        // è·ç¦»åˆ°æœŸå¤©æ•°
  priority: number;            // æ¨èä¼˜å…ˆçº§ï¼ˆè¶Šå°è¶Šä¼˜å…ˆï¼‰
  isRecommended: boolean;      // æ˜¯å¦æ™ºèƒ½æ¨è
}

// POST /api/vouchers/calculateDeduction
// æ–°å¢å‚æ•°

interface CalculateDeductionRequest {
  vouchers: string[];          // åˆ¸IDåˆ—è¡¨
  orderAmount: number;         // è®¢å•é‡‘é¢
  autoFullDeduct?: boolean;    // æ˜¯å¦å°è¯•å…¨é¢æŠµæ‰£ï¼ˆæ–°å¢ï¼‰
  orderType?: string;          // è®¢å•ç±»å‹ï¼ˆæ–°å¢ï¼‰
}

interface CalculateDeductionResponse {
  totalDeduction: number;      // æ€»æŠµæ‰£é‡‘é¢
  remainingAmount: number;     // å‰©ä½™éœ€æ”¯ä»˜é‡‘é¢
  canFullDeduct: boolean;      // æ˜¯å¦å¯ä»¥å…¨é¢æŠµæ‰£ï¼ˆæ–°å¢ï¼‰
  voucherUsage: Array<{        // åˆ¸ä½¿ç”¨æ˜ç»†
    voucherId: string;
    useAmount: number;
    remainingAfter: number;
  }>;
}
```

**æ–°å¢æ¥å£**

```typescript
// POST /api/vouchers/getRecommended
// è·å–æ™ºèƒ½æ¨èåˆ¸ç»„åˆ

interface GetRecommendedRequest {
  orderAmount: number;         // è®¢å•é‡‘é¢
  orderType?: string;          // è®¢å•ç±»å‹
  tryFullDeduct?: boolean;     // æ˜¯å¦å°è¯•å…¨é¢æŠµæ‰£
}

interface GetRecommendedResponse {
  recommended: string[];       // æ¨èçš„åˆ¸IDåˆ—è¡¨
  totalDeduction: number;      // é¢„è®¡æŠµæ‰£é‡‘é¢
  canFullDeduct: boolean;      // æ˜¯å¦å¯å…¨é¢æŠµæ‰£
  reason: string;              // æ¨èç†ç”±
}
```

**åç«¯é€»è¾‘å˜åŒ–**

```typescript
// voucherService.ts

class VoucherService {
  /**
   * æ™ºèƒ½æ¨èåˆ¸ç»„åˆ
   */
  async getRecommendedVouchers(
    orderAmount: number,
    orderType?: string,
    tryFullDeduct: boolean = true
  ): Promise<RecommendedResult> {
    // 1. è·å–æ‰€æœ‰å¯ç”¨åˆ¸
    const vouchers = await this.getAvailableVouchers(orderType);
    
    // 2. æŒ‰ä¼˜å…ˆçº§æ’åº
    const sorted = this.sortByPriority(vouchers, orderAmount);
    
    // 3. é€‰æ‹©æœ€ä¼˜ç»„åˆ
    const selected: Voucher[] = [];
    let totalDeduction = 0;
    
    for (const voucher of sorted) {
      if (totalDeduction >= orderAmount && !tryFullDeduct) {
        break; // å·²å¤Ÿæ”¯ä»˜ï¼Œä¸éœ€è¦æ›´å¤šåˆ¸
      }
      
      const useAmount = Math.min(
        voucher.remainingAmount,
        orderAmount - totalDeduction
      );
      
      selected.push({
        ...voucher,
        useAmount
      });
      
      totalDeduction += useAmount;
      
      if (totalDeduction >= orderAmount && tryFullDeduct) {
        break; // è¾¾åˆ°å…¨é¢æŠµæ‰£
      }
    }
    
    return {
      recommended: selected.map(v => v.id),
      vouchers: selected,
      totalDeduction,
      canFullDeduct: totalDeduction >= orderAmount,
      reason: this.generateReason(selected, totalDeduction, orderAmount)
    };
  }

  /**
   * æŒ‰ä¼˜å…ˆçº§æ’åºåˆ¸
   * è§„åˆ™ï¼š
   * 1. 7å¤©å†…åˆ°æœŸ > 30å¤©å†…åˆ°æœŸ > å…¶ä»–
   * 2. åŒ¹é…è®¢å•ç±»å‹ä¼˜å…ˆ
   * 3. ä½™é¢ä»å°åˆ°å¤§ï¼ˆé¿å…æµªè´¹å¤§é¢åˆ¸ï¼‰
   */
  private sortByPriority(
    vouchers: Voucher[],
    orderAmount: number
  ): Voucher[] {
    return vouchers.sort((a, b) => {
      // è®¡ç®—åˆ°æœŸå¤©æ•°
      const daysA = this.getDaysToExpire(a.endDate);
      const daysB = this.getDaysToExpire(b.endDate);
      
      // 7å¤©å†…åˆ°æœŸçš„æœ€ä¼˜å…ˆ
      if (daysA <= 7 && daysB > 7) return -1;
      if (daysA > 7 && daysB <= 7) return 1;
      
      // 30å¤©å†…åˆ°æœŸçš„æ¬¡ä¼˜å…ˆ
      if (daysA <= 30 && daysB > 30) return -1;
      if (daysA > 30 && daysB <= 30) return 1;
      
      // åŒæ ·åˆ°æœŸèŒƒå›´å†…ï¼ŒæŒ‰ä½™é¢ä»å°åˆ°å¤§
      // ä¼˜å…ˆç”¨å®Œå°é¢åˆ¸ï¼Œé¿å…æµªè´¹å¤§é¢åˆ¸
      return a.remainingAmount - b.remainingAmount;
    });
  }

  /**
   * è®¡ç®—å…¨é¢æŠµæ‰£æ–¹æ¡ˆ
   */
  async calculateFullDeduction(
    vouchers: Voucher[],
    orderAmount: number
  ): Promise<FullDeductionResult> {
    const sorted = this.sortByPriority(vouchers, orderAmount);
    const selected: Voucher[] = [];
    let totalDeduction = 0;
    
    for (const voucher of sorted) {
      const useAmount = Math.min(
        voucher.remainingAmount,
        orderAmount - totalDeduction
      );
      
      selected.push({
        ...voucher,
        useAmount
      });
      
      totalDeduction += useAmount;
      
      if (totalDeduction >= orderAmount) {
        break; // è¾¾åˆ°å…¨é¢æŠµæ‰£
      }
    }
    
    return {
      canFullDeduct: totalDeduction >= orderAmount,
      vouchers: selected,
      maxDeduction: totalDeduction,
      shortfall: totalDeduction < orderAmount 
        ? orderAmount - totalDeduction 
        : 0
    };
  }

  private getDaysToExpire(endDate: string): number {
    const now = new Date();
    const end = new Date(endDate);
    const diff = end.getTime() - now.getTime();
    return Math.ceil(diff / (1000 * 60 * 60 * 24));
  }

  private generateReason(
    vouchers: Voucher[],
    totalDeduction: number,
    orderAmount: number
  ): string {
    const expiringSoon = vouchers.filter(v => 
      this.getDaysToExpire(v.endDate) <= 7
    );
    
    if (expiringSoon.length > 0) {
      return `å·²ä¼˜å…ˆä½¿ç”¨ ${expiringSoon.length} å¼ å³å°†åˆ°æœŸçš„åˆ¸ï¼Œé¿å…æµªè´¹`;
    }
    
    if (totalDeduction >= orderAmount) {
      return `å·²å®ç°å…¨é¢æŠµæ‰£ï¼Œå®ä»˜ Â¥0`;
    }
    
    return `å·²é€‰æ‹©æœ€ä¼˜ç»„åˆï¼Œå…±æŠµæ‰£ Â¥${totalDeduction.toFixed(2)}`;
  }
}
```

---

### ä¼˜åŒ–2ï¼šè®¢å•åˆ›å»ºé¡µç›´æ¥å±•ç¤ºé¢„ä¼°è´¹ç”¨ + å¯ç”¨ç®—åŠ›åˆ¸æŠµæ‰£

#### åŠŸèƒ½æ–‡æ¡£

**éœ€æ±‚æè¿°**
- åœ¨è®¢å•åˆ›å»ºç•Œé¢ï¼ˆOrderDetailsDialog.tsxï¼‰å®æ—¶é¢„ä¼°è´¹ç”¨
- æ˜¾ç¤ºå¯ç”¨ç®—åŠ›åˆ¸çš„æœ€å¤§æŠµæ‰£é‡‘é¢
- è®©ç”¨æˆ·åœ¨ä¸‹å•å‰å°±çŸ¥é“å®é™…æ”¯å‡º

**ä¸šåŠ¡ä»·å€¼**
- âœ… æå‡ä»·æ ¼é€æ˜åº¦ï¼Œå‡å°‘ç”¨æˆ·ç–‘è™‘
- âœ… é™ä½è®¢å•æ”¾å¼ƒç‡ï¼Œæé«˜è½¬åŒ–
- âœ… ç»“åˆåŸæœ‰å®šä»·æœåŠ¡ï¼Œæ— ç¼é›†æˆ

**ä¸šåŠ¡è§„åˆ™**
```typescript
é¢„ä¼°æ˜¾ç¤ºè§„åˆ™ï¼š
1. å®æ—¶è®¡ç®—ï¼šç”¨æˆ·é…ç½®å˜åŒ–æ—¶ç«‹å³æ›´æ–°
2. æ˜¾ç¤ºä¸‰ä¸ªé‡‘é¢ï¼š
   - åŸä»·ï¼ˆå®šä»·è§„åˆ™è®¡ç®—ï¼‰
   - åˆ¸å¯æŠµï¼ˆæ™ºèƒ½æ¨èæœ€å¤§æŠµæ‰£ï¼‰
   - é¢„ä¼°å®ä»˜ï¼ˆåŸä»· - åˆ¸æŠµæ‰£ï¼‰
3. åˆ¸ä¸é€‚ç”¨æ—¶éšè—æŠµæ‰£ä¿¡æ¯
4. æ˜¾ç¤ºæŠ˜æ‰£ä¿¡æ¯ï¼ˆç”¨æˆ·ç­‰çº§æŠ˜æ‰£ç­‰ï¼‰

è¾¹ç•Œæ¡ä»¶ï¼š
- é…ç½®ä¸å®Œæ•´æ—¶æ˜¾ç¤º"è¯·å®Œå–„é…ç½®"
- æ— å¯ç”¨åˆ¸æ—¶æ˜¾ç¤º"æš‚æ— å¯ç”¨åˆ¸"
- é¢„ä¼°â‰ æœ€ç»ˆï¼Œæç¤º"å®é™…ä»¥æ”¯ä»˜æ—¶ä¸ºå‡†"
```

#### äº¤äº’è®¾è®¡

**UI/UXæµç¨‹**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»ºè®¢å•å¯¹è¯æ¡†ï¼ˆOrderDetailsDialogï¼‰                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  èµ„æºé…ç½®ï¼š                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ GPUç±»å‹ï¼š[NVIDIA A100 40GB â–¼]                      â”‚ â”‚
â”‚  â”‚ GPUæ•°é‡ï¼š[2 â–¼]                                      â”‚ â”‚
â”‚  â”‚ CPUæ ¸å¿ƒï¼š[8æ ¸ â–¼]                                    â”‚ â”‚
â”‚  â”‚ å†…å­˜ï¼š[32GB â–¼]                                      â”‚ â”‚
â”‚  â”‚ è¿è¡Œæ—¶é•¿ï¼š[24å°æ—¶ â–¼]                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  ğŸ’° è´¹ç”¨é¢„ä¼°ï¼ˆå®æ—¶æ›´æ–°ï¼‰                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚  åŸä»·ï¼šÂ¥720.00                                      â”‚ â”‚
â”‚  â”‚    â”œâ”€ GPU (2å¡Ã—24hÃ—Â¥15)      Â¥720.00              â”‚ â”‚
â”‚  â”‚    â”œâ”€ CPU (8æ ¸Ã—24hÃ—Â¥0.50)    Â¥96.00               â”‚ â”‚
â”‚  â”‚    â””â”€ å†…å­˜ (32GBÃ—24hÃ—Â¥0.10)  Â¥76.80               â”‚ â”‚
â”‚  â”‚                              â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚ â”‚
â”‚  â”‚  å°è®¡ï¼šÂ¥892.80                                      â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚  æŠ˜æ‰£ï¼š                                             â”‚ â”‚
â”‚  â”‚    â””â”€ é»„é‡‘ä¼šå‘˜9æŠ˜            -Â¥89.28              â”‚ â”‚
â”‚  â”‚                              â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚ â”‚
â”‚  â”‚  æŠ˜åï¼šÂ¥803.52                                      â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚  ğŸ ç®—åŠ›åˆ¸å¯æŠµï¼šÂ¥500.00  [æŸ¥çœ‹åˆ¸è¯¦æƒ… â†’]            â”‚ â”‚
â”‚  â”‚                              â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚ â”‚
â”‚  â”‚  é¢„ä¼°å®ä»˜ï¼šÂ¥303.52                                  â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚  ğŸ’¡ å®é™…é‡‘é¢ä»¥æ”¯ä»˜æ—¶ä¸ºå‡†                           â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  [å–æ¶ˆ]                           [ç¡®è®¤åˆ›å»ºè®¢å•]         â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‚¹å‡»"æŸ¥çœ‹åˆ¸è¯¦æƒ…"ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¯ç”¨ç®—åŠ›åˆ¸é¢„è§ˆ                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  æ ¹æ®æ™ºèƒ½æ¨èï¼Œä»¥ä¸‹åˆ¸å¯ç”¨äºæŠµæ‰£æœ¬è®¢å•ï¼š                  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ GOV-2024-AI-001                                    â”‚ â”‚
â”‚  â”‚ å‰©ä½™ Â¥65,000  |  7å¤©ååˆ°æœŸ                         â”‚ â”‚
â”‚  â”‚ å¯æŠµæ‰£ï¼šÂ¥303.52ï¼ˆå…¨é¢ï¼‰                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ GOV-2024-EDU-023                                   â”‚ â”‚
â”‚  â”‚ å‰©ä½™ Â¥2,000  |  15å¤©ååˆ°æœŸ                         â”‚ â”‚
â”‚  â”‚ å¯æŠµæ‰£ï¼šÂ¥196.48ï¼ˆéƒ¨åˆ†ï¼‰                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  ğŸ’¡ æ”¯ä»˜æ—¶å¯é€‰æ‹©åˆ¸ç»„åˆæ–¹å¼                              â”‚
â”‚                                                          â”‚
â”‚  [å…³é—­]                                                 â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®æ—¶é¢„ä¼°æµç¨‹**

```
[ç”¨æˆ·æ‰“å¼€åˆ›å»ºå¯¹è¯æ¡†]
        â†“
[æ˜¾ç¤ºé»˜è®¤é…ç½®]
        â†“
[å®æ—¶ç›‘å¬é…ç½®å˜åŒ–]
        â”‚
        â”œâ”€â†’ GPUç±»å‹å˜åŒ–
        â”œâ”€â†’ GPUæ•°é‡å˜åŒ–
        â”œâ”€â†’ CPU/å†…å­˜å˜åŒ–
        â”œâ”€â†’ æ—¶é•¿å˜åŒ–
        â”‚
        â†“
[è§¦å‘é¢„ä¼°è®¡ç®—] (é˜²æŠ–300ms)
        â”‚
        â”œâ”€â†’ [è°ƒç”¨å®šä»·æœåŠ¡]
        â”‚      â”œâ”€ è®¡ç®—åŸä»·
        â”‚      â”œâ”€ åº”ç”¨æŠ˜æ‰£
        â”‚      â””â”€ è¿”å›æŠ˜åä»·
        â”‚
        â””â”€â†’ [è°ƒç”¨åˆ¸æœåŠ¡]
               â”œâ”€ è·å–å¯ç”¨åˆ¸
               â”œâ”€ è®¡ç®—æœ€å¤§æŠµæ‰£
               â””â”€ è¿”å›å¯æŠµé‡‘é¢
        â†“
[æ›´æ–°æ˜¾ç¤º]
        â”‚
        â”œâ”€ åŸä»·
        â”œâ”€ æŠ˜æ‰£æ˜ç»†
        â”œâ”€ åˆ¸å¯æŠµ
        â””â”€ é¢„ä¼°å®ä»˜
        â†“
[ç­‰å¾…ç”¨æˆ·ä¸‹ä¸€æ­¥æ“ä½œ]
```

**ä¼ªä»£ç å®ç°**

```typescript
// OrderDetailsDialog.tsx

const OrderDetailsDialog = ({ onSuccess }) => {
  const [config, setConfig] = useState<OrderConfig>({
    gpuType: 'A100',
    gpuCount: 2,
    cpuCores: 8,
    memory: 32,
    duration: 24
  });

  const [estimate, setEstimate] = useState<EstimateResult | null>(null);
  const [loading, setLoading] = useState(false);
  const [showVoucherDetail, setShowVoucherDetail] = useState(false);

  // å®æ—¶è®¡ç®—é¢„ä¼°ï¼ˆé˜²æŠ–ï¼‰
  useEffect(() => {
    const timer = setTimeout(() => {
      calculateEstimate();
    }, 300); // 300msé˜²æŠ–

    return () => clearTimeout(timer);
  }, [config]);

  const calculateEstimate = async () => {
    if (!isConfigValid(config)) {
      setEstimate(null);
      return;
    }

    setLoading(true);
    try {
      // 1. è°ƒç”¨å®šä»·æœåŠ¡è®¡ç®—åŸä»·å’ŒæŠ˜æ‰£
      const priceResult = await pricingService.estimate({
        resourceType: 'gpu-instance',
        config: {
          gpuType: config.gpuType,
          gpuCount: config.gpuCount,
          cpuCores: config.cpuCores,
          memory: config.memory,
        },
        duration: config.duration,
        userLevel: currentUser.level
      });

      // 2. è°ƒç”¨åˆ¸æœåŠ¡è®¡ç®—æœ€å¤§æŠµæ‰£
      const voucherResult = await voucherService.calculateMaxDeduction({
        orderAmount: priceResult.finalPrice,
        orderType: 'gpu-instance',
        config: config
      });

      // 3. åˆå¹¶ç»“æœ
      setEstimate({
        originalPrice: priceResult.originalPrice,
        breakdown: priceResult.breakdown,
        discount: priceResult.discount,
        discountAmount: priceResult.discountAmount,
        priceAfterDiscount: priceResult.finalPrice,
        maxVoucherDeduct: voucherResult.maxDeduction,
        availableVouchers: voucherResult.vouchers,
        estimatedFinalAmount: priceResult.finalPrice - voucherResult.maxDeduction
      });
    } catch (error) {
      toast.error('é¢„ä¼°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      setEstimate(null);
    } finally {
      setLoading(false);
    }
  };

  const isConfigValid = (config: OrderConfig): boolean => {
    return config.gpuCount > 0 && config.duration > 0;
  };

  return (
    <Dialog open onOpenChange={onClose}>
      <DialogContent className="max-w-3xl">
        <DialogHeader>
          <DialogTitle>åˆ›å»ºGPUè®­ç»ƒä»»åŠ¡</DialogTitle>
        </DialogHeader>

        {/* èµ„æºé…ç½®è¡¨å• */}
        <div className="space-y-4">
          <Label>èµ„æºé…ç½®</Label>
          
          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label>GPUç±»å‹</Label>
              <Select
                value={config.gpuType}
                onValueChange={(value) => 
                  setConfig({ ...config, gpuType: value })
                }
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="A100">NVIDIA A100 40GB</SelectItem>
                  <SelectItem value="V100">NVIDIA V100 32GB</SelectItem>
                  <SelectItem value="T4">NVIDIA T4 16GB</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div>
              <Label>GPUæ•°é‡</Label>
              <Select
                value={config.gpuCount.toString()}
                onValueChange={(value) => 
                  setConfig({ ...config, gpuCount: parseInt(value) })
                }
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="1">1å¡</SelectItem>
                  <SelectItem value="2">2å¡</SelectItem>
                  <SelectItem value="4">4å¡</SelectItem>
                  <SelectItem value="8">8å¡</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div>
              <Label>CPUæ ¸å¿ƒ</Label>
              <Select
                value={config.cpuCores.toString()}
                onValueChange={(value) => 
                  setConfig({ ...config, cpuCores: parseInt(value) })
                }
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="4">4æ ¸</SelectItem>
                  <SelectItem value="8">8æ ¸</SelectItem>
                  <SelectItem value="16">16æ ¸</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div>
              <Label>å†…å­˜</Label>
              <Select
                value={config.memory.toString()}
                onValueChange={(value) => 
                  setConfig({ ...config, memory: parseInt(value) })
                }
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="16">16GB</SelectItem>
                  <SelectItem value="32">32GB</SelectItem>
                  <SelectItem value="64">64GB</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>

          <div>
            <Label>è¿è¡Œæ—¶é•¿</Label>
            <Select
              value={config.duration.toString()}
              onValueChange={(value) => 
                setConfig({ ...config, duration: parseInt(value) })
              }
            >
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="1">1å°æ—¶</SelectItem>
                <SelectItem value="6">6å°æ—¶</SelectItem>
                <SelectItem value="12">12å°æ—¶</SelectItem>
                <SelectItem value="24">24å°æ—¶</SelectItem>
                <SelectItem value="72">3å¤©</SelectItem>
                <SelectItem value="168">7å¤©</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </div>

        {/* è´¹ç”¨é¢„ä¼°å¡ç‰‡ */}
        <Card className="bg-gradient-to-br from-purple-50 to-blue-50 border-2 border-purple-200">
          <CardHeader>
            <CardTitle className="text-lg flex items-center gap-2">
              <DollarSign className="w-5 h-5 text-purple-600" />
              ğŸ’° è´¹ç”¨é¢„ä¼°ï¼ˆå®æ—¶æ›´æ–°ï¼‰
              {loading && <Loader2 className="w-4 h-4 animate-spin text-purple-600" />}
            </CardTitle>
          </CardHeader>
          <CardContent>
            {estimate ? (
              <div className="space-y-3">
                {/* åŸä»·æ˜ç»† */}
                <div>
                  <div className="flex justify-between text-sm mb-2">
                    <span className="text-slate-600">åŸä»·</span>
                    <span className="text-slate-900">
                      Â¥{estimate.originalPrice.toFixed(2)}
                    </span>
                  </div>
                  {estimate.breakdown && (
                    <div className="ml-4 space-y-1 text-xs text-slate-600">
                      {estimate.breakdown.gpu > 0 && (
                        <div className="flex justify-between">
                          <span>
                            â”œâ”€ GPU ({config.gpuCount}å¡Ã—{config.duration}hÃ—Â¥15)
                          </span>
                          <span>Â¥{estimate.breakdown.gpu.toFixed(2)}</span>
                        </div>
                      )}
                      {estimate.breakdown.cpu > 0 && (
                        <div className="flex justify-between">
                          <span>
                            â”œâ”€ CPU ({config.cpuCores}æ ¸Ã—{config.duration}hÃ—Â¥0.50)
                          </span>
                          <span>Â¥{estimate.breakdown.cpu.toFixed(2)}</span>
                        </div>
                      )}
                      {estimate.breakdown.memory > 0 && (
                        <div className="flex justify-between">
                          <span>
                            â””â”€ å†…å­˜ ({config.memory}GBÃ—{config.duration}hÃ—Â¥0.10)
                          </span>
                          <span>Â¥{estimate.breakdown.memory.toFixed(2)}</span>
                        </div>
                      )}
                    </div>
                  )}
                </div>

                <Separator />

                {/* å°è®¡ */}
                <div className="flex justify-between">
                  <span className="text-slate-600">å°è®¡</span>
                  <span className="text-slate-900">
                    Â¥{estimate.originalPrice.toFixed(2)}
                  </span>
                </div>

                {/* æŠ˜æ‰£ */}
                {estimate.discountAmount > 0 && (
                  <>
                    <div className="flex justify-between text-sm">
                      <span className="text-slate-600">
                        æŠ˜æ‰£ï¼ˆ{currentUser.level}ä¼šå‘˜{estimate.discount * 100}æŠ˜ï¼‰
                      </span>
                      <span className="text-orange-600">
                        -Â¥{estimate.discountAmount.toFixed(2)}
                      </span>
                    </div>
                    <Separator />
                    <div className="flex justify-between">
                      <span className="text-slate-600">æŠ˜åä»·</span>
                      <span className="text-slate-900">
                        Â¥{estimate.priceAfterDiscount.toFixed(2)}
                      </span>
                    </div>
                  </>
                )}

                {/* ç®—åŠ›åˆ¸å¯æŠµ */}
                {estimate.maxVoucherDeduct > 0 ? (
                  <>
                    <div className="flex justify-between items-center bg-green-50 -mx-4 px-4 py-2 rounded">
                      <div className="flex items-center gap-2">
                        <Ticket className="w-4 h-4 text-green-600" />
                        <span className="text-green-700">ğŸ ç®—åŠ›åˆ¸å¯æŠµ</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-green-700">
                          Â¥{estimate.maxVoucherDeduct.toFixed(2)}
                        </span>
                        <Button
                          variant="link"
                          size="sm"
                          onClick={() => setShowVoucherDetail(true)}
                          className="text-green-600 h-auto p-0"
                        >
                          æŸ¥çœ‹åˆ¸è¯¦æƒ… â†’
                        </Button>
                      </div>
                    </div>
                    <Separator />
                  </>
                ) : (
                  <div className="text-sm text-slate-500 text-center py-2">
                    æš‚æ— å¯ç”¨ç®—åŠ›åˆ¸
                  </div>
                )}

                {/* é¢„ä¼°å®ä»˜ */}
                <div className="flex justify-between items-center bg-purple-50 -mx-4 px-4 py-3 rounded">
                  <span className="text-lg text-slate-900">é¢„ä¼°å®ä»˜</span>
                  <span className="text-2xl font-semibold text-purple-600">
                    Â¥{estimate.estimatedFinalAmount.toFixed(2)}
                  </span>
                </div>

                {/* æç¤º */}
                <Alert className="bg-blue-50 border-blue-200">
                  <Info className="w-4 h-4 text-blue-600" />
                  <AlertDescription className="text-xs text-slate-700">
                    ğŸ’¡ å®é™…é‡‘é¢ä»¥æ”¯ä»˜æ—¶ä¸ºå‡†ï¼Œåˆ¸ä½¿ç”¨æƒ…å†µå¯èƒ½ä¼šæœ‰å˜åŒ–
                  </AlertDescription>
                </Alert>
              </div>
            ) : (
              <div className="text-center py-8 text-slate-500">
                <AlertCircle className="w-8 h-8 mx-auto mb-2 text-slate-400" />
                <p>è¯·å®Œå–„èµ„æºé…ç½®ä»¥æŸ¥çœ‹è´¹ç”¨é¢„ä¼°</p>
              </div>
            )}
          </CardContent>
        </Card>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>
            å–æ¶ˆ
          </Button>
          <Button 
            onClick={handleCreateOrder}
            disabled={!estimate || loading}
          >
            ç¡®è®¤åˆ›å»ºè®¢å•
          </Button>
        </DialogFooter>
      </DialogContent>

      {/* åˆ¸è¯¦æƒ…å¯¹è¯æ¡† */}
      <VoucherDetailDialog
        open={showVoucherDetail}
        onOpenChange={setShowVoucherDetail}
        vouchers={estimate?.availableVouchers || []}
        orderAmount={estimate?.priceAfterDiscount || 0}
      />
    </Dialog>
  );
};

// åˆ¸è¯¦æƒ…å¯¹è¯æ¡†
const VoucherDetailDialog = ({ open, onOpenChange, vouchers, orderAmount }) => {
  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>å¯ç”¨ç®—åŠ›åˆ¸é¢„è§ˆ</DialogTitle>
          <DialogDescription>
            æ ¹æ®æ™ºèƒ½æ¨èï¼Œä»¥ä¸‹åˆ¸å¯ç”¨äºæŠµæ‰£æœ¬è®¢å•
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-3 max-h-96 overflow-y-auto">
          {vouchers.map((voucher, index) => (
            <Card key={voucher.id} className="border-2">
              <CardContent className="p-4">
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <Badge className="bg-purple-100 text-purple-700">
                        {voucher.voucherCode}
                      </Badge>
                      {voucher.daysToExpire <= 7 && (
                        <Badge className="bg-orange-100 text-orange-700">
                          {voucher.daysToExpire}å¤©ååˆ°æœŸ
                        </Badge>
                      )}
                    </div>
                    <p className="text-sm text-slate-600 mb-1">
                      {voucher.programName}
                    </p>
                    <p className="text-xs text-slate-500">
                      å‰©ä½™ Â¥{voucher.remainingAmount.toFixed(2)}
                    </p>
                  </div>
                  <div className="text-right">
                    <p className="text-sm text-slate-600 mb-1">å¯æŠµæ‰£</p>
                    <p className="text-lg font-semibold text-green-600">
                      Â¥{Math.min(voucher.remainingAmount, orderAmount).toFixed(2)}
                    </p>
                    {voucher.remainingAmount >= orderAmount ? (
                      <Badge className="bg-green-100 text-green-700 text-xs">
                        å¯å…¨é¢
                      </Badge>
                    ) : (
                      <Badge className="bg-yellow-100 text-yellow-700 text-xs">
                        éƒ¨åˆ†
                      </Badge>
                    )}
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>

        <Alert>
          <Info className="w-4 h-4" />
          <AlertDescription className="text-sm">
            ğŸ’¡ æ”¯ä»˜æ—¶å¯é€‰æ‹©å…·ä½“çš„åˆ¸ç»„åˆæ–¹å¼ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ™ºèƒ½æ¨èæœ€ä¼˜æ–¹æ¡ˆ
          </AlertDescription>
        </Alert>

        <DialogFooter>
          <Button onClick={() => onOpenChange(false)}>
            å…³é—­
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
};
```

#### APIæ”¹åŠ¨

**ä¿®æ”¹ç°æœ‰æ¥å£**

```typescript
// POST /api/pricing/estimate
// æ–°å¢è¿”å›å­—æ®µ

interface EstimateRequest {
  resourceType: string;        // èµ„æºç±»å‹
  config: any;                 // èµ„æºé…ç½®
  duration: number;            // æ—¶é•¿ï¼ˆå°æ—¶ï¼‰
  userLevel?: string;          // ç”¨æˆ·ç­‰çº§
}

interface EstimateResponse {
  originalPrice: number;       // åŸä»·
  breakdown: {                 // ä»·æ ¼æ˜ç»†
    gpu?: number;
    cpu?: number;
    memory?: number;
    storage?: number;
  };
  discount: number;            // æŠ˜æ‰£ç‡
  discountAmount: number;      // æŠ˜æ‰£é‡‘é¢
  finalPrice: number;          // æŠ˜åä»·
  maxVoucherDeduct: number;    // æœ€å¤§åˆ¸æŠµæ‰£ï¼ˆæ–°å¢ï¼‰
  availableVouchers: Voucher[]; // å¯ç”¨åˆ¸åˆ—è¡¨ï¼ˆæ–°å¢ï¼‰
}
```

**æ–°å¢æ¥å£**

```typescript
// POST /api/vouchers/calculateMaxDeduction
// è®¡ç®—æœ€å¤§åˆ¸æŠµæ‰£é‡‘é¢

interface MaxDeductionRequest {
  orderAmount: number;         // è®¢å•é‡‘é¢
  orderType?: string;          // è®¢å•ç±»å‹
  config?: any;                // èµ„æºé…ç½®ï¼ˆç”¨äºåŒ¹é…åˆ¸èŒƒå›´ï¼‰
}

interface MaxDeductionResponse {
  maxDeduction: number;        // æœ€å¤§æŠµæ‰£é‡‘é¢
  canFullDeduct: boolean;      // æ˜¯å¦å¯å…¨é¢æŠµæ‰£
  vouchers: Array<{            // å¯ç”¨åˆ¸åˆ—è¡¨
    id: string;
    voucherCode: string;
    programName: string;
    remainingAmount: number;
    daysToExpire: number;
    canDeductAmount: number;   // æœ¬åˆ¸å¯æŠµé‡‘é¢
  }>;
  reason: string;              // è¯´æ˜
}
```

**åç«¯é€»è¾‘å˜åŒ–**

```typescript
// pricingService.ts

class PricingService {
  async estimate(request: EstimateRequest): Promise<EstimateResponse> {
    // 1. è®¡ç®—åŸä»·å’Œæ˜ç»†
    const { originalPrice, breakdown } = this.calculateBasePrice(request);
    
    // 2. åº”ç”¨æŠ˜æ‰£
    const discount = this.getDiscount(request.userLevel);
    const discountAmount = originalPrice * (1 - discount);
    const finalPrice = originalPrice - discountAmount;
    
    // 3. è®¡ç®—åˆ¸æŠµæ‰£ï¼ˆæ–°å¢ï¼‰
    const voucherResult = await voucherService.calculateMaxDeduction({
      orderAmount: finalPrice,
      orderType: request.resourceType,
      config: request.config
    });
    
    return {
      originalPrice,
      breakdown,
      discount,
      discountAmount,
      finalPrice,
      maxVoucherDeduct: voucherResult.maxDeduction,
      availableVouchers: voucherResult.vouchers
    };
  }

  private calculateBasePrice(request: EstimateRequest) {
    const breakdown: any = {};
    let total = 0;
    
    // GPUä»·æ ¼
    if (request.config.gpuType && request.config.gpuCount) {
      const gpuPrice = this.getGpuPrice(request.config.gpuType);
      breakdown.gpu = gpuPrice * request.config.gpuCount * request.duration;
      total += breakdown.gpu;
    }
    
    // CPUä»·æ ¼
    if (request.config.cpuCores) {
      breakdown.cpu = 0.5 * request.config.cpuCores * request.duration;
      total += breakdown.cpu;
    }
    
    // å†…å­˜ä»·æ ¼
    if (request.config.memory) {
      breakdown.memory = 0.1 * request.config.memory * request.duration;
      total += breakdown.memory;
    }
    
    return { originalPrice: total, breakdown };
  }

  private getDiscount(userLevel?: string): number {
    const discounts = {
      bronze: 1.0,
      silver: 0.95,
      gold: 0.9,
      platinum: 0.85
    };
    return discounts[userLevel as keyof typeof discounts] || 1.0;
  }

  private getGpuPrice(gpuType: string): number {
    const prices = {
      'A100': 15.0,
      'V100': 12.0,
      'T4': 8.0,
      'A10': 10.0
    };
    return prices[gpuType as keyof typeof prices] || 15.0;
  }
}

// voucherService.ts

class VoucherService {
  async calculateMaxDeduction(
    request: MaxDeductionRequest
  ): Promise<MaxDeductionResponse> {
    // 1. è·å–å¯ç”¨åˆ¸
    const vouchers = await this.getAvailableVouchers(
      request.orderType,
      request.config
    );
    
    // 2. è¿‡æ»¤é€‚ç”¨åˆ¸
    const applicable = vouchers.filter(v => 
      this.isApplicable(v, request.orderType, request.config)
    );
    
    // 3. è®¡ç®—æ¯å¼ åˆ¸å¯æŠµé‡‘é¢
    const withDeduction = applicable.map(v => ({
      ...v,
      canDeductAmount: Math.min(v.remainingAmount, request.orderAmount)
    }));
    
    // 4. è®¡ç®—æ€»æŠµæ‰£
    const maxDeduction = withDeduction.reduce(
      (sum, v) => sum + v.canDeductAmount,
      0
    );
    
    // 5. åˆ¤æ–­æ˜¯å¦å¯å…¨é¢æŠµæ‰£
    const canFullDeduct = maxDeduction >= request.orderAmount;
    
    return {
      maxDeduction: Math.min(maxDeduction, request.orderAmount),
      canFullDeduct,
      vouchers: withDeduction,
      reason: this.generateDeductionReason(
        withDeduction,
        maxDeduction,
        request.orderAmount
      )
    };
  }

  private isApplicable(
    voucher: Voucher,
    orderType?: string,
    config?: any
  ): boolean {
    // æ£€æŸ¥çŠ¶æ€
    if (voucher.status !== 'active') return false;
    
    // æ£€æŸ¥æœ‰æ•ˆæœŸ
    if (new Date(voucher.endDate) < new Date()) return false;
    
    // æ£€æŸ¥ä½™é¢
    if (voucher.remainingAmount <= 0) return false;
    
    // æ£€æŸ¥é€‚ç”¨èŒƒå›´
    if (orderType && voucher.applicableScopes.length > 0) {
      const isApplicable = voucher.applicableScopes.some(scope => 
        this.matchScope(scope, orderType, config)
      );
      if (!isApplicable) return false;
    }
    
    return true;
  }

  private matchScope(
    scope: string,
    orderType: string,
    config: any
  ): boolean {
    // åŒ¹é…é€»è¾‘
    // ä¾‹å¦‚ï¼šscope="AIè®­ç»ƒ", orderType="gpu-instance" â†’ true
    // ä¾‹å¦‚ï¼šscope="å­˜å‚¨", orderType="storage" â†’ true
    const mapping = {
      'AIè®­ç»ƒ': ['gpu-instance', 'training'],
      'æ¨¡å‹æ¨ç†': ['inference'],
      'æ•°æ®å¤„ç†': ['cpu-instance'],
      'å­˜å‚¨': ['storage']
    };
    
    const types = mapping[scope as keyof typeof mapping] || [];
    return types.includes(orderType);
  }

  private generateDeductionReason(
    vouchers: any[],
    maxDeduction: number,
    orderAmount: number
  ): string {
    if (vouchers.length === 0) {
      return 'æš‚æ— å¯ç”¨ç®—åŠ›åˆ¸';
    }
    
    if (maxDeduction >= orderAmount) {
      return `å¯ç”¨ ${vouchers.length} å¼ åˆ¸å®ç°å…¨é¢æŠµæ‰£`;
    }
    
    return `å¯ç”¨ ${vouchers.length} å¼ åˆ¸ï¼Œæœ€å¤šæŠµæ‰£ Â¥${maxDeduction.toFixed(2)}`;
  }
}
```

---

### ä¼˜åŒ–3ï¼šä½™é¢ + ç®—åŠ›åˆ¸è‡ªåŠ¨æ··åˆæ”¯ä»˜

#### åŠŸèƒ½æ–‡æ¡£

**éœ€æ±‚æè¿°**
- æ”¯ä»˜æ—¶è‡ªåŠ¨ç»„åˆç®—åŠ›åˆ¸ + è´¦æˆ·ä½™é¢
- ä¼˜å…ˆä½¿ç”¨ç®—åŠ›åˆ¸æŠµæ‰£ï¼Œä½™é¢è‡ªåŠ¨è¡¥è¶³å·®é¢
- æ”¯æŒå®Œå…¨æŠµæ‰£æç¤ºï¼ˆåˆ¸+ä½™é¢ = è®¢å•é‡‘é¢ï¼‰

**ä¸šåŠ¡ä»·å€¼**
- âœ… æ¶ˆé™¤"åˆ¸ä¸å¤Ÿéœ€æ‰‹åŠ¨å……å€¼"çš„ç—›ç‚¹
- âœ… ç®€åŒ–æ”¯ä»˜æµç¨‹ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- âœ… ç¬¦åˆåŸæœ‰è´¦æˆ·ç®¡ç†é€»è¾‘

**ä¸šåŠ¡è§„åˆ™**
```typescript
æ··åˆæ”¯ä»˜è§„åˆ™ï¼š
1. æ”¯ä»˜ä¼˜å…ˆçº§ï¼šç®—åŠ›åˆ¸ > è´¦æˆ·ä½™é¢ > ç¬¬ä¸‰æ–¹æ”¯ä»˜
2. è‡ªåŠ¨è®¡ç®—ï¼š
   - åˆ¸æŠµæ‰£é‡‘é¢ = min(åˆ¸æ€»é¢, è®¢å•é‡‘é¢)
   - ä½™é¢ä½¿ç”¨ = min(ä½™é¢, è®¢å•é‡‘é¢ - åˆ¸æŠµæ‰£)
   - ç¬¬ä¸‰æ–¹æ”¯ä»˜ = è®¢å•é‡‘é¢ - åˆ¸æŠµæ‰£ - ä½™é¢ä½¿ç”¨
3. å®Œå…¨æŠµæ‰£ï¼šåˆ¸ + ä½™é¢ >= è®¢å•é‡‘é¢æ—¶ï¼Œæ˜¾ç¤º"å®ä»˜ Â¥0"
4. éƒ¨åˆ†æŠµæ‰£ï¼šæç¤ºéœ€è¡¥å……çš„é‡‘é¢

è¾¹ç•Œæ¡ä»¶ï¼š
- åˆ¸/ä½™é¢ä¸è¶³æ—¶ï¼Œæ˜¾ç¤ºç¬¬ä¸‰æ–¹æ”¯ä»˜é€‰é¡¹
- åˆ¸è¿‡æœŸ/å†»ç»“æ—¶è‡ªåŠ¨æ’é™¤
- ä½™é¢å†»ç»“éƒ¨åˆ†ä¸å¯ç”¨
```

**ä¾èµ–å…³ç³»**
- ä¾èµ–ï¼šåŸæœ‰ Account èšåˆæ ¹
- ä¾èµ–ï¼šåŸæœ‰ Voucher èšåˆæ ¹
- ä¾èµ–ï¼šåŸæœ‰ SettlementService
- å½±å“ï¼šæ”¯ä»˜æµç¨‹ã€èµ„é‡‘æµè½¬

#### äº¤äº’è®¾è®¡

**UI/UXæµç¨‹**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ··åˆæ”¯ä»˜å¯¹è¯æ¡†ï¼ˆPaymentDialogï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  è®¢å•é‡‘é¢ï¼šÂ¥1,280.00                                     â”‚
â”‚                                                          â”‚
â”‚  ğŸ’° æ”¯ä»˜æ–¹å¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ âœ… æ™ºèƒ½æ··åˆæ”¯ä»˜ï¼ˆæ¨èï¼‰                             â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚ æ”¯ä»˜æ˜ç»†ï¼š                                          â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚ â”‚ ç®—åŠ›åˆ¸æŠµæ‰£                                   â”‚   â”‚ â”‚
â”‚  â”‚ â”‚ GOV-2024-AI-001      Â¥500.00               â”‚   â”‚ â”‚
â”‚  â”‚ â”‚ GOV-2024-EDU-023     Â¥280.00               â”‚   â”‚ â”‚
â”‚  â”‚ â”‚                              â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚   â”‚ â”‚
â”‚  â”‚ â”‚ å°è®¡                         Â¥780.00       â”‚   â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚ â”‚ è´¦æˆ·ä½™é¢æŠµæ‰£                                 â”‚   â”‚ â”‚
â”‚  â”‚ â”‚ å½“å‰ä½™é¢ Â¥50,000.00                          â”‚   â”‚ â”‚
â”‚  â”‚ â”‚ æœ¬æ¬¡ä½¿ç”¨             Â¥500.00               â”‚   â”‚ â”‚
â”‚  â”‚ â”‚ ä½¿ç”¨åä½™é¢           Â¥49,500.00            â”‚   â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚ â”‚ åˆè®¡æŠµæ‰£             Â¥1,280.00             â”‚   â”‚ â”‚
â”‚  â”‚ â”‚ âœ“ å·²å®Œå…¨æŠµæ‰£ï¼Œæ— éœ€é¢å¤–æ”¯ä»˜                  â”‚   â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  å®ä»˜é‡‘é¢ï¼šÂ¥0.00                                         â”‚
â”‚                                                          â”‚
â”‚  [å–æ¶ˆ]                      [ç¡®è®¤æ”¯ä»˜]                  â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åœºæ™¯2ï¼šåˆ¸+ä½™é¢ä¸è¶³
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¢å•é‡‘é¢ï¼šÂ¥5,280.00                                     â”‚
â”‚                                                          â”‚
â”‚  ğŸ’° æ”¯ä»˜æ–¹å¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ âœ… æ™ºèƒ½æ··åˆæ”¯ä»˜                                      â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚ ç®—åŠ›åˆ¸æŠµæ‰£ï¼š            Â¥1,000.00                  â”‚ â”‚
â”‚  â”‚ è´¦æˆ·ä½™é¢ï¼š              Â¥2,000.00                  â”‚ â”‚
â”‚  â”‚                        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚ â”‚
â”‚  â”‚ å·²æŠµæ‰£ï¼š                Â¥3,000.00                  â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚ âš ï¸ è¿˜éœ€æ”¯ä»˜ï¼š            Â¥2,280.00                 â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚ è¯·é€‰æ‹©è¡¥å……æ”¯ä»˜æ–¹å¼ï¼š                                â”‚ â”‚
â”‚  â”‚ â—‹ æ”¯ä»˜å®                                           â”‚ â”‚
â”‚  â”‚ â—‹ å¾®ä¿¡æ”¯ä»˜                                         â”‚ â”‚
â”‚  â”‚ â—‹ é“¶è¡Œå¡                                           â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚ [ä¸€é”®å……å€¼ Â¥2,280.00]                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  å®ä»˜é‡‘é¢ï¼šÂ¥2,280.00                                     â”‚
â”‚                                                          â”‚
â”‚  [å–æ¶ˆ]                      [ç¡®è®¤æ”¯ä»˜]                  â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ··åˆæ”¯ä»˜æµç¨‹**

```
[ç”¨æˆ·ç‚¹å‡»æ”¯ä»˜]
        â†“
[æ‰“å¼€æ”¯ä»˜å¯¹è¯æ¡†]
        â†“
[è‡ªåŠ¨è®¡ç®—æ··åˆæ–¹æ¡ˆ]
        â”‚
        â”œâ”€â†’ [1. è®¡ç®—åˆ¸æŠµæ‰£]
        â”‚      â”œâ”€ è·å–å¯ç”¨åˆ¸
        â”‚      â”œâ”€ æ™ºèƒ½æ¨èç»„åˆ
        â”‚      â””â”€ è®¡ç®—æ€»æŠµæ‰£
        â”‚
        â”œâ”€â†’ [2. è®¡ç®—ä½™é¢æŠµæ‰£]
        â”‚      â”œâ”€ è·å–è´¦æˆ·ä½™é¢
        â”‚      â”œâ”€ è®¡ç®—å‰©ä½™é‡‘é¢
        â”‚      â””â”€ ç¡®å®šä½¿ç”¨é‡‘é¢
        â”‚
        â””â”€â†’ [3. è®¡ç®—å‰©ä½™]
               â”œâ”€ è®¢å•é‡‘é¢ - åˆ¸ - ä½™é¢
               â””â”€ åˆ¤æ–­æ˜¯å¦éœ€è¦ç¬¬ä¸‰æ–¹æ”¯ä»˜
        â†“
[æ˜¾ç¤ºæ”¯ä»˜æ˜ç»†]
        â”‚
        â”œâ”€â†’ [å®Œå…¨æŠµæ‰£] â†’ æ˜¾ç¤º"å®ä»˜Â¥0"
        â”‚
        â””â”€â†’ [éƒ¨åˆ†æŠµæ‰£] â†’ æ˜¾ç¤ºç¬¬ä¸‰æ–¹æ”¯ä»˜é€‰é¡¹
        â†“
[ç”¨æˆ·ç¡®è®¤]
        â†“
[æ‰§è¡Œæ”¯ä»˜]
        â”‚
        â”œâ”€â†’ [1. æ‰£å‡åˆ¸é¢åº¦]
        â”œâ”€â†’ [2. æ‰£å‡è´¦æˆ·ä½™é¢]
        â””â”€â†’ [3. è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜]ï¼ˆå¦‚éœ€è¦ï¼‰
        â†“
[æ›´æ–°è®¢å•çŠ¶æ€]
        â†“
[ç”Ÿæˆæ”¯ä»˜è®°å½•]
        â†“
[é€šçŸ¥ç”¨æˆ·]
```

**ä¼ªä»£ç å®ç°**

```typescript
// PaymentDialog.tsx

interface MixedPaymentResult {
  voucherDeduction: number;    // åˆ¸æŠµæ‰£
  balanceDeduction: number;    // ä½™é¢æŠµæ‰£
  thirdPartyAmount: number;    // ç¬¬ä¸‰æ–¹æ”¯ä»˜
  canFullDeduct: boolean;      // æ˜¯å¦å®Œå…¨æŠµæ‰£
  selectedVouchers: Voucher[]; // é€‰ä¸­çš„åˆ¸
}

const PaymentDialog = ({ orderId, orderAmount, onSuccess }) => {
  const [paymentPlan, setPaymentPlan] = useState<MixedPaymentResult | null>(null);
  const [accountBalance, setAccountBalance] = useState(0);
  const [selectedPaymentMethod, setSelectedPaymentMethod] = useState<string>('');
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    calculateMixedPayment();
  }, [orderAmount]);

  // è®¡ç®—æ··åˆæ”¯ä»˜æ–¹æ¡ˆ
  const calculateMixedPayment = async () => {
    setLoading(true);
    try {
      // 1. è·å–è´¦æˆ·ä¿¡æ¯
      const account = await accountService.getAccountInfo();
      setAccountBalance(account.availableBalance);

      // 2. è·å–æ™ºèƒ½æ¨èåˆ¸
      const voucherResult = await voucherService.getRecommendedVouchers(
        orderAmount,
        'auto' // è‡ªåŠ¨ç±»å‹åŒ¹é…
      );

      // 3. è®¡ç®—åˆ¸æŠµæ‰£
      const voucherDeduction = Math.min(
        voucherResult.totalDeduction,
        orderAmount
      );

      // 4. è®¡ç®—ä½™é¢æŠµæ‰£
      const remaining = orderAmount - voucherDeduction;
      const balanceDeduction = Math.min(
        account.availableBalance,
        remaining
      );

      // 5. è®¡ç®—ç¬¬ä¸‰æ–¹æ”¯ä»˜
      const thirdPartyAmount = orderAmount - voucherDeduction - balanceDeduction;

      setPaymentPlan({
        voucherDeduction,
        balanceDeduction,
        thirdPartyAmount,
        canFullDeduct: thirdPartyAmount === 0,
        selectedVouchers: voucherResult.vouchers
      });
    } catch (error) {
      toast.error('è®¡ç®—å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setLoading(false);
    }
  };

  // ç¡®è®¤æ··åˆæ”¯ä»˜
  const handleConfirmPay = async () => {
    if (!paymentPlan) return;

    setLoading(true);
    try {
      // å®Œå…¨æŠµæ‰£æˆ–éƒ¨åˆ†æŠµæ‰£
      if (paymentPlan.canFullDeduct) {
        // æ— éœ€ç¬¬ä¸‰æ–¹æ”¯ä»˜
        await paymentService.payWithMix({
          orderId,
          vouchers: paymentPlan.selectedVouchers.map(v => ({
            voucherId: v.id,
            useAmount: v.useAmount
          })),
          useBalance: paymentPlan.balanceDeduction
        });

        toast.success('æ”¯ä»˜æˆåŠŸï¼');
        onSuccess?.();
      } else {
        // éœ€è¦ç¬¬ä¸‰æ–¹æ”¯ä»˜
        if (!selectedPaymentMethod) {
          toast.error('è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼');
          return;
        }

        // å…ˆä½¿ç”¨åˆ¸å’Œä½™é¢
        const mixResult = await paymentService.payWithMix({
          orderId,
          vouchers: paymentPlan.selectedVouchers.map(v => ({
            voucherId: v.id,
            useAmount: v.useAmount
          })),
          useBalance: paymentPlan.balanceDeduction
        });

        // å†è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜
        const thirdPartyResult = await paymentService.createThirdPartyOrder({
          orderId,
          amount: paymentPlan.thirdPartyAmount,
          method: selectedPaymentMethod
        });

        // è·³è½¬æ”¯ä»˜
        window.location.href = thirdPartyResult.paymentUrl;
      }
    } catch (error) {
      toast.error('æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setLoading(false);
    }
  };

  // ä¸€é”®å……å€¼
  const handleQuickRecharge = () => {
    if (!paymentPlan) return;
    
    // è·³è½¬å……å€¼é¡µï¼Œé¢„å¡«å……å€¼é‡‘é¢
    navigate('/account-balance', {
      state: {
        suggestedAmount: paymentPlan.thirdPartyAmount,
        returnToOrder: orderId
      }
    });
  };

  return (
    <Dialog open onOpenChange={onClose}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>ç¡®è®¤æ”¯ä»˜</DialogTitle>
        </DialogHeader>

        {/* è®¢å•é‡‘é¢ */}
        <div className="mb-4">
          <p className="text-slate-600">è®¢å•é‡‘é¢</p>
          <p className="text-2xl text-slate-900">
            Â¥{orderAmount.toFixed(2)}
          </p>
        </div>

        {paymentPlan && (
          <>
            {/* æ”¯ä»˜æ–¹å¼ */}
            <div className="space-y-4">
              <Label>ğŸ’° æ”¯ä»˜æ–¹å¼</Label>
              
              <Card className="border-2 border-purple-200 bg-purple-50/50">
                <CardContent className="p-4">
                  <div className="flex items-center gap-2 mb-4">
                    <CheckCircle className="w-5 h-5 text-purple-600" />
                    <span className="font-semibold text-purple-900">
                      æ™ºèƒ½æ··åˆæ”¯ä»˜ï¼ˆæ¨èï¼‰
                    </span>
                  </div>

                  <div className="space-y-4">
                    {/* åˆ¸æŠµæ‰£æ˜ç»† */}
                    {paymentPlan.voucherDeduction > 0 && (
                      <div className="bg-white rounded-lg p-3 space-y-2">
                        <p className="text-sm text-slate-700 font-medium">
                          ç®—åŠ›åˆ¸æŠµæ‰£
                        </p>
                        {paymentPlan.selectedVouchers.map(v => (
                          <div key={v.id} className="flex justify-between text-sm">
                            <span className="text-slate-600">{v.voucherCode}</span>
                            <span className="text-purple-600">
                              Â¥{v.useAmount.toFixed(2)}
                            </span>
                          </div>
                        ))}
                        <Separator />
                        <div className="flex justify-between font-medium">
                          <span>å°è®¡</span>
                          <span className="text-purple-600">
                            Â¥{paymentPlan.voucherDeduction.toFixed(2)}
                          </span>
                        </div>
                      </div>
                    )}

                    {/* ä½™é¢æŠµæ‰£æ˜ç»† */}
                    {paymentPlan.balanceDeduction > 0 && (
                      <div className="bg-white rounded-lg p-3 space-y-2">
                        <p className="text-sm text-slate-700 font-medium">
                          è´¦æˆ·ä½™é¢æŠµæ‰£
                        </p>
                        <div className="text-sm space-y-1">
                          <div className="flex justify-between">
                            <span className="text-slate-600">å½“å‰ä½™é¢</span>
                            <span className="text-blue-600">
                              Â¥{accountBalance.toFixed(2)}
                            </span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-slate-600">æœ¬æ¬¡ä½¿ç”¨</span>
                            <span className="text-blue-600">
                              Â¥{paymentPlan.balanceDeduction.toFixed(2)}
                            </span>
                          </div>
                          <div className="flex justify-between text-xs text-slate-500">
                            <span>ä½¿ç”¨åä½™é¢</span>
                            <span>
                              Â¥{(accountBalance - paymentPlan.balanceDeduction).toFixed(2)}
                            </span>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* åˆè®¡æŠµæ‰£ */}
                    <div className="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-3">
                      <div className="flex justify-between items-center">
                        <span className="font-medium">åˆè®¡æŠµæ‰£</span>
                        <span className="text-xl font-semibold text-green-600">
                          Â¥{(paymentPlan.voucherDeduction + paymentPlan.balanceDeduction).toFixed(2)}
                        </span>
                      </div>
                      {paymentPlan.canFullDeduct && (
                        <p className="text-sm text-green-700 mt-2">
                          âœ“ å·²å®Œå…¨æŠµæ‰£ï¼Œæ— éœ€é¢å¤–æ”¯ä»˜
                        </p>
                      )}
                    </div>

                    {/* ç¬¬ä¸‰æ–¹æ”¯ä»˜ */}
                    {!paymentPlan.canFullDeduct && (
                      <div className="bg-orange-50 rounded-lg p-3 space-y-3">
                        <div className="flex justify-between items-center">
                          <span className="font-medium text-orange-900">
                            âš ï¸ è¿˜éœ€æ”¯ä»˜
                          </span>
                          <span className="text-xl font-semibold text-orange-600">
                            Â¥{paymentPlan.thirdPartyAmount.toFixed(2)}
                          </span>
                        </div>

                        <div className="space-y-2">
                          <Label className="text-sm">è¯·é€‰æ‹©è¡¥å……æ”¯ä»˜æ–¹å¼ï¼š</Label>
                          <RadioGroup
                            value={selectedPaymentMethod}
                            onValueChange={setSelectedPaymentMethod}
                          >
                            <div className="flex items-center space-x-2">
                              <RadioGroupItem value="alipay" id="alipay" />
                              <Label htmlFor="alipay" className="flex items-center gap-2">
                                <img src="/icons/alipay.svg" className="w-5 h-5" />
                                æ”¯ä»˜å®
                              </Label>
                            </div>
                            <div className="flex items-center space-x-2">
                              <RadioGroupItem value="wechat" id="wechat" />
                              <Label htmlFor="wechat" className="flex items-center gap-2">
                                <img src="/icons/wechat.svg" className="w-5 h-5" />
                                å¾®ä¿¡æ”¯ä»˜
                              </Label>
                            </div>
                            <div className="flex items-center space-x-2">
                              <RadioGroupItem value="bank" id="bank" />
                              <Label htmlFor="bank" className="flex items-center gap-2">
                                <CreditCard className="w-5 h-5" />
                                é“¶è¡Œå¡
                              </Label>
                            </div>
                          </RadioGroup>
                        </div>

                        <Button
                          variant="outline"
                          className="w-full"
                          onClick={handleQuickRecharge}
                        >
                          <Wallet className="w-4 h-4 mr-2" />
                          ä¸€é”®å……å€¼ Â¥{paymentPlan.thirdPartyAmount.toFixed(2)}
                        </Button>
                      </div>
                    )}
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* å®ä»˜é‡‘é¢ */}
            <div className="border-t pt-4">
              <div className="flex justify-between items-center">
                <span className="text-lg">å®ä»˜é‡‘é¢</span>
                <span className={`text-2xl font-semibold ${
                  paymentPlan.canFullDeduct ? 'text-green-600' : 'text-slate-900'
                }`}>
                  Â¥{paymentPlan.thirdPartyAmount.toFixed(2)}
                </span>
              </div>
            </div>
          </>
        )}

        <DialogFooter>
          <Button variant="outline" onClick={onClose} disabled={loading}>
            å–æ¶ˆ
          </Button>
          <Button
            onClick={handleConfirmPay}
            disabled={loading || (!paymentPlan?.canFullDeduct && !selectedPaymentMethod)}
          >
            {loading && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
            ç¡®è®¤æ”¯ä»˜
            {paymentPlan && !paymentPlan.canFullDeduct && 
              ` Â¥${paymentPlan.thirdPartyAmount.toFixed(2)}`
            }
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
};
```

#### APIæ”¹åŠ¨

**æ–°å¢æ¥å£**

```typescript
// POST /api/payment/mixCalculate
// é¢„è®¡ç®—æ··åˆæ”¯ä»˜æ–¹æ¡ˆ

interface MixCalculateRequest {
  orderAmount: number;         // è®¢å•é‡‘é¢
  orderType?: string;          // è®¢å•ç±»å‹
}

interface MixCalculateResponse {
  voucherDeduction: number;    // åˆ¸æŠµæ‰£
  balanceDeduction: number;    // ä½™é¢æŠµæ‰£
  thirdPartyAmount: number;    // ç¬¬ä¸‰æ–¹æ”¯ä»˜
  canFullDeduct: boolean;      // æ˜¯å¦å®Œå…¨æŠµæ‰£
  vouchers: Array<{            // æ¨èåˆ¸åˆ—è¡¨
    voucherId: string;
    useAmount: number;
  }>;
  accountBalance: number;      // å½“å‰ä½™é¢
}

// POST /api/payment/payWithMix
// æ‰§è¡Œæ··åˆæ”¯ä»˜

interface PayWithMixRequest {
  orderId: string;             // è®¢å•ID
  vouchers: Array<{            // ä½¿ç”¨çš„åˆ¸
    voucherId: string;
    useAmount: number;
  }>;
  useBalance: number;          // ä½¿ç”¨çš„ä½™é¢
}

interface PayWithMixResponse {
  success: boolean;
  paymentId: string;           // æ”¯ä»˜ID
  voucherDeducted: number;     // åˆ¸å®é™…æŠµæ‰£
  balanceDeducted: number;     // ä½™é¢å®é™…æŠµæ‰£
  remainingAmount: number;     // å‰©ä½™éœ€æ”¯ä»˜
  message: string;
}
```

**åç«¯é€»è¾‘å˜åŒ–**

```typescript
// paymentService.ts

class PaymentService {
  /**
   * è®¡ç®—æ··åˆæ”¯ä»˜æ–¹æ¡ˆ
   */
  async calculateMixPayment(
    orderAmount: number,
    userId: string,
    orderType?: string
  ): Promise<MixCalculateResponse> {
    // 1. è·å–è´¦æˆ·ä¿¡æ¯
    const account = await accountService.getAccountInfo(userId);
    
    // 2. è·å–æ¨èåˆ¸
    const voucherResult = await voucherService.getRecommendedVouchers(
      orderAmount,
      orderType
    );
    
    // 3. è®¡ç®—åˆ¸æŠµæ‰£
    const voucherDeduction = Math.min(
      voucherResult.totalDeduction,
      orderAmount
    );
    
    // 4. è®¡ç®—ä½™é¢æŠµæ‰£
    const remaining = orderAmount - voucherDeduction;
    const balanceDeduction = Math.min(
      account.availableBalance,
      Math.max(0, remaining)
    );
    
    // 5. è®¡ç®—ç¬¬ä¸‰æ–¹æ”¯ä»˜
    const thirdPartyAmount = Math.max(
      0,
      orderAmount - voucherDeduction - balanceDeduction
    );
    
    return {
      voucherDeduction,
      balanceDeduction,
      thirdPartyAmount,
      canFullDeduct: thirdPartyAmount === 0,
      vouchers: voucherResult.vouchers.map(v => ({
        voucherId: v.id,
        useAmount: v.useAmount
      })),
      accountBalance: account.availableBalance
    };
  }

  /**
   * æ‰§è¡Œæ··åˆæ”¯ä»˜
   */
  async payWithMix(
    request: PayWithMixRequest
  ): Promise<PayWithMixResponse> {
    // å¼€å¯äº‹åŠ¡
    return await this.transaction(async (trx) => {
      let totalDeducted = 0;
      
      // 1. æ‰£å‡åˆ¸é¢åº¦
      let voucherDeducted = 0;
      for (const v of request.vouchers) {
        const result = await voucherService.deduct(
          v.voucherId,
          v.useAmount,
          request.orderId,
          trx
        );
        voucherDeducted += result.deductedAmount;
        totalDeducted += result.deductedAmount;
      }
      
      // 2. æ‰£å‡è´¦æˆ·ä½™é¢
      let balanceDeducted = 0;
      if (request.useBalance > 0) {
        const result = await accountService.deduct(
          request.userId,
          request.useBalance,
          request.orderId,
          'è®¢å•æ”¯ä»˜',
          trx
        );
        balanceDeducted = result.deductedAmount;
        totalDeducted += result.deductedAmount;
      }
      
      // 3. è·å–è®¢å•ä¿¡æ¯
      const order = await orderService.getOrder(request.orderId, trx);
      const remainingAmount = order.totalAmount - totalDeducted;
      
      // 4. æ›´æ–°è®¢å•çŠ¶æ€
      if (remainingAmount <= 0) {
        // å®Œå…¨æ”¯ä»˜
        await orderService.updateStatus(
          request.orderId,
          'paid',
          trx
        );
      } else {
        // éƒ¨åˆ†æ”¯ä»˜
        await orderService.updatePartialPayment(
          request.orderId,
          totalDeducted,
          trx
        );
      }
      
      // 5. ç”Ÿæˆæ”¯ä»˜è®°å½•
      const paymentId = await this.createPaymentRecord({
        orderId: request.orderId,
        voucherAmount: voucherDeducted,
        balanceAmount: balanceDeducted,
        totalAmount: totalDeducted,
        remainingAmount
      }, trx);
      
      return {
        success: true,
        paymentId,
        voucherDeducted,
        balanceDeducted,
        remainingAmount,
        message: remainingAmount === 0 
          ? 'æ”¯ä»˜æˆåŠŸ' 
          : `å·²æŠµæ‰£ Â¥${totalDeducted.toFixed(2)}ï¼Œè¿˜éœ€æ”¯ä»˜ Â¥${remainingAmount.toFixed(2)}`
      };
    });
  }

  private async transaction<T>(
    callback: (trx: Transaction) => Promise<T>
  ): Promise<T> {
    const trx = await db.transaction();
    try {
      const result = await callback(trx);
      await trx.commit();
      return result;
    } catch (error) {
      await trx.rollback();
      throw error;
    }
  }

  private async createPaymentRecord(
    data: any,
    trx: Transaction
  ): Promise<string> {
    const paymentId = `pay-${Date.now()}`;
    await trx('payments').insert({
      id: paymentId,
      orderId: data.orderId,
      voucherAmount: data.voucherAmount,
      balanceAmount: data.balanceAmount,
      totalAmount: data.totalAmount,
      remainingAmount: data.remainingAmount,
      status: data.remainingAmount === 0 ? 'completed' : 'partial',
      createdAt: new Date()
    });
    return paymentId;
  }
}

// voucherService.ts

class VoucherService {
  /**
   * æ‰£å‡åˆ¸é¢åº¦
   */
  async deduct(
    voucherId: string,
    amount: number,
    orderId: string,
    trx: Transaction
  ): Promise<{ deductedAmount: number }> {
    // 1. é”å®šåˆ¸è®°å½•
    const voucher = await trx('vouchers')
      .where({ id: voucherId })
      .forUpdate()
      .first();
    
    if (!voucher) {
      throw new Error('åˆ¸ä¸å­˜åœ¨');
    }
    
    if (voucher.status !== 'active') {
      throw new Error('åˆ¸ä¸å¯ç”¨');
    }
    
    if (voucher.remainingAmount < amount) {
      throw new Error('åˆ¸ä½™é¢ä¸è¶³');
    }
    
    // 2. æ‰£å‡ä½™é¢
    const deductedAmount = Math.min(amount, voucher.remainingAmount);
    const newRemaining = voucher.remainingAmount - deductedAmount;
    const newUsed = voucher.usedAmount + deductedAmount;
    
    await trx('vouchers')
      .where({ id: voucherId })
      .update({
        remainingAmount: newRemaining,
        usedAmount: newUsed,
        status: newRemaining === 0 ? 'used' : 'active',
        updatedAt: new Date()
      });
    
    // 3. è®°å½•ä½¿ç”¨æ˜ç»†
    await trx('voucher_usage').insert({
      id: `usage-${Date.now()}-${Math.random()}`,
      voucherId,
      orderId,
      amount: deductedAmount,
      beforeAmount: voucher.remainingAmount,
      afterAmount: newRemaining,
      createdAt: new Date()
    });
    
    return { deductedAmount };
  }
}

// accountService.ts

class AccountService {
  /**
   * æ‰£å‡è´¦æˆ·ä½™é¢
   */
  async deduct(
    userId: string,
    amount: number,
    orderId: string,
    description: string,
    trx: Transaction
  ): Promise<{ deductedAmount: number }> {
    // 1. é”å®šè´¦æˆ·è®°å½•
    const account = await trx('accounts')
      .where({ userId })
      .forUpdate()
      .first();
    
    if (!account) {
      throw new Error('è´¦æˆ·ä¸å­˜åœ¨');
    }
    
    const availableBalance = account.balance - account.frozenAmount;
    
    if (availableBalance < amount) {
      throw new Error('ä½™é¢ä¸è¶³');
    }
    
    // 2. æ‰£å‡ä½™é¢
    const deductedAmount = Math.min(amount, availableBalance);
    const newBalance = account.balance - deductedAmount;
    const newConsumption = account.totalConsumption + deductedAmount;
    
    await trx('accounts')
      .where({ userId })
      .update({
        balance: newBalance,
        totalConsumption: newConsumption,
        updatedAt: new Date()
      });
    
    // 3. è®°å½•æµæ°´
    await trx('account_transactions').insert({
      id: `txn-${Date.now()}-${Math.random()}`,
      userId,
      type: 'deduct',
      amount: deductedAmount,
      beforeBalance: account.balance,
      afterBalance: newBalance,
      orderId,
      description,
      createdAt: new Date()
    });
    
    return { deductedAmount };
  }
}
```

---

### ä¼˜åŒ–4ï¼šåˆ¸å¿«åˆ°æœŸ/ä½™é¢ä¸è¶³ 7å¤©å†…è‡ªåŠ¨ç½®é¡¶ + æ©™è‰²é«˜äº® + å¼¹çª—æé†’

#### åŠŸèƒ½æ–‡æ¡£

**éœ€æ±‚æè¿°**
- åˆ¸åˆ—è¡¨ä¸­ï¼Œå¿«åˆ°æœŸåˆ¸ï¼ˆ7å¤©å†…ï¼‰è‡ªåŠ¨ç½®é¡¶ã€æ©™è‰²é«˜äº®
- ä½™é¢é¢„è®¡ä¸è¶³7å¤©æ—¶å¼¹çª—æé†’ç”¨æˆ·å……å€¼
- ç»“åˆæ™ºèƒ½æ¨èï¼Œä¼˜å…ˆä½¿ç”¨å¿«åˆ°æœŸåˆ¸

**ä¸šåŠ¡ä»·å€¼**
- âœ… é˜²æ­¢ç®—åŠ›åˆ¸è¿‡æœŸæµªè´¹
- âœ… æå‰é¢„è­¦ä½™é¢ä¸è¶³
- âœ… æå‡åˆ¸ä½¿ç”¨ç‡å’Œç”¨æˆ·æ»¡æ„åº¦

**ä¸šåŠ¡è§„åˆ™**
```typescript
åˆ°æœŸé¢„è­¦è§„åˆ™ï¼š
1. åˆ¸åˆ°æœŸé¢„è­¦ï¼š
   - 7å¤©å†…åˆ°æœŸï¼šæ©™è‰²æ ‡ç­¾"å³å°†åˆ°æœŸï¼ˆå‰©Xå¤©ï¼‰"
   - 3å¤©å†…åˆ°æœŸï¼šçº¢è‰²æ ‡ç­¾"ç´§æ€¥åˆ°æœŸï¼ˆå‰©Xå¤©ï¼‰"
   - å·²è¿‡æœŸï¼šç°è‰²æ ‡ç­¾"å·²è¿‡æœŸ"
   
2. ä½™é¢é¢„è­¦ï¼š
   - åŸºäºæ—¥å‡æ¶ˆè´¹è®¡ç®—ï¼šé¢„è®¡å¯ç”¨å¤©æ•° = ä½™é¢ / æ—¥å‡æ¶ˆè´¹
   - 7å¤©å†…ä¸è¶³ï¼šå¼¹çª—æé†’
   - 3å¤©å†…ä¸è¶³ï¼šç´§æ€¥æé†’ï¼ˆçº¢è‰²ï¼‰
   
3. æ’åºä¼˜å…ˆçº§ï¼š
   - å³å°†åˆ°æœŸåˆ¸ > æ­£å¸¸åˆ¸
   - åŒç±»å‹æŒ‰ä½™é¢ä»å°åˆ°å¤§

è¾¹ç•Œæ¡ä»¶ï¼š
- æ–°ç”¨æˆ·æ— æ¶ˆè´¹å†å²æ—¶ï¼Œä¸æ˜¾ç¤ºä½™é¢é¢„è­¦
- åˆ¸å†»ç»“/å¤±æ•ˆæ—¶ï¼Œä¸æ˜¾ç¤ºåˆ°æœŸæé†’
- é¢„è­¦å¯å…³é—­ï¼Œ24å°æ—¶å†…ä¸å†æç¤º
```

**ä¾èµ–å…³ç³»**
- ä¾èµ–ï¼šåŸæœ‰æ™ºèƒ½æ’åºç®—æ³•
- ä¾èµ–ï¼šåŸæœ‰è´¦å•ç»Ÿè®¡æœåŠ¡
- å½±å“ï¼šåˆ¸åˆ—è¡¨å±•ç¤ºã€ç”¨æˆ·é€šçŸ¥

#### äº¤äº’è®¾è®¡

**UI/UXæµç¨‹**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç®—åŠ›åˆ¸åˆ—è¡¨ï¼ˆè‡ªåŠ¨æ’åºå’Œé«˜äº®ï¼‰                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  æˆ‘çš„ç®—åŠ›åˆ¸ï¼ˆ5å¼ ï¼‰                    [ç­›é€‰ â–¼] [æ’åº â–¼] â”‚
â”‚                                                          â”‚
â”‚  ğŸ’¡ æ‚¨æœ‰ 2 å¼ åˆ¸å³å°†åˆ°æœŸï¼Œè¯·å°½å¿«ä½¿ç”¨                     â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ”´ GOV-2024-EDU-023                [å³å°†åˆ°æœŸ]       â”‚ â”‚
â”‚  â”‚ é«˜æ ¡ç§‘ç ”ç®—åŠ›è¡¥è´´é¡¹ç›®                                 â”‚ â”‚
â”‚  â”‚ å‰©ä½™ Â¥2,000  |  âš ï¸ å‰©ä½™ 3 å¤©                       â”‚ â”‚
â”‚  â”‚ é€‚ç”¨èŒƒå›´ï¼šç§‘ç ”è®¡ç®—ã€æ•°æ®åˆ†æ                         â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚ [ç«‹å³ä½¿ç”¨]                                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸŸ  GOV-2024-AI-001                [å³å°†åˆ°æœŸ]        â”‚ â”‚
â”‚  â”‚ å›½å®¶äººå·¥æ™ºèƒ½ç®—åŠ›æ”¯æŒè®¡åˆ’                             â”‚ â”‚
â”‚  â”‚ å‰©ä½™ Â¥65,000  |  âš ï¸ å‰©ä½™ 7 å¤©                       â”‚ â”‚
â”‚  â”‚ é€‚ç”¨èŒƒå›´ï¼šAIè®­ç»ƒã€æ¨¡å‹æ¨ç†ã€æ•°æ®å¤„ç†                 â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚ [ç«‹å³ä½¿ç”¨]                                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ GOV-2024-TECH-001                                   â”‚ â”‚
â”‚  â”‚ ç§‘æŠ€åˆ›æ–°ä¼ä¸šæ‰¶æŒè®¡åˆ’                                 â”‚ â”‚
â”‚  â”‚ å‰©ä½™ Â¥30,000  |  60 å¤©ååˆ°æœŸ                        â”‚ â”‚
â”‚  â”‚ é€‚ç”¨èŒƒå›´ï¼šæŠ€æœ¯ç ”å‘ã€AIè®­ç»ƒ                           â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚ [ä½¿ç”¨]                                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½™é¢é¢„è­¦å¼¹çª—ï¼ˆè‡ªåŠ¨å¼¹å‡ºï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ ä½™é¢é¢„è­¦                                 [ä»Šæ—¥ä¸å†æç¤º]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  æ‚¨çš„è´¦æˆ·ä½™é¢å³å°†ä¸è¶³                                    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ å½“å‰ä½™é¢ï¼š      Â¥1,500.00                           â”‚ â”‚
â”‚  â”‚ æ—¥å‡æ¶ˆè´¹ï¼š      Â¥500.00                             â”‚ â”‚
â”‚  â”‚ é¢„è®¡å¯ç”¨ï¼š      çº¦ 3 å¤©                             â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚ âš ï¸ ä½™é¢ä¸è¶³å¯èƒ½å¯¼è‡´æœåŠ¡ä¸­æ–­                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  å»ºè®®å……å€¼é‡‘é¢ï¼š                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â—‹ Â¥3,500.00  ï¼ˆ7å¤©ï¼‰                                â”‚ â”‚
â”‚  â”‚ â—‹ Â¥15,000.00 ï¼ˆ30å¤©ï¼‰                               â”‚ â”‚
â”‚  â”‚ â— Â¥50,000.00 ï¼ˆ100å¤©ï¼‰ [æ¨è]                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  [ç¨åå……å€¼]              [ç«‹å³å……å€¼]                      â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰“å¼€ä»»ä½•æ”¯ä»˜é¡µæ—¶çš„æé†’ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’¡ æ¸©é¦¨æç¤º                                             â”‚
â”‚                                                          â”‚
â”‚  æ‚¨æœ‰ 2 å¼ ç®—åŠ›åˆ¸å³å°†åˆ°æœŸï¼š                               â”‚
â”‚  â€¢ GOV-2024-EDU-023ï¼ˆå‰©ä½™3å¤©ï¼ŒÂ¥2,000ï¼‰                 â”‚
â”‚  â€¢ GOV-2024-AI-001ï¼ˆå‰©ä½™7å¤©ï¼ŒÂ¥65,000ï¼‰                 â”‚
â”‚                                                          â”‚
â”‚  ç³»ç»Ÿå·²è‡ªåŠ¨ä¼˜å…ˆä½¿ç”¨è¿™äº›åˆ¸è¿›è¡ŒæŠµæ‰£                        â”‚
â”‚                                                          â”‚
â”‚  [æˆ‘çŸ¥é“äº†]                                              â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é¢„è­¦è§¦å‘æµç¨‹**

```
[ç³»ç»Ÿå®šæ—¶æ£€æŸ¥]ï¼ˆæ¯å°æ—¶ï¼‰
        â”‚
        â”œâ”€â†’ [æ£€æŸ¥åˆ¸åˆ°æœŸæƒ…å†µ]
        â”‚      â”œâ”€ è·å–æ‰€æœ‰æ´»è·ƒåˆ¸
        â”‚      â”œâ”€ è®¡ç®—è·ç¦»åˆ°æœŸå¤©æ•°
        â”‚      â””â”€ æ ‡è®°7å¤©å†…åˆ°æœŸåˆ¸
        â”‚
        â””â”€â†’ [æ£€æŸ¥ä½™é¢é¢„è­¦]
               â”œâ”€ è·å–è´¦æˆ·ä½™é¢
               â”œâ”€ è®¡ç®—æ—¥å‡æ¶ˆè´¹
               â”œâ”€ é¢„ä¼°å¯ç”¨å¤©æ•°
               â””â”€ åˆ¤æ–­æ˜¯å¦éœ€è¦é¢„è­¦
        â†“
[è§¦å‘é¢„è­¦]
        â”‚
        â”œâ”€â†’ [åˆ¸åˆ°æœŸé¢„è­¦]
        â”‚      â”œâ”€ æ›´æ–°åˆ¸åˆ—è¡¨æ’åº
        â”‚      â”œâ”€ æ·»åŠ æ©™è‰²/çº¢è‰²æ ‡ç­¾
        â”‚      â””â”€ å‘é€ç«™å†…æ¶ˆæ¯
        â”‚
        â””â”€â†’ [ä½™é¢é¢„è­¦]
               â”œâ”€ å¼¹å‡ºé¢„è­¦å¯¹è¯æ¡†
               â”œâ”€ å‘é€é‚®ä»¶/çŸ­ä¿¡
               â””â”€ è®°å½•é¢„è­¦æ—¥å¿—
        â†“
[ç”¨æˆ·äº¤äº’]
        â”‚
        â”œâ”€â†’ [ç‚¹å‡»"ç«‹å³ä½¿ç”¨"]
        â”‚      â””â”€ è·³è½¬åˆ›å»ºè®¢å•é¡µ
        â”‚
        â”œâ”€â†’ [ç‚¹å‡»"ç«‹å³å……å€¼"]
        â”‚      â””â”€ è·³è½¬å……å€¼é¡µï¼ˆé¢„å¡«é‡‘é¢ï¼‰
        â”‚
        â””â”€â†’ [ç‚¹å‡»"ä»Šæ—¥ä¸å†æç¤º"]
               â””â”€ è®¾ç½®24å°æ—¶å†…ä¸æç¤º
```

**ä¼ªä»£ç å®ç°**

```typescript
// VoucherListPage.tsx

const VoucherListPage = () => {
  const [vouchers, setVouchers] = useState<Voucher[]>([]);
  const [showBalanceWarning, setShowBalanceWarning] = useState(false);
  const [balanceWarning, setBalanceWarning] = useState<BalanceWarning | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadVouchers();
    checkBalanceWarning();
  }, []);

  // åŠ è½½åˆ¸åˆ—è¡¨
  const loadVouchers = async () => {
    setLoading(true);
    try {
      const data = await voucherService.getMyVouchers();
      
      // è‡ªåŠ¨æ’åºï¼šå³å°†åˆ°æœŸåˆ¸ç½®é¡¶
      const sorted = sortVouchersByExpiry(data);
      
      // æ ‡è®°å³å°†åˆ°æœŸåˆ¸
      const withWarning = sorted.map(v => ({
        ...v,
        daysToExpire: getDaysToExpire(v.endDate),
        warningLevel: getWarningLevel(getDaysToExpire(v.endDate))
      }));
      
      setVouchers(withWarning);
    } catch (error) {
      toast.error('åŠ è½½å¤±è´¥');
    } finally {
      setLoading(false);
    }
  };

  // æ£€æŸ¥ä½™é¢é¢„è­¦
  const checkBalanceWarning = async () => {
    try {
      // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²æç¤º
      const hasWarned = localStorage.getItem('balanceWarningDate');
      const today = new Date().toDateString();
      
      if (hasWarned === today) {
        return; // ä»Šæ—¥å·²æç¤ºï¼Œè·³è¿‡
      }
      
      // è·å–ä½™é¢é¢„è­¦ä¿¡æ¯
      const warning = await accountService.getBalanceWarning();
      
      if (warning.shouldWarn) {
        setBalanceWarning(warning);
        setShowBalanceWarning(true);
      }
    } catch (error) {
      console.error('æ£€æŸ¥ä½™é¢é¢„è­¦å¤±è´¥:', error);
    }
  };

  // æŒ‰åˆ°æœŸæ—¥æœŸæ’åº
  const sortVouchersByExpiry = (vouchers: Voucher[]): Voucher[] => {
    return vouchers.sort((a, b) => {
      const daysA = getDaysToExpire(a.endDate);
      const daysB = getDaysToExpire(b.endDate);
      
      // 7å¤©å†…åˆ°æœŸçš„ä¼˜å…ˆ
      const isUrgentA = daysA <= 7;
      const isUrgentB = daysB <= 7;
      
      if (isUrgentA && !isUrgentB) return -1;
      if (!isUrgentA && isUrgentB) return 1;
      
      // åŒæ ·ç´§æ€¥ç¨‹åº¦ï¼ŒæŒ‰å¤©æ•°ä»å°åˆ°å¤§
      if (isUrgentA && isUrgentB) {
        return daysA - daysB;
      }
      
      // éƒ½ä¸ç´§æ€¥ï¼ŒæŒ‰ä½™é¢ä»å°åˆ°å¤§
      return a.remainingAmount - b.remainingAmount;
    });
  };

  // è®¡ç®—è·ç¦»åˆ°æœŸå¤©æ•°
  const getDaysToExpire = (endDate: string): number => {
    const now = new Date();
    const end = new Date(endDate);
    const diff = end.getTime() - now.getTime();
    return Math.ceil(diff / (1000 * 60 * 60 * 24));
  };

  // è·å–é¢„è­¦çº§åˆ«
  const getWarningLevel = (days: number): 'none' | 'warning' | 'urgent' | 'expired' => {
    if (days < 0) return 'expired';
    if (days <= 3) return 'urgent';
    if (days <= 7) return 'warning';
    return 'none';
  };

  // å…³é—­ä½™é¢é¢„è­¦ï¼ˆä»Šæ—¥ä¸å†æç¤ºï¼‰
  const handleDismissWarning = () => {
    const today = new Date().toDateString();
    localStorage.setItem('balanceWarningDate', today);
    setShowBalanceWarning(false);
  };

  // ç«‹å³å……å€¼
  const handleQuickRecharge = () => {
    navigate('/account-balance', {
      state: {
        suggestedAmount: balanceWarning?.recommendedAmount
      }
    });
    setShowBalanceWarning(false);
  };

  // ç«‹å³ä½¿ç”¨åˆ¸
  const handleUseVoucher = (voucher: Voucher) => {
    navigate('/create-order', {
      state: {
        preferredVoucher: voucher.id
      }
    });
  };

  // è·å–åˆ¸å¡ç‰‡æ ·å¼
  const getVoucherCardClass = (warningLevel: string): string => {
    switch (warningLevel) {
      case 'urgent':
        return 'border-2 border-red-300 bg-red-50';
      case 'warning':
        return 'border-2 border-orange-300 bg-orange-50';
      case 'expired':
        return 'border border-slate-300 bg-slate-50 opacity-60';
      default:
        return 'border border-slate-200';
    }
  };

  // è·å–é¢„è­¦æ ‡ç­¾
  const getWarningBadge = (voucher: any) => {
    const { daysToExpire, warningLevel } = voucher;
    
    if (warningLevel === 'expired') {
      return (
        <Badge className="bg-slate-100 text-slate-700">
          <XCircle className="w-3 h-3 mr-1" />
          å·²è¿‡æœŸ
        </Badge>
      );
    }
    
    if (warningLevel === 'urgent') {
      return (
        <Badge className="bg-red-100 text-red-700 animate-pulse">
          <AlertCircle className="w-3 h-3 mr-1" />
          ç´§æ€¥åˆ°æœŸï¼ˆå‰©{daysToExpire}å¤©ï¼‰
        </Badge>
      );
    }
    
    if (warningLevel === 'warning') {
      return (
        <Badge className="bg-orange-100 text-orange-700">
          <Clock className="w-3 h-3 mr-1" />
          å³å°†åˆ°æœŸï¼ˆå‰©{daysToExpire}å¤©ï¼‰
        </Badge>
      );
    }
    
    return null;
  };

  // ç»Ÿè®¡å³å°†åˆ°æœŸåˆ¸
  const expiringVouchers = vouchers.filter(v => 
    v.warningLevel === 'urgent' || v.warningLevel === 'warning'
  );

  return (
    <div className="p-8 space-y-6">
      {/* é¡µé¢æ ‡é¢˜ */}
      <div>
        <h1 className="text-2xl text-slate-900 mb-2">æˆ‘çš„ç®—åŠ›åˆ¸</h1>
        <p className="text-slate-600">æŸ¥çœ‹å’Œç®¡ç†æ‚¨çš„æ”¿åºœç®—åŠ›åˆ¸</p>
      </div>

      {/* åˆ°æœŸæé†’ */}
      {expiringVouchers.length > 0 && (
        <Alert className="bg-orange-50 border-orange-200">
          <AlertCircle className="w-5 h-5 text-orange-600" />
          <AlertDescription>
            <strong className="text-orange-900">
              ğŸ’¡ æ‚¨æœ‰ {expiringVouchers.length} å¼ åˆ¸å³å°†åˆ°æœŸï¼Œè¯·å°½å¿«ä½¿ç”¨
            </strong>
            <div className="mt-2 space-y-1">
              {expiringVouchers.slice(0, 3).map(v => (
                <p key={v.id} className="text-sm text-slate-700">
                  â€¢ {v.voucherCode}ï¼ˆå‰©ä½™{v.daysToExpire}å¤©ï¼ŒÂ¥{v.remainingAmount.toFixed(2)}ï¼‰
                </p>
              ))}
            </div>
          </AlertDescription>
        </Alert>
      )}

      {/* åˆ¸åˆ—è¡¨ */}
      {loading ? (
        <div className="text-center py-12">
          <Loader2 className="w-8 h-8 animate-spin mx-auto text-purple-600" />
          <p className="mt-4 text-slate-600">åŠ è½½ä¸­...</p>
        </div>
      ) : (
        <div className="space-y-4">
          {vouchers.map(voucher => (
            <Card
              key={voucher.id}
              className={getVoucherCardClass(voucher.warningLevel)}
            >
              <CardHeader>
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <CardTitle className="text-lg">
                        {voucher.voucherCode}
                      </CardTitle>
                      {getWarningBadge(voucher)}
                      <Badge variant="outline" className="text-sm">
                        {voucher.category === 'national' && 'å›½å®¶çº§'}
                        {voucher.category === 'provincial' && 'çœçº§'}
                        {voucher.category === 'municipal' && 'å¸‚çº§'}
                        {voucher.category === 'special' && 'ä¸“é¡¹'}
                      </Badge>
                    </div>
                    <p className="text-sm text-slate-600 mb-2">
                      {voucher.programName}
                    </p>
                    <div className="flex items-center gap-4 text-sm text-slate-600">
                      <span className="flex items-center gap-1">
                        <Wallet className="w-4 h-4" />
                        å‰©ä½™ Â¥{voucher.remainingAmount.toFixed(2)}
                      </span>
                      <span className="flex items-center gap-1">
                        <Calendar className="w-4 h-4" />
                        {voucher.warningLevel === 'expired' 
                          ? 'å·²è¿‡æœŸ' 
                          : `${voucher.daysToExpire}å¤©ååˆ°æœŸ`
                        }
                      </span>
                    </div>
                  </div>
                  {voucher.warningLevel !== 'expired' && (
                    <Button
                      onClick={() => handleUseVoucher(voucher)}
                      className={
                        voucher.warningLevel === 'urgent' || voucher.warningLevel === 'warning'
                          ? 'bg-orange-600 hover:bg-orange-700'
                          : ''
                      }
                    >
                      {voucher.warningLevel === 'urgent' || voucher.warningLevel === 'warning'
                        ? 'ç«‹å³ä½¿ç”¨'
                        : 'ä½¿ç”¨'
                      }
                    </Button>
                  )}
                </div>
              </CardHeader>
              <CardContent>
                <div className="flex items-center gap-2 text-sm text-slate-600">
                  <Tag className="w-4 h-4" />
                  <span>é€‚ç”¨èŒƒå›´ï¼š{voucher.applicableScopes.join('ã€')}</span>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}

      {/* ä½™é¢é¢„è­¦å¯¹è¯æ¡† */}
      <Dialog open={showBalanceWarning} onOpenChange={setShowBalanceWarning}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <AlertCircle className="w-5 h-5 text-orange-600" />
              âš ï¸ ä½™é¢é¢„è­¦
            </DialogTitle>
          </DialogHeader>

          {balanceWarning && (
            <div className="space-y-4">
              <p className="text-slate-700">
                æ‚¨çš„è´¦æˆ·ä½™é¢å³å°†ä¸è¶³
              </p>

              <Card className="bg-orange-50 border-orange-200">
                <CardContent className="p-4 space-y-2 text-sm">
                  <div className="flex justify-between">
                    <span className="text-slate-600">å½“å‰ä½™é¢</span>
                    <span className="font-semibold text-orange-900">
                      Â¥{balanceWarning.currentBalance.toFixed(2)}
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-slate-600">æ—¥å‡æ¶ˆè´¹</span>
                    <span className="text-slate-900">
                      Â¥{balanceWarning.dailyAverage.toFixed(2)}
                    </span>
                  </div>
                  <Separator />
                  <div className="flex justify-between">
                    <span className="text-slate-600">é¢„è®¡å¯ç”¨</span>
                    <span className="font-semibold text-orange-600">
                      çº¦ {balanceWarning.estimatedDays} å¤©
                    </span>
                  </div>
                </CardContent>
              </Card>

              <Alert className="bg-red-50 border-red-200">
                <AlertCircle className="w-4 h-4 text-red-600" />
                <AlertDescription className="text-sm text-red-800">
                  âš ï¸ ä½™é¢ä¸è¶³å¯èƒ½å¯¼è‡´æœåŠ¡ä¸­æ–­
                </AlertDescription>
              </Alert>

              <div className="space-y-2">
                <Label>å»ºè®®å……å€¼é‡‘é¢</Label>
                <RadioGroup
                  defaultValue={balanceWarning.recommendedAmount.toString()}
                >
                  <div className="flex items-center space-x-2">
                    <RadioGroupItem value={balanceWarning.options[0].amount.toString()} />
                    <Label className="flex-1">
                      Â¥{balanceWarning.options[0].amount.toFixed(2)} 
                      ï¼ˆ{balanceWarning.options[0].days}å¤©ï¼‰
                    </Label>
                  </div>
                  <div className="flex items-center space-x-2">
                    <RadioGroupItem value={balanceWarning.options[1].amount.toString()} />
                    <Label className="flex-1">
                      Â¥{balanceWarning.options[1].amount.toFixed(2)} 
                      ï¼ˆ{balanceWarning.options[1].days}å¤©ï¼‰
                    </Label>
                  </div>
                  <div className="flex items-center space-x-2">
                    <RadioGroupItem value={balanceWarning.options[2].amount.toString()} />
                    <Label className="flex-1 flex items-center gap-2">
                      Â¥{balanceWarning.options[2].amount.toFixed(2)} 
                      ï¼ˆ{balanceWarning.options[2].days}å¤©ï¼‰
                      <Badge className="bg-green-100 text-green-700">
                        æ¨è
                      </Badge>
                    </Label>
                  </div>
                </RadioGroup>
              </div>
            </div>
          )}

          <DialogFooter className="flex justify-between">
            <Button
              variant="ghost"
              onClick={handleDismissWarning}
              className="text-slate-600"
            >
              ä»Šæ—¥ä¸å†æç¤º
            </Button>
            <div className="flex gap-2">
              <Button
                variant="outline"
                onClick={() => setShowBalanceWarning(false)}
              >
                ç¨åå……å€¼
              </Button>
              <Button onClick={handleQuickRecharge}>
                ç«‹å³å……å€¼
              </Button>
            </div>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
};
```

#### APIæ”¹åŠ¨

**ä¿®æ”¹ç°æœ‰æ¥å£**

```typescript
// GET /api/vouchers/my
// æ–°å¢è¿”å›å­—æ®µ

interface VoucherResponse {
  // ... åŸæœ‰å­—æ®µ
  daysToExpire: number;        // è·ç¦»åˆ°æœŸå¤©æ•°
  warningLevel: 'none' | 'warning' | 'urgent' | 'expired'; // é¢„è­¦çº§åˆ«
  shouldHighlight: boolean;    // æ˜¯å¦éœ€è¦é«˜äº®
}
```

**æ–°å¢æ¥å£**

```typescript
// GET /api/account/balanceWarning
// è·å–ä½™é¢é¢„è­¦ä¿¡æ¯

interface BalanceWarningResponse {
  shouldWarn: boolean;         // æ˜¯å¦éœ€è¦é¢„è­¦
  currentBalance: number;      // å½“å‰ä½™é¢
  dailyAverage: number;        // æ—¥å‡æ¶ˆè´¹
  estimatedDays: number;       // é¢„è®¡å¯ç”¨å¤©æ•°
  warningLevel: 'normal' | 'warning' | 'urgent'; // é¢„è­¦çº§åˆ«
  recommendedAmount: number;   // æ¨èå……å€¼é‡‘é¢
  options: Array<{             // å……å€¼é€‰é¡¹
    amount: number;            // é‡‘é¢
    days: number;              // å¯ç”¨å¤©æ•°
    description: string;       // æè¿°
  }>;
}
```

**åç«¯é€»è¾‘å˜åŒ–**

```typescript
// voucherService.ts

class VoucherService {
  async getMyVouchers(userId: string): Promise<VoucherResponse[]> {
    // 1. è·å–åˆ¸åˆ—è¡¨
    const vouchers = await db('vouchers')
      .where({ userId, status: 'active' })
      .orWhere({ userId, status: 'used' });
    
    // 2. è®¡ç®—åˆ°æœŸå¤©æ•°å’Œé¢„è­¦çº§åˆ«
    const now = new Date();
    const withWarning = vouchers.map(v => {
      const endDate = new Date(v.endDate);
      const diff = endDate.getTime() - now.getTime();
      const daysToExpire = Math.ceil(diff / (1000 * 60 * 60 * 24));
      
      let warningLevel: string;
      if (daysToExpire < 0) {
        warningLevel = 'expired';
      } else if (daysToExpire <= 3) {
        warningLevel = 'urgent';
      } else if (daysToExpire <= 7) {
        warningLevel = 'warning';
      } else {
        warningLevel = 'none';
      }
      
      return {
        ...v,
        daysToExpire,
        warningLevel,
        shouldHighlight: warningLevel === 'urgent' || warningLevel === 'warning'
      };
    });
    
    // 3. æ’åºï¼šå³å°†åˆ°æœŸä¼˜å…ˆ
    withWarning.sort((a, b) => {
      // ç´§æ€¥çš„æ’æœ€å‰
      if (a.warningLevel === 'urgent' && b.warningLevel !== 'urgent') return -1;
      if (a.warningLevel !== 'urgent' && b.warningLevel === 'urgent') return 1;
      
      // é¢„è­¦çš„æ’å‰é¢
      if (a.warningLevel === 'warning' && b.warningLevel === 'none') return -1;
      if (a.warningLevel === 'none' && b.warningLevel === 'warning') return 1;
      
      // åŒçº§åˆ«æŒ‰å¤©æ•°ä»å°åˆ°å¤§
      if (a.warningLevel === b.warningLevel) {
        return a.daysToExpire - b.daysToExpire;
      }
      
      return 0;
    });
    
    return withWarning;
  }
}

// accountService.ts

class AccountService {
  async getBalanceWarning(userId: string): Promise<BalanceWarningResponse> {
    // 1. è·å–è´¦æˆ·ä¿¡æ¯
    const account = await db('accounts')
      .where({ userId })
      .first();
    
    // 2. è®¡ç®—æ—¥å‡æ¶ˆè´¹ï¼ˆæœ€è¿‘30å¤©ï¼‰
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    const recentCosts = await db('billing_records')
      .where({ userId })
      .where('date', '>=', thirtyDaysAgo)
      .sum('totalCost as total');
    
    const totalCost = recentCosts[0]?.total || 0;
    const dailyAverage = totalCost / 30;
    
    // 3. å¦‚æœæ—¥å‡æ¶ˆè´¹ä¸º0ï¼ˆæ–°ç”¨æˆ·ï¼‰ï¼Œä¸é¢„è­¦
    if (dailyAverage === 0) {
      return {
        shouldWarn: false,
        currentBalance: account.availableBalance,
        dailyAverage: 0,
        estimatedDays: 999,
        warningLevel: 'normal',
        recommendedAmount: 0,
        options: []
      };
    }
    
    // 4. è®¡ç®—é¢„è®¡å¯ç”¨å¤©æ•°
    const estimatedDays = Math.floor(account.availableBalance / dailyAverage);
    
    // 5. åˆ¤æ–­æ˜¯å¦éœ€è¦é¢„è­¦
    const shouldWarn = estimatedDays <= 7;
    const warningLevel = estimatedDays <= 3 ? 'urgent' : 
                        estimatedDays <= 7 ? 'warning' : 'normal';
    
    // 6. ç”Ÿæˆå……å€¼å»ºè®®
    const options = [
      {
        amount: dailyAverage * 7,
        days: 7,
        description: '7å¤©ç”¨é‡'
      },
      {
        amount: dailyAverage * 30,
        days: 30,
        description: '30å¤©ç”¨é‡'
      },
      {
        amount: dailyAverage * 100,
        days: 100,
        description: '100å¤©ç”¨é‡ï¼ˆæ¨èï¼‰'
      }
    ];
    
    return {
      shouldWarn,
      currentBalance: account.availableBalance,
      dailyAverage,
      estimatedDays,
      warningLevel,
      recommendedAmount: dailyAverage * 30, // é»˜è®¤æ¨è30å¤©
      options
    };
  }
}
```

---

ç”±äºæ–‡æ¡£ç¯‡å¹…è¾ƒé•¿ï¼Œæˆ‘å°†åˆ†æˆå¤šä¸ªéƒ¨åˆ†ç»§ç»­å®Œæˆã€‚æ‚¨æƒ³è®©æˆ‘ç»§ç»­å®Œæˆå‰©ä½™çš„P1-P3çº§ä¼˜åŒ–è¯¦ç»†è®¾è®¡ï¼Œè¿˜æ˜¯å…ˆæŸ¥çœ‹å½“å‰å·²å®Œæˆçš„P0çº§ä¼˜åŒ–è®¾è®¡ï¼Ÿ