# è´¹ç±³é›†ç¾¤èµ„æºå®šä»·ç®¡ç†é€»è¾‘æ–‡æ¡£ ğŸ“Š

## ğŸ“‹ ç›®å½•

1. [å®šä»·ç³»ç»Ÿæ¶æ„](#1-å®šä»·ç³»ç»Ÿæ¶æ„)
2. [å®šä»·ç»§æ‰¿è§„åˆ™](#2-å®šä»·ç»§æ‰¿è§„åˆ™)
3. [èµ„æºç±»å‹å®šä»·é€»è¾‘](#3-èµ„æºç±»å‹å®šä»·é€»è¾‘)
4. [å®šä»·æŸ¥è¯¢ç®—æ³•](#4-å®šä»·æŸ¥è¯¢ç®—æ³•)
5. [è´¹ç”¨è®¡ç®—é€»è¾‘](#5-è´¹ç”¨è®¡ç®—é€»è¾‘)
6. [ç¼“å­˜ç­–ç•¥](#6-ç¼“å­˜ç­–ç•¥)
7. [ç‰¹æ®Šåœºæ™¯å¤„ç†](#7-ç‰¹æ®Šåœºæ™¯å¤„ç†)

---

## 1. å®šä»·ç³»ç»Ÿæ¶æ„

### 1.1 ç³»ç»Ÿå±‚æ¬¡ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®šä»·ç³»ç»Ÿæ¶æ„                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å‰ç«¯å±‚ (Presentation Layer)                      â”‚  â”‚
â”‚  â”‚  - FlexiblePricingManagementPage                  â”‚  â”‚
â”‚  â”‚  - PaymentDialog                                  â”‚  â”‚
â”‚  â”‚  - BillingPage                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â†•                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic Layer)                â”‚  â”‚
â”‚  â”‚  - pricingService.ts                              â”‚  â”‚
â”‚  â”‚  - billingService.ts                              â”‚  â”‚
â”‚  â”‚  - voucherService.ts                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â†•                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ•°æ®è®¿é—®å±‚ (Data Access Layer)                   â”‚  â”‚
â”‚  â”‚  - REST API                                       â”‚  â”‚
â”‚  â”‚  - GraphQL API (å¯é€‰)                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â†•                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ•°æ®åº“å±‚ (Database Layer)                        â”‚  â”‚
â”‚  â”‚  - pricing_rules (å®šä»·è§„åˆ™è¡¨)                     â”‚  â”‚
â”‚  â”‚  - pricing_history (å†å²è®°å½•è¡¨)                   â”‚  â”‚
â”‚  â”‚  - pricing_cache (ç¼“å­˜è¡¨)                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒç»„ä»¶

#### 1.2.1 å®šä»·æœåŠ¡ (pricingService)

**èŒè´£**ï¼š
- ç®¡ç†å®šä»·è§„åˆ™çš„å¢åˆ æ”¹æŸ¥
- å®ç°å®šä»·ç»§æ‰¿ç®—æ³•
- æä¾›å®šä»·æŸ¥è¯¢æ¥å£
- è®¡ç®—èµ„æºè´¹ç”¨

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```typescript
// æŸ¥è¯¢å•ä¸ªèµ„æºä»·æ ¼
queryPricing(query: PricingQuery): Promise<PricingResult>

// æ‰¹é‡æŸ¥è¯¢èµ„æºä»·æ ¼
batchQueryPricing(queries: PricingQuery[]): Promise<BatchPricingResult>

// è®¡ç®—èµ„æºè´¹ç”¨
calculateResourceCost(...): Promise<CostResult>

// CRUDæ“ä½œ
getAllPricingRules(): Promise<PricingRule[]>
savePricingRule(rule: PricingRule): Promise<PricingRule>
deletePricingRule(ruleId: string): Promise<boolean>
```

#### 1.2.2 è®¡è´¹æœåŠ¡ (billingService)

**èŒè´£**ï¼š
- åˆ›å»ºè®¡è´¹è®¢å•
- ç”Ÿæˆè´¦å•
- å¤„ç†æ”¯ä»˜
- é›†æˆå®šä»·æœåŠ¡

#### 1.2.3 å‰ç«¯ç®¡ç†é¡µé¢

**èŒè´£**ï¼š
- å®šä»·è§„åˆ™å¯è§†åŒ–ç®¡ç†
- å®šä»·æµ‹è¯•å·¥å…·
- è´¹ç”¨é¢„ä¼°å±•ç¤º

---

## 2. å®šä»·ç»§æ‰¿è§„åˆ™

### 2.1 ç»§æ‰¿ä¼˜å…ˆçº§

```
ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
  èŠ‚ç‚¹å®šä»· (node) > èµ„æºæ± å®šä»· (pool) > å¯ç”¨åŒºå®šä»· (zone) > é»˜è®¤å®šä»· (default)
```

### 2.2 ç»§æ‰¿ç®—æ³•æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             å®šä»·æŸ¥è¯¢ç»§æ‰¿ç®—æ³•                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  è¾“å…¥: {                                                 â”‚
â”‚    resourceType: 'gpu',                                 â”‚
â”‚    resourceSpec: 'A100-40GB',                           â”‚
â”‚    zoneId: 'zone-001',                                  â”‚
â”‚    poolId: 'pool-001',                                  â”‚
â”‚    nodeId: 'node-001'                                   â”‚
â”‚  }                                                      â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 1: æŸ¥è¯¢èŠ‚ç‚¹çº§å®šä»·                          â”‚   â”‚
â”‚  â”‚   WHERE scope='node' AND scope_id='node-001'    â”‚   â”‚
â”‚  â”‚     AND resource_type='gpu'                     â”‚   â”‚
â”‚  â”‚     AND resource_spec='A100-40GB'               â”‚   â”‚
â”‚  â”‚     AND enabled=1                               â”‚   â”‚
â”‚  â”‚     AND effective_date <= NOW()                 â”‚   â”‚
â”‚  â”‚     AND (expiry_date IS NULL OR expiry > NOW()) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â†“ (å¦‚æœæ‰¾åˆ°)                                 â”‚
â”‚         è¿”å›èŠ‚ç‚¹ä»·æ ¼ âœ“                                   â”‚
â”‚             â†“ (å¦‚æœæœªæ‰¾åˆ°)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 2: æŸ¥è¯¢èµ„æºæ± çº§å®šä»·                        â”‚   â”‚
â”‚  â”‚   WHERE scope='pool' AND scope_id='pool-001'    â”‚   â”‚
â”‚  â”‚     AND resource_type='gpu'                     â”‚   â”‚
â”‚  â”‚     AND resource_spec='A100-40GB'               â”‚   â”‚
â”‚  â”‚     AND enabled=1                               â”‚   â”‚
â”‚  â”‚     AND effective_date <= NOW()                 â”‚   â”‚
â”‚  â”‚     AND (expiry_date IS NULL OR expiry > NOW()) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â†“ (å¦‚æœæ‰¾åˆ°)                                 â”‚
â”‚       è¿”å›èµ„æºæ± ä»·æ ¼ âœ“                                   â”‚
â”‚             â†“ (å¦‚æœæœªæ‰¾åˆ°)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 3: æŸ¥è¯¢å¯ç”¨åŒºçº§å®šä»·                        â”‚   â”‚
â”‚  â”‚   WHERE scope='zone' AND scope_id='zone-001'    â”‚   â”‚
â”‚  â”‚     AND resource_type='gpu'                     â”‚   â”‚
â”‚  â”‚     AND resource_spec='A100-40GB'               â”‚   â”‚
â”‚  â”‚     AND enabled=1                               â”‚   â”‚
â”‚  â”‚     AND effective_date <= NOW()                 â”‚   â”‚
â”‚  â”‚     AND (expiry_date IS NULL OR expiry > NOW()) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â†“ (å¦‚æœæ‰¾åˆ°)                                 â”‚
â”‚       è¿”å›å¯ç”¨åŒºä»·æ ¼ âœ“                                   â”‚
â”‚             â†“ (å¦‚æœæœªæ‰¾åˆ°)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 4: æŸ¥è¯¢é»˜è®¤å®šä»·                            â”‚   â”‚
â”‚  â”‚   WHERE scope='default'                         â”‚   â”‚
â”‚  â”‚     AND resource_type='gpu'                     â”‚   â”‚
â”‚  â”‚     AND resource_spec='A100-40GB'               â”‚   â”‚
â”‚  â”‚     AND enabled=1                               â”‚   â”‚
â”‚  â”‚     AND effective_date <= NOW()                 â”‚   â”‚
â”‚  â”‚     AND (expiry_date IS NULL OR expiry > NOW()) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â†“ (å¦‚æœæ‰¾åˆ°)                                 â”‚
â”‚        è¿”å›é»˜è®¤ä»·æ ¼ âœ“                                    â”‚
â”‚             â†“ (å¦‚æœæœªæ‰¾åˆ°)                               â”‚
â”‚        æŠ›å‡ºå¼‚å¸¸ï¼šæœªæ‰¾åˆ°å®šä»·è§„åˆ™                          â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 ç»§æ‰¿ç¤ºä¾‹

#### ç¤ºä¾‹1ï¼šå®Œæ•´ç»§æ‰¿é“¾

```typescript
// åœºæ™¯ï¼šæˆéƒ½å¯ç”¨åŒº â†’ é«˜æ€§èƒ½GPUèµ„æºæ±  â†’ GPU-Node-001
const query = {
  resourceType: 'gpu',
  resourceSpec: 'A100-40GB',
  zoneId: 'zone-001',     // æˆéƒ½å¯ç”¨åŒºA
  poolId: 'pool-001',     // é«˜æ€§èƒ½GPUèµ„æºæ± 
  nodeId: 'node-001',     // GPU-Node-001
};

// å®šä»·æ•°æ®ï¼š
// - é»˜è®¤ä»·æ ¼: Â¥25.0/å¡Â·å°æ—¶
// - å¯ç”¨åŒºä»·æ ¼: Â¥23.0/å¡Â·å°æ—¶ (æˆéƒ½ç”µåŠ›ä¾¿å®œ)
// - èµ„æºæ± ä»·æ ¼: æœªé…ç½®
// - èŠ‚ç‚¹ä»·æ ¼: Â¥22.0/å¡Â·å°æ—¶ (æ–°è®¾å¤‡æµ‹è¯•ä¼˜æƒ )

// æŸ¥è¯¢è¿‡ç¨‹ï¼š
// 1. æŸ¥æ‰¾èŠ‚ç‚¹ä»·æ ¼ â†’ æ‰¾åˆ° Â¥22.0 âœ“
// 2. ä¸å†ç»§ç»­æŸ¥æ‰¾

// ç»“æœï¼š
{
  pricePerUnit: 22.0,
  unit: 'å¡Â·å°æ—¶',
  scopeChain: ['default', 'zone:zone-001', 'node:node-001'],
  appliedRule: { id: 'node-gpu-a100-node001', ... }
}
```

#### ç¤ºä¾‹2ï¼šè·³è·ƒç»§æ‰¿

```typescript
// åœºæ™¯ï¼šæˆéƒ½å¯ç”¨åŒº â†’ æ ‡å‡†GPUèµ„æºæ±  â†’ GPU-Node-050
const query = {
  resourceType: 'gpu',
  resourceSpec: 'V100-32GB',
  zoneId: 'zone-001',     // æˆéƒ½å¯ç”¨åŒºA
  poolId: 'pool-002',     // æ ‡å‡†GPUèµ„æºæ± 
  nodeId: 'node-050',     // GPU-Node-050
};

// å®šä»·æ•°æ®ï¼š
// - é»˜è®¤ä»·æ ¼: Â¥18.0/å¡Â·å°æ—¶
// - å¯ç”¨åŒºä»·æ ¼: æœªé…ç½®
// - èµ„æºæ± ä»·æ ¼: æœªé…ç½®
// - èŠ‚ç‚¹ä»·æ ¼: æœªé…ç½®

// æŸ¥è¯¢è¿‡ç¨‹ï¼š
// 1. æŸ¥æ‰¾èŠ‚ç‚¹ä»·æ ¼ â†’ æœªæ‰¾åˆ°
// 2. æŸ¥æ‰¾èµ„æºæ± ä»·æ ¼ â†’ æœªæ‰¾åˆ°
// 3. æŸ¥æ‰¾å¯ç”¨åŒºä»·æ ¼ â†’ æœªæ‰¾åˆ°
// 4. æŸ¥æ‰¾é»˜è®¤ä»·æ ¼ â†’ æ‰¾åˆ° Â¥18.0 âœ“

// ç»“æœï¼š
{
  pricePerUnit: 18.0,
  unit: 'å¡Â·å°æ—¶',
  scopeChain: ['default'],
  appliedRule: { id: 'default-gpu-v100', ... }
}
```

---

## 3. èµ„æºç±»å‹å®šä»·é€»è¾‘

### 3.1 GPUèµ„æºå®šä»·

#### 3.1.1 å®šä»·ç»´åº¦

| ç»´åº¦ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| GPUå‹å· | ä¸åŒå‹å·GPUæ€§èƒ½å·®å¼‚å¤§ | A100, V100, T4 |
| æ˜¾å­˜å¤§å° | å½±å“è®­ç»ƒä»»åŠ¡è§„æ¨¡ | 40GB, 80GB |
| ä½¿ç”¨åœºæ™¯ | è®­ç»ƒã€æ¨ç†ã€å›¾å½¢æ¸²æŸ“ | è®­ç»ƒä¼˜åŒ–, æ¨ç†ä¼˜åŒ– |
| åœ°ç†ä½ç½® | ä¸åŒæœºæˆ¿æˆæœ¬ä¸åŒ | æˆéƒ½, åŒ—äº¬, ä¸Šæµ· |
| è®¾å¤‡çŠ¶æ€ | æ–°è®¾å¤‡ã€è€è®¾å¤‡ | æ–°ä¸Šçº¿, å³å°†ä¸‹çº¿ |

#### 3.1.2 å®šä»·ç­–ç•¥

**ç­–ç•¥1ï¼šæ€§èƒ½åˆ†çº§å®šä»·**
```typescript
// é«˜æ€§èƒ½GPU (A100-80GB)
{
  resourceSpec: 'A100-80GB',
  pricePerUnit: 35.0,  // æœ€é«˜ä»·æ ¼
  description: 'å¤§æ˜¾å­˜è®­ç»ƒGPUï¼Œé€‚åˆå¤§è§„æ¨¡æ¨¡å‹'
}

// ä¸­ç­‰æ€§èƒ½GPU (A100-40GB)
{
  resourceSpec: 'A100-40GB',
  pricePerUnit: 25.0,  // ä¸­ç­‰ä»·æ ¼
  description: 'é«˜æ€§èƒ½è®­ç»ƒGPUï¼Œé€‚åˆä¸€èˆ¬è®­ç»ƒä»»åŠ¡'
}

// æ¨ç†ä¼˜åŒ–GPU (T4-16GB)
{
  resourceSpec: 'T4-16GB',
  pricePerUnit: 8.0,   // è¾ƒä½ä»·æ ¼
  description: 'æ¨ç†ä¼˜åŒ–GPUï¼Œæ€§ä»·æ¯”é«˜'
}
```

**ç­–ç•¥2ï¼šåŒºåŸŸå·®å¼‚å®šä»·**
```typescript
// æˆéƒ½å¯ç”¨åŒºï¼ˆç”µåŠ›æˆæœ¬ä½ï¼‰
{
  scope: 'zone',
  scopeId: 'zone-001',
  resourceSpec: 'A100-40GB',
  pricePerUnit: 23.0,  // æ¯”é»˜è®¤ä¾¿å®œ Â¥2
}

// åŒ—äº¬å¯ç”¨åŒºï¼ˆæœºæˆ¿ç­‰çº§é«˜ï¼‰
{
  scope: 'zone',
  scopeId: 'zone-002',
  resourceSpec: 'A100-40GB',
  pricePerUnit: 26.0,  // æ¯”é»˜è®¤è´µ Â¥1
}
```

**ç­–ç•¥3ï¼šè®¾å¤‡ç”Ÿå‘½å‘¨æœŸå®šä»·**
```typescript
// æ–°è®¾å¤‡æµ‹è¯•æœŸï¼ˆå¸å¼•ç”¨æˆ·ï¼‰
{
  scope: 'node',
  scopeId: 'node-new-001',
  pricePerUnit: 20.0,  // ä¼˜æƒ ä»·
  expiryDate: '2025-01-31T23:59:59Z',  // æµ‹è¯•æœŸç»“æŸ
}

// å³å°†ä¸‹çº¿è®¾å¤‡ï¼ˆæ¸…åº“å­˜ï¼‰
{
  scope: 'node',
  scopeId: 'node-old-099',
  pricePerUnit: 15.0,  // ä½ä»·ä¿ƒé”€
  description: 'è®¾å¤‡è€åŒ–ï¼Œè®¡åˆ’ä¸‹çº¿'
}
```

#### 3.1.3 è®¡è´¹å…¬å¼

```typescript
GPUè´¹ç”¨ = GPUå•ä»· Ã— GPUå¡æ•° Ã— ä½¿ç”¨æ—¶é•¿

ç¤ºä¾‹ï¼š
  2å¼  A100-40GB Ã— 24å°æ—¶ Ã— Â¥23.0/å¡Â·å°æ—¶
  = 2 Ã— 24 Ã— 23.0
  = Â¥1,104.0
```

---

### 3.2 CPUèµ„æºå®šä»·

#### 3.2.1 å®šä»·ç»´åº¦

| ç»´åº¦ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| CPUå‹å· | Intel, AMD | Xeon, EPYC |
| æ ¸å¿ƒæ•° | å½±å“å¹¶è¡Œèƒ½åŠ› | 8æ ¸, 16æ ¸, 32æ ¸ |
| ä¸»é¢‘ | å½±å“å•æ ¸æ€§èƒ½ | 2.5GHz, 3.0GHz |
| CPUä»£æ•° | æ–°è€æ¶æ„ | ç¬¬3ä»£, ç¬¬4ä»£ |

#### 3.2.2 å®šä»·ç­–ç•¥

**ç»Ÿä¸€å®šä»·ï¼ˆç®€åŒ–ç®¡ç†ï¼‰**
```typescript
// CPUæ ¸å¿ƒé»˜è®¤å®šä»·
{
  resourceType: 'cpu',
  pricePerUnit: 0.5,  // æ¯æ ¸æ¯å°æ—¶
  unit: 'æ ¸Â·å°æ—¶',
  description: 'é€šç”¨CPUæ ¸å¿ƒä»·æ ¼'
}
```

**å·®å¼‚åŒ–å®šä»·ï¼ˆé«˜æ€§èƒ½åœºæ™¯ï¼‰**
```typescript
// é«˜æ€§èƒ½CPUèµ„æºæ± 
{
  scope: 'pool',
  scopeId: 'pool-cpu-high',
  resourceType: 'cpu',
  pricePerUnit: 0.8,  // é«˜æ€§èƒ½æº¢ä»·
  description: 'æœ€æ–°ä¸€ä»£CPUï¼Œä¸»é¢‘æ›´é«˜'
}

// å¼€å‘æµ‹è¯•èµ„æºæ± 
{
  scope: 'pool',
  scopeId: 'pool-cpu-dev',
  resourceType: 'cpu',
  pricePerUnit: 0.3,  // ä¼˜æƒ ä»·
  description: 'è€æ—§CPUï¼Œé€‚åˆå¼€å‘æµ‹è¯•'
}
```

#### 3.2.3 è®¡è´¹å…¬å¼

```typescript
CPUè´¹ç”¨ = CPUå•ä»· Ã— CPUæ ¸æ•° Ã— ä½¿ç”¨æ—¶é•¿

ç¤ºä¾‹ï¼š
  8æ ¸ Ã— 24å°æ—¶ Ã— Â¥0.5/æ ¸Â·å°æ—¶
  = 8 Ã— 24 Ã— 0.5
  = Â¥96.0
```

---

### 3.3 å†…å­˜èµ„æºå®šä»·

#### 3.3.1 å®šä»·ç»´åº¦

| ç»´åº¦ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| å†…å­˜å¤§å° | æŒ‰GBè®¡è´¹ | 8GB, 16GB, 32GB |
| å†…å­˜ç±»å‹ | DDR4, DDR5 | DDR4-3200, DDR5-4800 |
| å†…å­˜é€Ÿåº¦ | å½±å“è®¿é—®é€Ÿåº¦ | 3200MHz, 4800MHz |

#### 3.3.2 å®šä»·ç­–ç•¥

**ç»Ÿä¸€å®šä»·**
```typescript
// å†…å­˜é»˜è®¤å®šä»·
{
  resourceType: 'memory',
  pricePerUnit: 0.1,  // æ¯GBæ¯å°æ—¶
  unit: 'GBÂ·å°æ—¶',
}
```

#### 3.3.3 è®¡è´¹å…¬å¼

```typescript
å†…å­˜è´¹ç”¨ = å†…å­˜å•ä»· Ã— å†…å­˜å¤§å°(GB) Ã— ä½¿ç”¨æ—¶é•¿

ç¤ºä¾‹ï¼š
  32GB Ã— 24å°æ—¶ Ã— Â¥0.1/GBÂ·å°æ—¶
  = 32 Ã— 24 Ã— 0.1
  = Â¥76.8
```

---

### 3.4 å­˜å‚¨èµ„æºå®šä»·

#### 3.4.1 å®šä»·ç»´åº¦

| ç»´åº¦ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| å­˜å‚¨ï¿½ï¿½ï¿½å‹ | æ€§èƒ½å·®å¼‚ | SSD, HDD, NVMe |
| å­˜å‚¨å®¹é‡ | é˜¶æ¢¯å®šä»· | 0-1TB, 1-10TB, 10TB+ |
| è¯»å†™æ€§èƒ½ | IOPS, ååé‡ | é«˜æ€§èƒ½, æ ‡å‡†, å½’æ¡£ |
| å†—ä½™çº§åˆ« | æ•°æ®å®‰å…¨ | å•å‰¯æœ¬, ä¸‰å‰¯æœ¬ |

#### 3.4.2 å®šä»·ç­–ç•¥

**æŒ‰ç±»å‹å®šä»·**
```typescript
// SSDå­˜å‚¨
{
  resourceType: 'storage',
  resourceSpec: 'SSD',
  pricePerUnit: 0.5,  // æ¯GBæ¯æœˆ
  unit: 'GBÂ·æœˆ',
  billingCycle: 'monthly',
  description: 'é«˜æ€§èƒ½SSDå­˜å‚¨'
}

// HDDå­˜å‚¨
{
  resourceType: 'storage',
  resourceSpec: 'HDD',
  pricePerUnit: 0.2,  // æ¯GBæ¯æœˆ
  unit: 'GBÂ·æœˆ',
  billingCycle: 'monthly',
  description: 'ç»æµå‹HDDå­˜å‚¨'
}

// NVMeå­˜å‚¨ï¼ˆé«˜æ€§èƒ½èµ„æºæ± ï¼‰
{
  scope: 'pool',
  scopeId: 'pool-storage-nvme',
  resourceType: 'storage',
  resourceSpec: 'NVMe',
  pricePerUnit: 0.8,  // æ¯GBæ¯æœˆ
  description: 'è¶…é«˜æ€§èƒ½NVMeå­˜å‚¨'
}
```

**é˜¶æ¢¯å®šä»·ï¼ˆå¯é€‰ï¼‰**
```typescript
// å®ç°æ–¹å¼ï¼šä½¿ç”¨æŠ˜æ‰£ç³»ç»Ÿ
if (storageSize >= 10 * 1024) {  // 10TB+
  discount = 0.9;  // 9æŠ˜
} else if (storageSize >= 1 * 1024) {  // 1TB+
  discount = 0.95;  // 95æŠ˜
}

finalPrice = basePrice * storageSize * discount;
```

#### 3.4.3 è®¡è´¹å…¬å¼

```typescript
å­˜å‚¨è´¹ç”¨ = å­˜å‚¨å•ä»· Ã— å­˜å‚¨å®¹é‡(GB) Ã— æ—¶é•¿ç³»æ•°

// æŒ‰æœˆè®¡è´¹
æœˆåº¦è´¹ç”¨ = å­˜å‚¨å•ä»· Ã— å­˜å‚¨å®¹é‡

// æŒ‰å¤©è®¡è´¹ï¼ˆæ—¥å‡ä»·æ ¼ï¼‰
æ—¥å‡è´¹ç”¨ = (å­˜å‚¨å•ä»· Ã— å­˜å‚¨å®¹é‡) / 30

// æŒ‰å°æ—¶è®¡è´¹ï¼ˆå°æ—¶å‡ä»·ï¼‰
å°æ—¶è´¹ç”¨ = (å­˜å‚¨å•ä»· Ã— å­˜å‚¨å®¹é‡) / 30 / 24

ç¤ºä¾‹ï¼š
  500GB SSD Ã— 1ä¸ªæœˆ Ã— Â¥0.5/GBÂ·æœˆ
  = 500 Ã— 1 Ã— 0.5
  = Â¥250.0/æœˆ
```

---

### 3.5 ç½‘ç»œèµ„æºå®šä»·

#### 3.5.1 å®šä»·ç»´åº¦

| ç»´åº¦ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| æµé‡æ–¹å‘ | å…¥ç½‘ã€å‡ºç½‘ | ingress, egress |
| æµé‡ç±»å‹ | å…¬ç½‘ã€å†…ç½‘ | internet, intranet |
| æµé‡å¤§å° | é˜¶æ¢¯å®šä»· | 0-10TB, 10-50TB, 50TB+ |
| ç›®æ ‡åŒºåŸŸ | è·¨åœ°åŸŸè´¹ç”¨ | åŒåŸ, åŒçœ, è·¨çœ |

#### 3.5.2 å®šä»·ç­–ç•¥

**æŒ‰æµé‡æ–¹å‘å®šä»·**
```typescript
// å‡ºç½‘æµé‡ï¼ˆæ”¶è´¹ï¼‰
{
  resourceType: 'network',
  resourceSpec: 'egress',
  pricePerUnit: 0.8,  // æ¯GB
  unit: 'GB',
  description: 'å…¬ç½‘å‡ºç½‘æµé‡'
}

// å…¥ç½‘æµé‡ï¼ˆå…è´¹ï¼‰
{
  resourceType: 'network',
  resourceSpec: 'ingress',
  pricePerUnit: 0.0,  // å…è´¹
  unit: 'GB',
  description: 'å…¬ç½‘å…¥ç½‘æµé‡ï¼ˆå…è´¹ï¼‰'
}
```

**è·¨å¯ç”¨åŒºæµé‡**
```typescript
// åŒå¯ç”¨åŒºå†…ï¼ˆå…è´¹ï¼‰
{
  resourceType: 'network',
  resourceSpec: 'intrazone',
  pricePerUnit: 0.0,
  description: 'åŒå¯ç”¨åŒºå†…æµé‡ï¼ˆå…è´¹ï¼‰'
}

// è·¨å¯ç”¨åŒºï¼ˆæ”¶è´¹ï¼‰
{
  resourceType: 'network',
  resourceSpec: 'interzone',
  pricePerUnit: 0.1,  // æ¯GB
  description: 'è·¨å¯ç”¨åŒºæµé‡'
}
```

#### 3.5.3 è®¡è´¹å…¬å¼

```typescript
ç½‘ç»œè´¹ç”¨ = æµé‡å•ä»· Ã— æµé‡å¤§å°(GB)

ç¤ºä¾‹ï¼š
  å‡ºç½‘æµé‡ 100GB Ã— Â¥0.8/GB
  = 100 Ã— 0.8
  = Â¥80.0
```

---

## 4. å®šä»·æŸ¥è¯¢ç®—æ³•

### 4.1 æŸ¥è¯¢ç®—æ³•ä¼ªä»£ç 

```typescript
function queryPricing(query: PricingQuery): PricingResult {
  const { resourceType, resourceSpec, zoneId, poolId, nodeId, date } = query;
  
  // 1. æ„å»ºæŸ¥è¯¢æ¡ä»¶
  const baseConditions = {
    resourceType,
    resourceSpec: resourceSpec || null,
    enabled: true,
    effectiveDate: { $lte: date },
    expiryDate: { $or: [{ $gt: date }, { $eq: null }] }
  };
  
  // 2. æŒ‰ä¼˜å…ˆçº§æŸ¥è¯¢
  let rule: PricingRule | null = null;
  
  // 2.1 èŠ‚ç‚¹çº§
  if (nodeId && !rule) {
    rule = findOne({
      ...baseConditions,
      scope: 'node',
      scopeId: nodeId
    });
  }
  
  // 2.2 èµ„æºæ± çº§
  if (poolId && !rule) {
    rule = findOne({
      ...baseConditions,
      scope: 'pool',
      scopeId: poolId
    });
  }
  
  // 2.3 å¯ç”¨åŒºçº§
  if (zoneId && !rule) {
    rule = findOne({
      ...baseConditions,
      scope: 'zone',
      scopeId: zoneId
    });
  }
  
  // 2.4 é»˜è®¤çº§
  if (!rule) {
    rule = findOne({
      ...baseConditions,
      scope: 'default'
    });
  }
  
  // 3. æœªæ‰¾åˆ°åˆ™æŠ›å‡ºå¼‚å¸¸
  if (!rule) {
    throw new Error('æœªæ‰¾åˆ°å®šä»·è§„åˆ™');
  }
  
  // 4. æ„å»ºç»§æ‰¿é“¾
  const scopeChain = buildScopeChain(rule, zoneId, poolId, nodeId);
  
  // 5. è¿”å›ç»“æœ
  return {
    pricePerUnit: rule.pricePerUnit,
    unit: rule.unit,
    billingCycle: rule.billingCycle,
    currency: rule.currency,
    appliedRule: rule,
    scopeChain
  };
}
```

### 4.2 SQLæŸ¥è¯¢ä¼˜åŒ–

```sql
-- ä½¿ç”¨CASEè¯­å¥å®ç°ä¼˜å…ˆçº§æŸ¥è¯¢ï¼ˆå•æ¬¡æŸ¥è¯¢ï¼‰
SELECT 
    id,
    scope,
    price_per_unit,
    unit,
    billing_cycle,
    currency,
    CASE 
        WHEN scope = 'node' THEN 1
        WHEN scope = 'pool' THEN 2
        WHEN scope = 'zone' THEN 3
        WHEN scope = 'default' THEN 4
    END AS priority
FROM pricing_rules
WHERE resource_type = ?
  AND (resource_spec = ? OR resource_spec IS NULL)
  AND enabled = 1
  AND effective_date <= ?
  AND (expiry_date IS NULL OR expiry_date > ?)
  AND (
      (scope = 'node' AND scope_id = ?)
      OR (scope = 'pool' AND scope_id = ?)
      OR (scope = 'zone' AND scope_id = ?)
      OR (scope = 'default' AND scope_id IS NULL)
  )
ORDER BY priority ASC, resource_spec IS NOT NULL DESC
LIMIT 1;
```

---

## 5. è´¹ç”¨è®¡ç®—é€»è¾‘

### 5.1 å•èµ„æºè´¹ç”¨è®¡ç®—

```typescript
/**
 * è®¡ç®—å•ä¸ªèµ„æºçš„è´¹ç”¨
 */
async function calculateResourceCost(
  resourceType: ResourceType,
  resourceSpec: string | undefined,
  quantity: number,          // èµ„æºæ•°é‡
  duration: number,          // ä½¿ç”¨æ—¶é•¿ï¼ˆå°æ—¶ï¼‰
  context: {
    zoneId?: string,
    poolId?: string,
    nodeId?: string
  }
): Promise<CostResult> {
  // 1. æŸ¥è¯¢å®šä»·
  const pricing = await queryPricing({
    resourceType,
    resourceSpec,
    ...context
  });
  
  // 2. è®¡ç®—åŸºç¡€è´¹ç”¨
  let baseCost = pricing.pricePerUnit * quantity * duration;
  
  // 3. æ ¹æ®è®¡è´¹å‘¨æœŸè°ƒæ•´
  if (pricing.billingCycle === 'daily') {
    // æŒ‰å¤©è®¡è´¹ï¼Œè½¬æ¢ä¸ºå¤©æ•°
    baseCost = pricing.pricePerUnit * quantity * (duration / 24);
  } else if (pricing.billingCycle === 'monthly') {
    // æŒ‰æœˆè®¡è´¹ï¼Œè½¬æ¢ä¸ºæœˆæ•°
    baseCost = pricing.pricePerUnit * quantity * (duration / 24 / 30);
  }
  
  // 4. è¿”å›ç»“æœ
  return {
    totalCost: baseCost,
    pricePerUnit: pricing.pricePerUnit,
    quantity,
    duration,
    unit: pricing.unit,
    appliedRule: pricing.appliedRule,
    scopeChain: pricing.scopeChain
  };
}
```

### 5.2 ç»¼åˆè´¹ç”¨è®¡ç®—

```typescript
/**
 * è®¡ç®—AIå·¥ä½œè´Ÿè½½çš„ç»¼åˆè´¹ç”¨
 */
async function calculateWorkloadCost(
  workload: {
    gpuType: string,
    gpuCount: number,
    cpuCores: number,
    memoryGB: number,
    storageGB: number,
    duration: number,  // å°æ—¶
    zoneId: string,
    poolId?: string,
    nodeId?: string
  }
): Promise<ComprehensiveCost> {
  const { gpuType, gpuCount, cpuCores, memoryGB, storageGB, duration, ...context } = workload;
  
  // 1. è®¡ç®—GPUè´¹ç”¨
  const gpuCost = await calculateResourceCost(
    'gpu',
    gpuType,
    gpuCount,
    duration,
    context
  );
  
  // 2. è®¡ç®—CPUè´¹ç”¨
  const cpuCost = await calculateResourceCost(
    'cpu',
    undefined,
    cpuCores,
    duration,
    context
  );
  
  // 3. è®¡ç®—å†…å­˜è´¹ç”¨
  const memoryCost = await calculateResourceCost(
    'memory',
    undefined,
    memoryGB,
    duration,
    context
  );
  
  // 4. è®¡ç®—å­˜å‚¨è´¹ç”¨ï¼ˆæŒ‰æœˆï¼‰
  const storageCost = await calculateResourceCost(
    'storage',
    'SSD',
    storageGB,
    1,  // æŒ‰æœˆè®¡è´¹
    context
  );
  
  // 5. è®¡ç®—æ€»è´¹ç”¨
  const totalCost = 
    gpuCost.totalCost +
    cpuCost.totalCost +
    memoryCost.totalCost +
    storageCost.totalCost;
  
  // 6. è¿”å›è¯¦ç»†è´¹ç”¨æ˜ç»†
  return {
    totalCost,
    breakdown: {
      gpu: gpuCost.totalCost,
      cpu: cpuCost.totalCost,
      memory: memoryCost.totalCost,
      storage: storageCost.totalCost
    },
    details: {
      gpuCost,
      cpuCost,
      memoryCost,
      storageCost
    }
  };
}
```

### 5.3 è´¹ç”¨é¢„ä¼°

```typescript
/**
 * é¢„ä¼°æœªæ¥è´¹ç”¨
 */
async function estimateFutureCost(
  workload: Workload,
  futureDays: number
): Promise<CostEstimate> {
  // 1. è®¡ç®—å½“å‰é…ç½®çš„å°æ—¶è´¹ç”¨
  const hourlyRate = await calculateWorkloadCost({
    ...workload,
    duration: 1  // 1å°æ—¶
  });
  
  // 2. è®¡ç®—æ—¥å‡è´¹ç”¨
  const dailyRate = hourlyRate.totalCost * 24;
  
  // 3. è®¡ç®—æœˆå‡è´¹ç”¨
  const monthlyRate = dailyRate * 30;
  
  // 4. è®¡ç®—é¢„ä¼°æ€»è´¹ç”¨
  const estimatedTotal = dailyRate * futureDays;
  
  return {
    hourlyRate: hourlyRate.totalCost,
    dailyRate,
    monthlyRate,
    estimatedTotal,
    estimatedDays: futureDays,
    breakdown: hourlyRate.breakdown
  };
}
```

---

## 6. ç¼“å­˜ç­–ç•¥

### 6.1 ç¼“å­˜å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç¼“å­˜å±‚æ¬¡ç»“æ„                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  L1: å†…å­˜ç¼“å­˜ (TTL: 5åˆ†é’Ÿ)               â”‚
â”‚      - çƒ­ç‚¹å®šä»·è§„åˆ™                      â”‚
â”‚      - å¸¸ç”¨æŸ¥è¯¢ç»“æœ                      â”‚
â”‚                                          â”‚
â”‚  L2: Redisç¼“å­˜ (TTL: 1å°æ—¶)             â”‚
â”‚      - å®šä»·è§„åˆ™åˆ—è¡¨                      â”‚
â”‚      - æŸ¥è¯¢ç»“æœç¼“å­˜                      â”‚
â”‚                                          â”‚
â”‚  L3: æ•°æ®åº“ç¼“å­˜è¡¨ (TTL: 1å¤©)            â”‚
â”‚      - pricing_cacheè¡¨                   â”‚
â”‚      - å†å²æŸ¥è¯¢è®°å½•                      â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ç¼“å­˜é”®è®¾è®¡

```typescript
// å®šä»·è§„åˆ™ç¼“å­˜é”®
const rulesCacheKey = `pricing:rules:${scope}:${scopeId}:${resourceType}`;

// æŸ¥è¯¢ç»“æœç¼“å­˜é”®
const queryCacheKey = `pricing:query:${hashCode(queryParams)}`;

// ç¤ºä¾‹
'pricing:rules:zone:zone-001:gpu'
'pricing:query:fb7c8a9d4e3f2a1b'
```

### 6.3 ç¼“å­˜å¤±æ•ˆç­–ç•¥

```typescript
/**
 * ç¼“å­˜å¤±æ•ˆè§¦å‘æ¡ä»¶
 */
const CACHE_INVALIDATION_TRIGGERS = [
  'CREATE_PRICING_RULE',   // åˆ›å»ºæ–°è§„åˆ™
  'UPDATE_PRICING_RULE',   // æ›´æ–°è§„åˆ™
  'DELETE_PRICING_RULE',   // åˆ é™¤è§„åˆ™
  'ENABLE_PRICING_RULE',   // å¯ç”¨è§„åˆ™
  'DISABLE_PRICING_RULE',  // ç¦ç”¨è§„åˆ™
];

/**
 * ç¼“å­˜å¤±æ•ˆé€»è¾‘
 */
async function invalidateCache(trigger: string, ruleId: string) {
  const rule = await getPricingRule(ruleId);
  
  // 1. æ¸…é™¤è§„åˆ™ç¼“å­˜
  await cache.delete(`pricing:rules:${rule.scope}:${rule.scopeId}:*`);
  
  // 2. æ¸…é™¤æŸ¥è¯¢ç¼“å­˜
  await cache.delete(`pricing:query:*`);
  
  // 3. å‘å¸ƒç¼“å­˜å¤±æ•ˆäº‹ä»¶ï¼ˆé›†ç¾¤ç¯å¢ƒï¼‰
  await pubsub.publish('pricing:cache:invalidate', { ruleId });
}
```

---

## 7. ç‰¹æ®Šåœºæ™¯å¤„ç†

### 7.1 ä¸´æ—¶ä¿ƒé”€å®šä»·

```typescript
/**
 * åœºæ™¯ï¼šåŒåä¸€æ´»åŠ¨ï¼ŒA100-40GB æ‰“8æŠ˜
 */
const promotionRule = {
  id: 'promo-2024-1111',
  scope: 'default',
  resourceType: 'gpu',
  resourceSpec: 'A100-40GB',
  pricePerUnit: 20.0,  // åŸä»· Â¥25.0ï¼Œä¿ƒé”€ä»· Â¥20.0
  unit: 'å¡Â·å°æ—¶',
  billingCycle: 'hourly',
  currency: 'CNY',
  enabled: true,
  effectiveDate: '2024-11-11T00:00:00Z',
  expiryDate: '2024-11-11T23:59:59Z',  // ä»…å½“å¤©æœ‰æ•ˆ
  description: 'åŒåä¸€ä¿ƒé”€æ´»åŠ¨'
};

// æ´»åŠ¨ç»“æŸåè‡ªåŠ¨å¤±æ•ˆï¼Œæ¢å¤åŸä»·
```

### 7.2 æ–°è®¾å¤‡æµ‹è¯•å®šä»·

```typescript
/**
 * åœºæ™¯ï¼šæ–°ä¸Šçº¿çš„A100è®¾å¤‡ï¼Œæä¾›æµ‹è¯•ä¼˜æƒ 
 */
const testingRule = {
  id: 'test-node-new-001',
  scope: 'node',
  scopeId: 'node-new-001',
  resourceType: 'gpu',
  resourceSpec: 'A100-40GB',
  pricePerUnit: 20.0,  // æµ‹è¯•ä»·
  effectiveDate: '2024-12-01T00:00:00Z',
  expiryDate: '2025-01-31T23:59:59Z',  // 2ä¸ªæœˆæµ‹è¯•æœŸ
  description: 'æ–°è®¾å¤‡æµ‹è¯•æœŸä¼˜æƒ ä»·'
};
```

### 7.3 è®¾å¤‡ä¸‹çº¿æ¸…åº“å­˜

```typescript
/**
 * åœºæ™¯ï¼šè€æ—§V100è®¾å¤‡å³å°†ä¸‹çº¿ï¼Œä½ä»·ä¿ƒé”€
 */
const deprecatedRule = {
  id: 'deprecated-node-099',
  scope: 'node',
  scopeId: 'node-099',
  resourceType: 'gpu',
  resourceSpec: 'V100-32GB',
  pricePerUnit: 12.0,  // åŸä»· Â¥18.0ï¼Œæ¸…åº“å­˜ä»· Â¥12.0
  effectiveDate: '2024-12-01T00:00:00Z',
  expiryDate: '2024-12-31T23:59:59Z',  // å¹´åº•ä¸‹çº¿
  description: 'è®¾å¤‡å³å°†ä¸‹çº¿ï¼Œæ¸…åº“å­˜ä¼˜æƒ '
};
```

### 7.4 æ‰¹é‡å®šä»·è°ƒæ•´

```typescript
/**
 * åœºæ™¯ï¼šæˆéƒ½å¯ç”¨åŒºæ‰€æœ‰GPUä»·æ ¼ç»Ÿä¸€ä¸‹è°ƒ10%
 */
async function bulkPriceAdjustment() {
  // 1. æŸ¥è¯¢æ‰€æœ‰ç›¸å…³è§„åˆ™
  const rules = await getPricingRulesByScope('zone', 'zone-001');
  const gpuRules = rules.filter(r => r.resourceType === 'gpu');
  
  // 2. æ‰¹é‡æ›´æ–°
  for (const rule of gpuRules) {
    await savePricingRule({
      ...rule,
      pricePerUnit: rule.pricePerUnit * 0.9,  // ä¸‹è°ƒ10%
      description: `${rule.description} (è°ƒä»·: -10%)`
    });
  }
  
  // 3. è®°å½•å˜æ›´
  await logPriceChange({
    scope: 'zone',
    scopeId: 'zone-001',
    changeType: 'bulk_adjustment',
    changeRate: -0.1,
    reason: 'æˆéƒ½å¯ç”¨åŒºç”µåŠ›æˆæœ¬ä¸‹é™'
  });
}
```

### 7.5 ç”¨æˆ·ç­‰çº§å®šä»·ï¼ˆç»“åˆæŠ˜æ‰£ï¼‰

```typescript
/**
 * åœºæ™¯ï¼šVIPç”¨æˆ·äº«å—é¢å¤–æŠ˜æ‰£
 * æ³¨æ„ï¼šè¿™éƒ¨åˆ†é€»è¾‘åœ¨æŠ˜æ‰£ç³»ç»Ÿä¸­å®ç°ï¼Œä¸åœ¨å®šä»·ç³»ç»Ÿ
 */
async function calculateVIPCost(userId: string, baseCost: number) {
  // 1. æŸ¥è¯¢ç”¨æˆ·ç­‰çº§
  const user = await getUser(userId);
  
  // 2. æŸ¥è¯¢ç”¨æˆ·æŠ˜æ‰£
  let discount = 1.0;
  if (user.level === 'VIP') {
    discount = 0.9;  // 9æŠ˜
  } else if (user.level === 'SVIP') {
    discount = 0.85;  // 85æŠ˜
  }
  
  // 3. åº”ç”¨æŠ˜æ‰£
  const finalCost = baseCost * discount;
  
  return {
    baseCost,
    discount,
    finalCost,
    saved: baseCost - finalCost
  };
}
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **å››çº§åˆ†å±‚å®šä»·**ï¼šdefault â†’ zone â†’ pool â†’ node
2. **è‡ªåŠ¨ç»§æ‰¿æœºåˆ¶**ï¼šç®€åŒ–é…ç½®ï¼Œé™ä½è¿ç»´æˆæœ¬
3. **çµæ´»å·®å¼‚åŒ–**ï¼šæ”¯æŒå„ç§å®šä»·ç­–ç•¥
4. **é«˜æ€§èƒ½æŸ¥è¯¢**ï¼šç¼“å­˜ + ç´¢å¼•ä¼˜åŒ–
5. **å®Œæ•´å®¡è®¡**ï¼šè®°å½•æ‰€æœ‰å˜æ›´å†å²

### æœ€ä½³å®è·µ

- âœ… ä¼˜å…ˆé…ç½®é»˜è®¤å®šä»·ï¼Œä½œä¸ºåŸºå‡†
- âœ… ä»…åœ¨æœ‰å·®å¼‚æ—¶é…ç½®ä¸Šå±‚å®šä»·
- âœ… å®šæœŸå®¡æŸ¥å’Œæ¸…ç†è¿‡æœŸè§„åˆ™
- âœ… ä½¿ç”¨æè¿°å­—æ®µè®°å½•å®šä»·åŸå› 
- âœ… é‡å¤§è°ƒä»·å‰åšå¥½å¤‡ä»½å’Œé€šçŸ¥

### æ‰©å±•æ–¹å‘

- ğŸ”„ æ”¯æŒåŠ¨æ€å®šä»·ï¼ˆåŸºäºè´Ÿè½½ã€æ—¶æ®µï¼‰
- ğŸ“Š ä»·æ ¼è¶‹åŠ¿åˆ†æå’Œä¼˜åŒ–å»ºè®®
- ğŸ¯ æ™ºèƒ½å®šä»·æ¨è
- ğŸ’° æˆæœ¬é¢„æµ‹å’Œé¢„è­¦

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2024-12-06  
**ç»´æŠ¤å›¢é˜Ÿ**: è´¹ç±³é›†ç¾¤å¼€å‘å›¢é˜Ÿ
