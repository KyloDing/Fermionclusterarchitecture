# è´¹ç±³é›†ç¾¤å®šä»·ç³»ç»Ÿæ•°æ®åº“è®¾è®¡æ–‡æ¡£ ğŸ—„ï¸

## ğŸ“‹ ç›®å½•

1. [æ•°æ®åº“æ¶æ„æ¦‚è§ˆ](#1-æ•°æ®åº“æ¶æ„æ¦‚è§ˆ)
2. [æ ¸å¿ƒè¡¨è®¾è®¡](#2-æ ¸å¿ƒè¡¨è®¾è®¡)
3. [è¡¨å…³ç³»å›¾](#3-è¡¨å…³ç³»å›¾)
4. [ç´¢å¼•è®¾è®¡](#4-ç´¢å¼•è®¾è®¡)
5. [è§†å›¾è®¾è®¡](#5-è§†å›¾è®¾è®¡)
6. [å­˜å‚¨è¿‡ç¨‹](#6-å­˜å‚¨è¿‡ç¨‹)
7. [è§¦å‘å™¨è®¾è®¡](#7-è§¦å‘å™¨è®¾è®¡)
8. [å»ºè¡¨æ­¥éª¤](#8-å»ºè¡¨æ­¥éª¤)
9. [æ•°æ®è¿ç§»](#9-æ•°æ®è¿ç§»)
10. [æ€§èƒ½ä¼˜åŒ–](#10-æ€§èƒ½ä¼˜åŒ–)

---

## 1. æ•°æ®åº“æ¶æ„æ¦‚è§ˆ

### 1.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è´¹ç±³é›†ç¾¤å®šä»·ç³»ç»Ÿæ•°æ®åº“æ¶æ„                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  æ ¸å¿ƒä¸šåŠ¡è¡¨ (Core Tables)                        â”‚    â”‚
â”‚  â”‚  â”œâ”€ pricing_rules (å®šä»·è§„åˆ™è¡¨) â˜…â˜…â˜…              â”‚    â”‚
â”‚  â”‚  â”œâ”€ availability_zones (å¯ç”¨åŒºè¡¨)                â”‚    â”‚
â”‚  â”‚  â”œâ”€ resource_pools (èµ„æºæ± è¡¨)                    â”‚    â”‚
â”‚  â”‚  â””â”€ compute_nodes (è®¡ç®—èŠ‚ç‚¹è¡¨)                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  è¾…åŠ©è¡¨ (Supporting Tables)                      â”‚    â”‚
â”‚  â”‚  â”œâ”€ pricing_history (å®šä»·å†å²è¡¨) â˜…               â”‚    â”‚
â”‚  â”‚  â”œâ”€ pricing_cache (å®šä»·ç¼“å­˜è¡¨)                   â”‚    â”‚
â”‚  â”‚  â””â”€ resource_types (èµ„æºç±»å‹å®šä¹‰è¡¨)              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  è§†å›¾ (Views)                                    â”‚    â”‚
â”‚  â”‚  â”œâ”€ v_active_pricing_rules (å½“å‰æœ‰æ•ˆè§„åˆ™)       â”‚    â”‚
â”‚  â”‚  â””â”€ v_pricing_hierarchy (å®šä»·ç»§æ‰¿é“¾)            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  å­˜å‚¨è¿‡ç¨‹ (Stored Procedures)                    â”‚    â”‚
â”‚  â”‚  â””â”€ sp_query_pricing (æŸ¥è¯¢èµ„æºä»·æ ¼)             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â˜… = é‡è¦åº¦ï¼ˆè¶Šå¤šæ˜Ÿè¶Šé‡è¦ï¼‰
```

### 1.2 è¡¨æ•°é‡ç»Ÿè®¡

| ç±»å‹ | æ•°é‡ | è¯´æ˜ |
|------|------|------|
| æ ¸å¿ƒè¡¨ | 4 | pricing_rules, availability_zones, resource_pools, compute_nodes |
| è¾…åŠ©è¡¨ | 3 | pricing_history, pricing_cache, resource_types |
| è§†å›¾ | 2 | v_active_pricing_rules, v_pricing_hierarchy |
| å­˜å‚¨è¿‡ç¨‹ | 1 | sp_query_pricing |
| è§¦å‘å™¨ | 3 | å®šä»·è§„åˆ™å˜æ›´è‡ªåŠ¨è®°å½• |

---

## 2. æ ¸å¿ƒè¡¨è®¾è®¡

### 2.1 å®šä»·è§„åˆ™è¡¨ (pricing_rules) â­â­â­

**ç”¨é€”**ï¼šå­˜å‚¨æ‰€æœ‰èµ„æºçš„å®šä»·è§„åˆ™ï¼Œæ˜¯æ•´ä¸ªå®šä»·ç³»ç»Ÿçš„æ ¸å¿ƒè¡¨ã€‚

#### è¡¨ç»“æ„

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | VARCHAR(64) | PRIMARY KEY | å®šä»·è§„åˆ™å”¯ä¸€æ ‡è¯† |
| scope | VARCHAR(20) | NOT NULL | å®šä»·èŒƒå›´: default/zone/pool/node |
| scope_id | VARCHAR(64) | NULL | èŒƒå›´IDï¼ˆdefaultæ—¶ä¸ºNULLï¼‰ |
| scope_name | VARCHAR(255) | NULL | èŒƒå›´æ˜¾ç¤ºåç§° |
| resource_type | VARCHAR(20) | NOT NULL | èµ„æºç±»å‹: gpu/cpu/memory/storage/network |
| resource_spec | VARCHAR(100) | NULL | èµ„æºè§„æ ¼: A100-40GB, V100ç­‰ |
| price_per_unit | DECIMAL(12,4) | NOT NULL | å•ä»· |
| unit | VARCHAR(50) | NOT NULL | è®¡è´¹å•ä½ |
| billing_cycle | VARCHAR(20) | NOT NULL | è®¡è´¹å‘¨æœŸ: hourly/daily/monthly |
| currency | VARCHAR(10) | DEFAULT 'CNY' | è´§å¸å•ä½ |
| effective_date | TIMESTAMP | NOT NULL | ç”Ÿæ•ˆæ—¥æœŸ |
| expiry_date | TIMESTAMP | NULL | å¤±æ•ˆæ—¥æœŸ |
| enabled | TINYINT(1) | DEFAULT 1 | å¯ç”¨çŠ¶æ€ |
| description | VARCHAR(500) | NULL | æè¿° |
| created_at | TIMESTAMP | NOT NULL | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | æ›´æ–°æ—¶é—´ |
| created_by | VARCHAR(64) | NOT NULL | åˆ›å»ºäººID |
| updated_by | VARCHAR(64) | NULL | æ›´æ–°äººID |

#### ç´¢å¼•è®¾è®¡

```sql
-- ä¸»é”®ç´¢å¼•
PRIMARY KEY (id)

-- å•åˆ—ç´¢å¼•
INDEX idx_scope (scope)
INDEX idx_scope_id (scope_id)
INDEX idx_resource_type (resource_type)
INDEX idx_resource_spec (resource_spec)
INDEX idx_enabled (enabled)
INDEX idx_effective_date (effective_date)
INDEX idx_expiry_date (expiry_date)

-- å¤åˆç´¢å¼•ï¼ˆä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼‰
INDEX idx_scope_resource (scope, resource_type, resource_spec)
INDEX idx_scope_id_resource (scope_id, resource_type, resource_spec)

-- å”¯ä¸€çº¦æŸ
UNIQUE INDEX uk_pricing_rule (scope, scope_id, resource_type, resource_spec, effective_date)
```

#### æ•°æ®ç¤ºä¾‹

```sql
-- é»˜è®¤GPUå®šä»·
INSERT INTO pricing_rules VALUES (
  'default-gpu-a100-40',
  'default',
  NULL,
  NULL,
  'gpu',
  'A100-40GB',
  25.0000,
  'å¡Â·å°æ—¶',
  'hourly',
  'CNY',
  '2024-01-01 00:00:00',
  NULL,
  1,
  'NVIDIA A100 40GBé»˜è®¤ä»·æ ¼',
  '2024-01-01 00:00:00',
  '2024-01-01 00:00:00',
  'system',
  NULL
);

-- å¯ç”¨åŒºGPUå®šä»·ï¼ˆè¦†ç›–é»˜è®¤ï¼‰
INSERT INTO pricing_rules VALUES (
  'zone-gpu-a100-zone001',
  'zone',
  'zone-001',
  'æˆéƒ½å¯ç”¨åŒºA',
  'gpu',
  'A100-40GB',
  23.0000,
  'å¡Â·å°æ—¶',
  'hourly',
  'CNY',
  '2024-01-01 00:00:00',
  NULL,
  1,
  'æˆéƒ½å¯ç”¨åŒºA100ä¼˜æƒ ä»·æ ¼',
  '2024-01-01 00:00:00',
  '2024-01-01 00:00:00',
  'admin',
  NULL
);
```

---

### 2.2 å®šä»·å†å²è¡¨ (pricing_history)

**ç”¨é€”**ï¼šè®°å½•å®šä»·è§„åˆ™çš„æ‰€æœ‰å˜æ›´å†å²ï¼Œç”¨äºå®¡è®¡å’Œå›æº¯ã€‚

#### è¡¨ç»“æ„

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | BIGINT | PRIMARY KEY AUTO_INCREMENT | å†å²è®°å½•ID |
| pricing_rule_id | VARCHAR(64) | NOT NULL | å®šä»·è§„åˆ™ID |
| action_type | VARCHAR(20) | NOT NULL | æ“ä½œç±»å‹: create/update/delete |
| old_data | JSON | NULL | å˜æ›´å‰æ•°æ® |
| new_data | JSON | NOT NULL | å˜æ›´åæ•°æ® |
| change_reason | VARCHAR(500) | NULL | å˜æ›´åŸå›  |
| action_time | TIMESTAMP | NOT NULL | æ“ä½œæ—¶é—´ |
| action_by | VARCHAR(64) | NOT NULL | æ“ä½œäººID |
| action_ip | VARCHAR(50) | NULL | æ“ä½œIPåœ°å€ |

#### ç´¢å¼•è®¾è®¡

```sql
INDEX idx_pricing_rule_id (pricing_rule_id)
INDEX idx_action_type (action_type)
INDEX idx_action_time (action_time)
INDEX idx_action_by (action_by)
```

#### æ•°æ®ç¤ºä¾‹

```sql
INSERT INTO pricing_history VALUES (
  1,
  'default-gpu-a100-40',
  'update',
  '{"price_per_unit": 25.0}',
  '{"price_per_unit": 23.0}',
  'æˆæœ¬ä¸‹é™ï¼Œè°ƒæ•´ä»·æ ¼',
  '2024-12-06 10:00:00',
  'admin-001',
  '192.168.1.100'
);
```

---

### 2.3 å¯ç”¨åŒºè¡¨ (availability_zones)

**ç”¨é€”**ï¼šå®šä¹‰ç³»ç»Ÿä¸­çš„å¯ç”¨åŒºä¿¡æ¯ï¼Œæ”¯æŒæŒ‰åœ°åŸŸå®šä»·ã€‚

#### è¡¨ç»“æ„

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | VARCHAR(64) | PRIMARY KEY | å¯ç”¨åŒºID |
| zone_name | VARCHAR(255) | NOT NULL | å¯ç”¨åŒºåç§° |
| zone_code | VARCHAR(50) | NOT NULL | å¯ç”¨åŒºä»£ç  |
| region | VARCHAR(100) | NOT NULL | åœ°åŸŸ |
| city | VARCHAR(100) | NOT NULL | åŸå¸‚ |
| datacenter | VARCHAR(255) | NULL | æ•°æ®ä¸­å¿ƒåç§° |
| datacenter_level | VARCHAR(20) | NULL | æœºæˆ¿ç­‰çº§ |
| cost_factor | DECIMAL(5,4) | DEFAULT 1.0000 | æˆæœ¬ç³»æ•° |
| status | VARCHAR(20) | DEFAULT 'active' | çŠ¶æ€ |
| enabled | TINYINT(1) | DEFAULT 1 | å¯ç”¨çŠ¶æ€ |
| description | VARCHAR(500) | NULL | æè¿° |
| created_at | TIMESTAMP | NOT NULL | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | æ›´æ–°æ—¶é—´ |

#### æ•°æ®ç¤ºä¾‹

```sql
INSERT INTO availability_zones VALUES (
  'zone-001',
  'æˆéƒ½å¯ç”¨åŒºA',
  'CD-A',
  'è¥¿å—',
  'æˆéƒ½',
  'æˆéƒ½æ•°æ®ä¸­å¿ƒ1',
  'T3',
  0.9200,  -- æˆæœ¬ç³»æ•°0.92ï¼ˆç”µåŠ›ä¾¿å®œï¼‰
  'active',
  1,
  'æˆéƒ½ä¸»è¦å¯ç”¨åŒºï¼Œç”µåŠ›æˆæœ¬ä½',
  '2024-01-01 00:00:00',
  '2024-01-01 00:00:00'
);
```

---

### 2.4 èµ„æºæ± è¡¨ (resource_pools)

**ç”¨é€”**ï¼šå®šä¹‰ç³»ç»Ÿä¸­çš„èµ„æºæ± ä¿¡æ¯ï¼Œæ”¯æŒæŒ‰èµ„æºæ± å®šä»·ã€‚

#### è¡¨ç»“æ„

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | VARCHAR(64) | PRIMARY KEY | èµ„æºæ± ID |
| pool_name | VARCHAR(255) | NOT NULL | èµ„æºæ± åç§° |
| pool_type | VARCHAR(50) | NOT NULL | èµ„æºæ± ç±»å‹ |
| zone_id | VARCHAR(64) | NOT NULL | æ‰€å±å¯ç”¨åŒºID |
| resource_type | VARCHAR(20) | NOT NULL | èµ„æºç±»å‹ |
| resource_specs | JSON | NULL | èµ„æºè§„æ ¼åˆ—è¡¨ |
| total_capacity | INT | DEFAULT 0 | æ€»å®¹é‡ |
| available_capacity | INT | DEFAULT 0 | å¯ç”¨å®¹é‡ |
| performance_level | VARCHAR(20) | NULL | æ€§èƒ½ç­‰çº§ |
| cost_factor | DECIMAL(5,4) | DEFAULT 1.0000 | æˆæœ¬ç³»æ•° |
| status | VARCHAR(20) | DEFAULT 'active' | çŠ¶æ€ |
| enabled | TINYINT(1) | DEFAULT 1 | å¯ç”¨çŠ¶æ€ |
| description | VARCHAR(500) | NULL | æè¿° |
| created_at | TIMESTAMP | NOT NULL | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | æ›´æ–°æ—¶é—´ |

#### å¤–é”®å…³ç³»

```sql
FOREIGN KEY (zone_id) REFERENCES availability_zones(id)
  ON DELETE RESTRICT 
  ON UPDATE CASCADE
```

#### æ•°æ®ç¤ºä¾‹

```sql
INSERT INTO resource_pools VALUES (
  'pool-001',
  'é«˜æ€§èƒ½GPUèµ„æºæ± ',
  'gpu-pool',
  'zone-001',
  'gpu',
  '["A100-40GB", "A100-80GB", "V100-32GB"]',
  100,
  85,
  'high',
  1.1000,  -- æˆæœ¬ç³»æ•°1.1ï¼ˆé«˜æ€§èƒ½ï¼‰
  'active',
  1,
  'é…ç½®NVMeå­˜å‚¨å’Œä¸‡å…†ç½‘ç»œçš„é«˜æ€§èƒ½GPUæ± ',
  '2024-01-01 00:00:00',
  '2024-01-01 00:00:00'
);
```

---

### 2.5 è®¡ç®—èŠ‚ç‚¹è¡¨ (compute_nodes)

**ç”¨é€”**ï¼šå®šä¹‰ç³»ç»Ÿä¸­çš„è®¡ç®—èŠ‚ç‚¹ä¿¡æ¯ï¼Œæ”¯æŒæŒ‰èŠ‚ç‚¹å®šä»·ã€‚

#### è¡¨ç»“æ„

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | VARCHAR(64) | PRIMARY KEY | èŠ‚ç‚¹ID |
| node_name | VARCHAR(255) | NOT NULL | èŠ‚ç‚¹åç§° |
| node_type | VARCHAR(50) | NOT NULL | èŠ‚ç‚¹ç±»å‹ |
| zone_id | VARCHAR(64) | NOT NULL | æ‰€å±å¯ç”¨åŒºID |
| pool_id | VARCHAR(64) | NULL | æ‰€å±èµ„æºæ± ID |
| hardware_config | JSON | NULL | ç¡¬ä»¶é…ç½® |
| gpu_type | VARCHAR(100) | NULL | GPUå‹å· |
| gpu_count | INT | DEFAULT 0 | GPUæ•°é‡ |
| cpu_cores | INT | DEFAULT 0 | CPUæ ¸å¿ƒæ•° |
| memory_gb | INT | DEFAULT 0 | å†…å­˜å¤§å°(GB) |
| storage_gb | INT | DEFAULT 0 | å­˜å‚¨å¤§å°(GB) |
| status | VARCHAR(20) | DEFAULT 'active' | çŠ¶æ€ |
| health_status | VARCHAR(20) | DEFAULT 'healthy' | å¥åº·çŠ¶æ€ |
| enabled | TINYINT(1) | DEFAULT 1 | å¯ç”¨çŠ¶æ€ |
| cost_factor | DECIMAL(5,4) | DEFAULT 1.0000 | æˆæœ¬ç³»æ•° |
| is_new | TINYINT(1) | DEFAULT 0 | æ˜¯å¦æ–°è®¾å¤‡ |
| is_deprecated | TINYINT(1) | DEFAULT 0 | æ˜¯å¦å³å°†ä¸‹çº¿ |
| description | VARCHAR(500) | NULL | æè¿° |
| created_at | TIMESTAMP | NOT NULL | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | æ›´æ–°æ—¶é—´ |

#### å¤–é”®å…³ç³»

```sql
FOREIGN KEY (zone_id) REFERENCES availability_zones(id)
  ON DELETE RESTRICT 
  ON UPDATE CASCADE

FOREIGN KEY (pool_id) REFERENCES resource_pools(id)
  ON DELETE RESTRICT 
  ON UPDATE CASCADE
```

#### æ•°æ®ç¤ºä¾‹

```sql
INSERT INTO compute_nodes VALUES (
  'node-001',
  'GPU-Node-001',
  'gpu-node',
  'zone-001',
  'pool-001',
  '{"cpu": "Intel Xeon Gold 6248R", "memory": "DDR4-3200", "storage": "NVMe SSD"}',
  'A100-40GB',
  8,
  64,
  512,
  2000,
  'active',
  'healthy',
  1,
  1.0000,
  1,  -- æ–°è®¾å¤‡
  0,
  'æ–°ä¸Šçº¿çš„8å¡A100èŠ‚ç‚¹',
  '2024-12-01 00:00:00',
  '2024-12-01 00:00:00'
);
```

---

## 3. è¡¨å…³ç³»å›¾

### 3.1 ERå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  availability_zones    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  PK: id                â”‚
â”‚  zone_name             â”‚
â”‚  region                â”‚
â”‚  cost_factor           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ 1
            â”‚
            â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  resource_pools        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  PK: id                â”‚
â”‚  FK: zone_id           â”‚
â”‚  pool_name             â”‚
â”‚  performance_level     â”‚
â”‚  cost_factor           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ 1
            â”‚
            â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  compute_nodes         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  PK: id                â”‚
â”‚  FK: zone_id           â”‚
â”‚  FK: pool_id           â”‚
â”‚  node_name             â”‚
â”‚  gpu_type              â”‚
â”‚  cost_factor           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  pricing_rules         â”‚â—€â”€â”€â”€â”€â”
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚     â”‚
â”‚  PK: id                â”‚     â”‚
â”‚  scope                 â”‚     â”‚ 1
â”‚  scope_id              â”‚     â”‚
â”‚  resource_type         â”‚     â”‚
â”‚  price_per_unit        â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
             â”‚ 1                â”‚
             â”‚                  â”‚
             â”‚ N                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  pricing_history       â”‚â”€â”€â”€â”€â”€â”˜
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ N
â”‚  PK: id                â”‚
â”‚  FK: pricing_rule_id   â”‚
â”‚  action_type           â”‚
â”‚  old_data              â”‚
â”‚  new_data              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å…³ç³»è¯´æ˜

| å…³ç³» | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| availability_zones â†’ resource_pools | 1:N | ä¸€ä¸ªå¯ç”¨åŒºåŒ…å«å¤šä¸ªèµ„æºæ±  |
| availability_zones â†’ compute_nodes | 1:N | ä¸€ä¸ªå¯ç”¨åŒºåŒ…å«å¤šä¸ªè®¡ç®—èŠ‚ç‚¹ |
| resource_pools â†’ compute_nodes | 1:N | ä¸€ä¸ªèµ„æºæ± åŒ…å«å¤šä¸ªè®¡ç®—èŠ‚ç‚¹ |
| pricing_rules â†’ pricing_history | 1:N | ä¸€ä¸ªå®šä»·è§„åˆ™æœ‰å¤šæ¡å†å²è®°å½• |

---

## 4. ç´¢å¼•è®¾è®¡

### 4.1 ç´¢å¼•ç­–ç•¥

#### ä¸»é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰

```sql
-- æ‰€æœ‰è¡¨çš„ä¸»ï¿½ï¿½éƒ½ä¼šè‡ªåŠ¨åˆ›å»ºä¸»é”®ç´¢å¼•
PRIMARY KEY (id)
```

#### å•åˆ—ç´¢å¼•

```sql
-- pricing_rulesè¡¨
CREATE INDEX idx_scope ON pricing_rules(scope);
CREATE INDEX idx_resource_type ON pricing_rules(resource_type);
CREATE INDEX idx_enabled ON pricing_rules(enabled);

-- availability_zonesè¡¨
CREATE INDEX idx_region ON availability_zones(region);
CREATE INDEX idx_status ON availability_zones(status);

-- resource_poolsè¡¨
CREATE INDEX idx_pool_type ON resource_pools(pool_type);
CREATE INDEX idx_performance_level ON resource_pools(performance_level);

-- compute_nodesè¡¨
CREATE INDEX idx_gpu_type ON compute_nodes(gpu_type);
CREATE INDEX idx_is_new ON compute_nodes(is_new);
```

#### å¤åˆç´¢å¼•

```sql
-- pricing_rulesè¡¨ï¼ˆä¼˜åŒ–å®šä»·æŸ¥è¯¢ï¼‰
CREATE INDEX idx_scope_resource 
ON pricing_rules(scope, resource_type, resource_spec);

CREATE INDEX idx_scope_id_resource 
ON pricing_rules(scope_id, resource_type, resource_spec);

-- å…¨è¦†ç›–ç´¢å¼•ï¼ˆç»ˆæä¼˜åŒ–ï¼‰
CREATE INDEX idx_pricing_rules_full 
ON pricing_rules(
  scope, 
  scope_id, 
  resource_type, 
  resource_spec, 
  enabled, 
  effective_date, 
  expiry_date
);
```

#### å”¯ä¸€ç´¢å¼•

```sql
-- pricing_rulesè¡¨ï¼ˆé˜²æ­¢é‡å¤å®šä»·è§„åˆ™ï¼‰
CREATE UNIQUE INDEX uk_pricing_rule 
ON pricing_rules(
  scope, 
  scope_id, 
  resource_type, 
  resource_spec, 
  effective_date
);
```

### 4.2 ç´¢å¼•é€‰æ‹©å»ºè®®

| æŸ¥è¯¢åœºæ™¯ | ä½¿ç”¨ç´¢å¼• | è¯´æ˜ |
|----------|----------|------|
| æŒ‰scopeæŸ¥è¯¢ | idx_scope | æŸ¥çœ‹æŸä¸ªå±‚çº§çš„æ‰€æœ‰è§„åˆ™ |
| æŒ‰èµ„æºç±»å‹æŸ¥è¯¢ | idx_resource_type | æŸ¥çœ‹GPU/CPUç­‰æ‰€æœ‰è§„åˆ™ |
| å®šä»·æŸ¥è¯¢ | idx_scope_resource | æ ¸å¿ƒæŸ¥è¯¢ï¼Œä½¿ç”¨æœ€é¢‘ç¹ |
| å…¨è¡¨æ‰«æ | idx_pricing_rules_full | å¤æ‚æŸ¥è¯¢ä¼˜åŒ– |

---

## 5. è§†å›¾è®¾è®¡

### 5.1 å½“å‰æœ‰æ•ˆå®šä»·è§„åˆ™è§†å›¾

```sql
CREATE VIEW v_active_pricing_rules AS
SELECT 
    pr.*,
    az.zone_name,
    az.region,
    rp.pool_name,
    rp.performance_level,
    cn.node_name,
    cn.gpu_type,
    rt.resource_name,
    rt.category
FROM pricing_rules pr
LEFT JOIN availability_zones az 
  ON pr.scope = 'zone' AND pr.scope_id = az.id
LEFT JOIN resource_pools rp 
  ON pr.scope = 'pool' AND pr.scope_id = rp.id
LEFT JOIN compute_nodes cn 
  ON pr.scope = 'node' AND pr.scope_id = cn.id
LEFT JOIN resource_types rt 
  ON pr.resource_type = rt.resource_type 
  AND pr.resource_spec = rt.resource_spec
WHERE pr.enabled = 1
  AND pr.effective_date <= NOW()
  AND (pr.expiry_date IS NULL OR pr.expiry_date > NOW());
```

**ç”¨é€”**ï¼šæŸ¥è¯¢å½“å‰ç”Ÿæ•ˆçš„æ‰€æœ‰å®šä»·è§„åˆ™ï¼ŒåŒ…å«å…³è”ä¿¡æ¯ã€‚

### 5.2 å®šä»·ç»§æ‰¿é“¾è§†å›¾

```sql
CREATE VIEW v_pricing_hierarchy AS
SELECT 
    cn.id AS node_id,
    cn.node_name,
    rp.id AS pool_id,
    rp.pool_name,
    az.id AS zone_id,
    az.zone_name,
    cn.gpu_type AS resource_spec,
    'gpu' AS resource_type,
    -- å®é™…åº”ç”¨çš„ä»·æ ¼ï¼ˆCOALESCEå®ç°ç»§æ‰¿ï¼‰
    COALESCE(
        (SELECT price_per_unit FROM pricing_rules 
         WHERE scope='node' AND scope_id=cn.id 
         AND resource_type='gpu' AND resource_spec=cn.gpu_type 
         AND enabled=1 AND effective_date <= NOW() 
         AND (expiry_date IS NULL OR expiry_date > NOW())
         LIMIT 1),
        (SELECT price_per_unit FROM pricing_rules 
         WHERE scope='pool' AND scope_id=rp.id 
         AND resource_type='gpu' AND resource_spec=cn.gpu_type 
         AND enabled=1 AND effective_date <= NOW() 
         AND (expiry_date IS NULL OR expiry_date > NOW())
         LIMIT 1),
        (SELECT price_per_unit FROM pricing_rules 
         WHERE scope='zone' AND scope_id=az.id 
         AND resource_type='gpu' AND resource_spec=cn.gpu_type 
         AND enabled=1 AND effective_date <= NOW() 
         AND (expiry_date IS NULL OR expiry_date > NOW())
         LIMIT 1),
        (SELECT price_per_unit FROM pricing_rules 
         WHERE scope='default' 
         AND resource_type='gpu' AND resource_spec=cn.gpu_type 
         AND enabled=1 AND effective_date <= NOW() 
         AND (expiry_date IS NULL OR expiry_date > NOW())
         LIMIT 1)
    ) AS applied_price
FROM compute_nodes cn
LEFT JOIN resource_pools rp ON cn.pool_id = rp.id
LEFT JOIN availability_zones az ON cn.zone_id = az.id
WHERE cn.enabled = 1 AND cn.gpu_type IS NOT NULL;
```

**ç”¨é€”**ï¼šå¯è§†åŒ–å±•ç¤ºæ¯ä¸ªèŠ‚ç‚¹çš„å®šä»·ç»§æ‰¿å…³ç³»ã€‚

---

## 6. å­˜å‚¨è¿‡ç¨‹

### 6.1 æŸ¥è¯¢èµ„æºä»·æ ¼å­˜å‚¨è¿‡ç¨‹

```sql
DELIMITER //

CREATE PROCEDURE sp_query_pricing(
    IN p_resource_type VARCHAR(20),
    IN p_resource_spec VARCHAR(100),
    IN p_zone_id VARCHAR(64),
    IN p_pool_id VARCHAR(64),
    IN p_node_id VARCHAR(64),
    IN p_query_date TIMESTAMP
)
BEGIN
    -- å®ç°å®šä»·ç»§æ‰¿é€»è¾‘
    -- è¯¦è§ pricing_database_schema.sql
END //

DELIMITER ;
```

**ç”¨é€”**ï¼šå®ç°å®šä»·æŸ¥è¯¢çš„æ ¸å¿ƒé€»è¾‘ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½ã€‚

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```sql
CALL sp_query_pricing(
  'gpu',
  'A100-40GB',
  'zone-001',
  'pool-001',
  'node-001',
  NOW()
);
```

---

## 7. è§¦å‘å™¨è®¾è®¡

### 7.1 è‡ªåŠ¨è®°å½•å˜æ›´å†å²

```sql
-- æ’å…¥è§¦å‘å™¨
CREATE TRIGGER trg_pricing_rules_after_insert
AFTER INSERT ON pricing_rules
FOR EACH ROW
BEGIN
    INSERT INTO pricing_history (
        pricing_rule_id,
        action_type,
        new_data,
        action_by
    ) VALUES (
        NEW.id,
        'create',
        JSON_OBJECT(...),
        NEW.created_by
    );
END;

-- æ›´æ–°è§¦å‘å™¨
CREATE TRIGGER trg_pricing_rules_after_update
AFTER UPDATE ON pricing_rules
FOR EACH ROW
BEGIN
    INSERT INTO pricing_history (
        pricing_rule_id,
        action_type,
        old_data,
        new_data,
        action_by
    ) VALUES (
        NEW.id,
        'update',
        JSON_OBJECT(...),  -- OLD data
        JSON_OBJECT(...),  -- NEW data
        NEW.updated_by
    );
END;

-- åˆ é™¤è§¦å‘å™¨
CREATE TRIGGER trg_pricing_rules_before_delete
BEFORE DELETE ON pricing_rules
FOR EACH ROW
BEGIN
    INSERT INTO pricing_history (
        pricing_rule_id,
        action_type,
        old_data,
        action_by
    ) VALUES (
        OLD.id,
        'delete',
        JSON_OBJECT(...),
        OLD.created_by
    );
END;
```

**ç”¨é€”**ï¼šè‡ªåŠ¨è®°å½•æ‰€æœ‰å®šä»·è§„åˆ™çš„å˜æ›´ï¼Œæ— éœ€åº”ç”¨å±‚å¤„ç†ã€‚

---

## 8. å»ºè¡¨æ­¥éª¤

### 8.1 æ‰§è¡Œé¡ºåº

```bash
# 1. è¿æ¥æ•°æ®åº“
mysql -u root -p fermi_cluster

# 2. æ‰§è¡Œå»ºè¡¨è„šæœ¬
source /docs/database/pricing_database_schema.sql

# 3. éªŒè¯è¡¨ç»“æ„
SHOW TABLES;
DESC pricing_rules;

# 4. éªŒè¯è§†å›¾
SHOW FULL TABLES WHERE Table_type = 'VIEW';

# 5. éªŒè¯å­˜å‚¨è¿‡ç¨‹
SHOW PROCEDURE STATUS WHERE Db = 'fermi_cluster';

# 6. éªŒè¯è§¦å‘å™¨
SHOW TRIGGERS;

# 7. æ’å…¥åˆå§‹æ•°æ®ï¼ˆå·²åŒ…å«åœ¨è„šæœ¬ä¸­ï¼‰
SELECT COUNT(*) FROM pricing_rules;
```

### 8.2 åˆ†æ­¥å»ºè¡¨ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦åˆ†æ­¥æ‰§è¡Œï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºï¼š

```sql
-- Step 1: åˆ›å»ºåŸºç¡€è¡¨
CREATE TABLE availability_zones (...);
CREATE TABLE resource_types (...);

-- Step 2: åˆ›å»ºå…³è”è¡¨
CREATE TABLE resource_pools (...);
CREATE TABLE compute_nodes (...);

-- Step 3: åˆ›å»ºæ ¸å¿ƒè¡¨
CREATE TABLE pricing_rules (...);
CREATE TABLE pricing_history (...);
CREATE TABLE pricing_cache (...);

-- Step 4: åˆ›å»ºè§†å›¾
CREATE VIEW v_active_pricing_rules AS ...;
CREATE VIEW v_pricing_hierarchy AS ...;

-- Step 5: åˆ›å»ºå­˜å‚¨è¿‡ç¨‹
CREATE PROCEDURE sp_query_pricing (...);

-- Step 6: åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER trg_pricing_rules_after_insert ...;
CREATE TRIGGER trg_pricing_rules_after_update ...;
CREATE TRIGGER trg_pricing_rules_before_delete ...;

-- Step 7: æ’å…¥åˆå§‹æ•°æ®
INSERT INTO pricing_rules VALUES (...);
```

---

## 9. æ•°æ®è¿ç§»

### 9.1 ä»æ—§è¡¨è¿ç§»åˆ°æ–°è¡¨

```sql
-- å‡è®¾æ—§è¡¨åä¸º old_pricing
INSERT INTO pricing_rules (
  id,
  scope,
  resource_type,
  resource_spec,
  price_per_unit,
  unit,
  billing_cycle,
  currency,
  enabled,
  description,
  created_at,
  updated_at,
  created_by
)
SELECT 
  CONCAT('migrated-', old_id),
  'default',  -- æ—§æ•°æ®ç»Ÿä¸€è®¾ä¸ºé»˜è®¤å®šä»·
  resource_type,
  resource_name,
  price,
  unit,
  'hourly',
  'CNY',
  1,
  notes,
  create_time,
  update_time,
  'migration'
FROM old_pricing;
```

### 9.2 æ•°æ®éªŒè¯

```sql
-- æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
SELECT scope, COUNT(*) 
FROM pricing_rules 
GROUP BY scope;

-- æ£€æŸ¥ä»·æ ¼èŒƒå›´
SELECT 
  resource_type,
  MIN(price_per_unit) AS min_price,
  MAX(price_per_unit) AS max_price,
  AVG(price_per_unit) AS avg_price
FROM pricing_rules
GROUP BY resource_type;
```

---

## 10. æ€§èƒ½ä¼˜åŒ–

### 10.1 æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

```sql
-- 1. ä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢
EXPLAIN SELECT * FROM pricing_rules 
WHERE scope = 'zone' 
  AND scope_id = 'zone-001' 
  AND resource_type = 'gpu';

-- 2. ç¡®ä¿ç´¢å¼•è¢«ä½¿ç”¨
SHOW INDEX FROM pricing_rules;

-- 3. ä¼˜åŒ–æ…¢æŸ¥è¯¢
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—
SHOW VARIABLES LIKE 'slow_query_log%';
```

### 10.2 è¡¨ä¼˜åŒ–

```sql
-- åˆ†æè¡¨
ANALYZE TABLE pricing_rules;

-- ä¼˜åŒ–è¡¨
OPTIMIZE TABLE pricing_rules;

-- æ£€æŸ¥è¡¨
CHECK TABLE pricing_rules;

-- ä¿®å¤è¡¨
REPAIR TABLE pricing_rules;
```

### 10.3 å®šæœŸç»´æŠ¤ä»»åŠ¡

```sql
-- æ¸…ç†è¿‡æœŸç¼“å­˜
DELETE FROM pricing_cache 
WHERE expires_at < NOW();

-- å½’æ¡£å†å²æ•°æ®ï¼ˆä¿ç•™æœ€è¿‘1å¹´ï¼‰
DELETE FROM pricing_history 
WHERE action_time < DATE_SUB(NOW(), INTERVAL 1 YEAR);

-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE TABLE pricing_rules;
ANALYZE TABLE pricing_history;
```

---

## ğŸ“ æ€»ç»“

### å»ºè¡¨æ£€æŸ¥æ¸…å•

- [ ] æ‰§è¡Œå®Œæ•´çš„å»ºè¡¨è„šæœ¬
- [ ] éªŒè¯æ‰€æœ‰è¡¨å·²åˆ›å»º
- [ ] éªŒè¯ç´¢å¼•å·²åˆ›å»º
- [ ] éªŒè¯å¤–é”®å…³ç³»æ­£ç¡®
- [ ] éªŒè¯è§†å›¾å¯ç”¨
- [ ] éªŒè¯å­˜å‚¨è¿‡ç¨‹å¯ç”¨
- [ ] éªŒè¯è§¦å‘å™¨å¯ç”¨
- [ ] æ’å…¥åˆå§‹æµ‹è¯•æ•°æ®
- [ ] æ‰§è¡Œæµ‹è¯•æŸ¥è¯¢
- [ ] é…ç½®å¤‡ä»½ç­–ç•¥

### ç»´æŠ¤æ¸…å•

- [ ] å®šæœŸæ¸…ç†ç¼“å­˜è¡¨
- [ ] å®šæœŸå½’æ¡£å†å²æ•°æ®
- [ ] å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
- [ ] ç›‘æ§æ…¢æŸ¥è¯¢
- [ ] å®šæœŸå¤‡ä»½æ•°æ®åº“

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2024-12-06  
**ç»´æŠ¤å›¢é˜Ÿ**: è´¹ç±³é›†ç¾¤å¼€å‘å›¢é˜Ÿ
