# 政府算力券支付集成文档

## 功能概述

已成功将政府算力券管理系统与订单支付流程深度集成，实现了算力券自动抵扣功能。用户在支付订单时可以使用政府算力券进行抵扣，系统会智能选择最优的算力券组合。

## 核心功能

### 1. 智能算力券选择
- **自动匹配**：根据订单类型自动筛选可用算力券
- **智能排序**：
  - 优先使用快到期的算力券（30天内到期）
  - 按到期时间排序（快到期的优先）
  - 余额充足的算力券优先
- **手动调整**：用户可以手动选择/取消算力券

### 2. 算力券抵扣计算
- **自动计算**：实时计算选中算力券的总抵扣金额
- **余额显示**：显示每张算力券的可用余额
- **最终金额**：计算并显示扣除算力券后的实付金额
- **完全抵扣**：支持算力券完全抵扣订单金额（实付¥0.00）

### 3. 支付流程
- **订单详情**：在订单详情页面，未支付订单显示"立即支付"按钮
- **支付对话框**：点击支付后打开支付对话框，显示算力券选择界面
- **确认支付**：确认后提交支付，自动记录算力券使用情况
- **支付反馈**：支付成功后显示使用的算力券数量和抵扣金额

## 技术实现

### 新增文件

#### 1. `/services/voucherService.ts`
算力券服务，提供以下功能：

**主要接口：**
```typescript
// 获取可用于支付的算力券
getAvailableVouchers(orderType: string): Promise<Voucher[]>

// 计算算力券抵扣金额
calculateVoucherDeduction(
  vouchers: Voucher[], 
  orderAmount: number
): {
  totalDeduction: number;
  voucherUsages: { voucherId: string; amount: number }[];
  remainingAmount: number;
}

// 使用算力券支付
payWithVouchers(
  orderId: string,
  voucherUsages: { voucherId: string; amount: number }[]
): Promise<{ success: boolean; message: string }>

// 获取算力券使用记录
getVoucherUsageRecords(voucherId?: string): Promise<VoucherUsageRecord[]>
```

**智能筛选逻辑：**
- 过滤状态为 `active` 的算力券
- 过滤余额 > 0 的算力券
- 匹配订单类型（适用范围）
- 过滤未过期的算力券
- 按到期时间和余额排序

#### 2. `/components/PaymentDialog.tsx`
支付对话框组件，提供完整的支付界面：

**核心特性：**
- 显示订单基本信息和金额
- 自动加载可用算力券
- 智能自动选择算力券
- 支持手动选择/取消算力券
- 实时计算抵扣金额
- 显示支付汇总（原价、抵扣、实付）
- 完全抵扣提示
- 支付确认和反馈

**UI 设计：**
- 渐变背景卡片显示订单信息
- 表格形式展示可用算力券
- 复选框支持多选
- 快到期算力券警告标识
- 算力券分类标签（国家级/省级/市级/专项）
- 实时金额计算展示

### 修改文件

#### 1. `/components/OrderDetailsDialog.tsx`
- 导入 `PaymentDialog` 组件
- 添加支付对话框状态管理
- 为"立即支付"按钮添加点击事件
- 集成支付对话框显示逻辑

#### 2. `/services/orderService.ts`
- 添加3个未支付订单用于测试：
  - `order-011`: 训练任务订单（¥2,550.00）
  - `order-012`: 容器实例订单（¥1,280.00）
  - `order-013`: GPU算力包订单（¥6,720.00）

## 使用流程

### 用户操作流程

1. **进入订单管理**
   - 导航到"费用中心 - 订单管理"
   - 查看订单列表

2. **选择未支付订单**
   - 点击订单右侧的"查看"按钮（眼睛图标）
   - 进入订单详情对话框

3. **发起支付**
   - 在订单详情底部点击"立即支付"按钮
   - 打开支付对话框

4. **选择算力券**
   - 系统自动加载并智能选择可用算力券
   - 查看每张算力券的信息（名称、余额、有效期等）
   - 可手动调整选择的算力券
   - 点击"智能选择"按钮重新自动选择

5. **确认支付**
   - 查看支付汇总（原价、抵扣、实付）
   - 点击"确认支付"按钮
   - 等待支付完成

6. **支付完成**
   - 查看支付成功提示
   - 自动关闭对话框
   - 订单状态更新

### 测试场景

#### 场景1：完全抵扣
- 订单金额：¥2,550.00
- 可用算力券总额：¥234,500.00
- 选择算力券后实付：¥0.00
- 验证完全抵扣提示显示

#### 场景2：部分抵扣
- 手动取消部分算力券
- 验证实付金额计算正确
- 验证支付按钮显示实付金额

#### 场景3：快到期提醒
- 查看有效期在30天内的算力券
- 验证橙色警告标签显示
- 验证自动优先选择快到期算力券

#### 场景4：分类显示
- 验证国家级/省级/市级/专项标签
- 验证不同分类的颜色区分

## 数据流

```
订单详情
    ↓ (点击立即支付)
支付对话框打开
    ↓ (加载算力券)
voucherService.getAvailableVouchers()
    ↓ (筛选并排序)
显示可用算力券列表
    ↓ (智能自动选择)
选中推荐的算力券
    ↓ (用户调整选择)
重新计算抵扣金额
    ↓ (点击确认支付)
voucherService.payWithVouchers()
    ↓ (支付成功)
显示成功提示 + 关闭对话框
    ↓
刷新订单列表
```

## 算力券匹配规则

### 适用范围映射

| 订单类型 | 算力券适用范围 | 说明 |
|---------|--------------|------|
| training | training | 训练任务专用 |
| inference | inference | 推理服务专用 |
| instance | instance | 容器实例专用 |
| gpu | gpu | GPU算力包专用 |
| storage | storage | 存储服务专用 |

### 智能选择算法

```typescript
1. 过滤可用算力券
   - 状态 = active
   - 余额 > 0
   - 适用范围匹配订单类型
   - 未过期

2. 排序优先级
   a. 30天内到期的算力券优先（按到期时间从早到晚）
   b. 其他算力券按余额从大到小排序

3. 自动选择
   - 从第一张开始选择
   - 累计抵扣金额直到覆盖订单金额
   - 如果所有算力券都不够，全部选中
```

## UI/UX 特性

### 视觉设计
- **主色调**：紫色（#7C3AED）+ 蓝色（#3B82F6）
- **渐变背景**：订单信息卡片使用 purple-50 到 blue-50 渐变
- **分类颜色**：
  - 国家级：红色 (red-50/700)
  - 省级：蓝色 (blue-50/700)
  - 市级：绿色 (green-50/700)
  - 专项：紫色 (purple-50/700)

### 交互设计
- **智能提示**：快到期算力券显示橙色警告
- **实时反馈**：选择/取消算力券立即更新金额
- **加载状态**：显示加载动画
- **空状态**：无可用算力券时显示引导文案
- **成功反馈**：Toast 提示支付成功和抵扣详情

### 响应式布局
- 支付对话框最大宽度 900px
- 表格在小屏幕上可横向滚动
- 最大高度 90vh，内容可滚动

## 后续优化建议

### 功能增强
1. **算力券推荐**：根据订单类型和金额推荐最优算力券组合
2. **余额不足提醒**：当算力券余额不足以完全抵扣时，提示用户申请更多算力券
3. **使用历史**：在支付对话框中显示该订单类型的算力券使用历史
4. **批量支付**：支持选择多个订单批量支付

### 性能优化
1. **缓存算力券列表**：避免重复加载
2. **懒加载**：大量算力券时使用虚拟滚动
3. **并发请求**：并行加载订单和算力券信息

### 安全性
1. **金额校验**：后端验证抵扣金额是否有效
2. **券状态校验**：支付时再次验证算力券是否可用
3. **并发控制**：防止同一算力券被多个订单同时使用

## 集成检查清单

- [x] 创建算力券服务 (voucherService.ts)
- [x] 创建支付对话框组件 (PaymentDialog.tsx)
- [x] 更新订单详情对话框集成支付功能
- [x] 添加未支付订单测试数据
- [x] 实现智能算力券选择算法
- [x] 实现抵扣金额计算逻辑
- [x] 实现支付流程和成功反馈
- [x] 添加快到期提醒
- [x] 添加完全抵扣提示
- [x] 支持手动调整算力券选择
- [x] 优化 UI/UX 设计
- [x] 编写集成文档

## 相关文档

- [政府算力券管理指南](/GOVERNMENT_VOUCHERS_GUIDE.md)
- [订单管理系统](/components/pages/OrdersPage.tsx)
- [算力券管理页面](/components/pages/GovernmentVouchersPage.tsx)

## 技术栈

- **前端框架**：React + TypeScript
- **UI 组件**：shadcn/ui
- **状态管理**：React Hooks (useState, useEffect)
- **样式**：Tailwind CSS v4.0
- **图标**：Lucide React
- **通知**：Sonner Toast

## 版本信息

- **功能版本**：v1.0
- **集成日期**：2024-11-27
- **最后更新**：2024-11-27
