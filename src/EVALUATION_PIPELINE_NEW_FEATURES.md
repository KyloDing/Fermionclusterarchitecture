# 模型评测与 Pipeline 编排 - 新功能发布

## 🎉 新功能概览

**发布日期**: 2024-11-14  
**版本**: v1.1  
**状态**: ✅ 已完成

已成功实现两大交互式功能：
1. **创建评测任务对话框** - 5步引导式创建流程
2. **Pipeline 可视化编辑器** - 拖拽式流程设计工具

---

## 📦 新增文件清单

```
/components/dialogs/
└── CreateEvaluationDialog.tsx        ✅ 创建评测任务对话框

/components/
└── PipelineEditor.tsx                ✅ Pipeline 可视化编辑器

/components/pages/
└── PipelineEditorPage.tsx            ✅ Pipeline 编辑器页面

更新文件:
├── /components/pages/ModelEvaluationPage.tsx      ✅ 集成创建对话框
├── /components/pages/PipelineOrchestrationPage.tsx ✅ 添加编辑器入口
└── /App.tsx                                        ✅ 添加新路由
```

---

## 🎯 功能 1: 创建评测任务对话框

### 特性总览

✨ **5步引导式流程** - 循序渐进，降低使用门槛  
✨ **类型化表单** - 根据评测类型动态调整选项  
✨ **实时验证** - 每步验证必填项，提示错误  
✨ **资源预览** - 实时预览配置和预估成本  
✨ **响应式设计** - 适配各种屏幕尺寸

### 使用流程

#### 步骤 1: 选择评测类型

**三种评测类型**：

```
┌─────────────┬─────────────┬─────────────┐
│ ⚡ 基准评测  │ 📈 自定义评测 │ 🔄 对比评测  │
├─────────────┼─────────────┼─────────────┤
│ 使用标准数据集│ 自定义数据集 │ 多模型对比   │
│ 进行能力测试 │ 和评测指标   │ 横向测试     │
└─────────────┴─────────────┴─────────────┘
```

**基本信息**：
- 任务名称（必填）
- 任务描述（可选）

**示例**：
```
任务名称: Qwen2-7B 综合能力评测
描述: 评估 Qwen2-7B 在中英文理解、代码生成和数学推理方面的能力
```

#### 步骤 2: 选择模型

**主模型选择**：
- 从模型仓库选择
- 显示模型名称和版本
- 支持多个版本

**可用模型示例**：
```
• Qwen2-7B-Instruct v1.0
• GLM-4-9B v1.0
• Llama-3-8B-Instruct v1.0
• ChatGLM3-6B v2.0
• Baichuan2-13B-Chat v1.0
```

**对比评测专属**：
- 添加多个对比模型
- 显示对比模型列表
- 支持移除对比模型

**界面**：
```
┌────────────────────────────────────┐
│ 选择主模型 *                        │
│ [下拉选择: Qwen2-7B-Instruct v1.0] │
│                                    │
│ 已选择: Qwen2-7B-Instruct v1.0    │
└────────────────────────────────────┘

添加对比模型 (仅对比评测)
┌────────────────────────────────────┐
│ [下拉选择模型]                      │
│                                    │
│ 对比模型列表:                       │
│ • GLM-4-9B v1.0          [删除]   │
│ • Llama-3-8B v1.0        [删除]   │
└────────────────────────────────────┘
```

#### 步骤 3: 选择数据集与指标

**数据集选择**（多选）：

```
┌──────────────────────────────────────────┐
│ ☑ MMLU                                   │
│   大规模多任务语言理解                    │
│   15,908 样本 | 256MB                    │
│   [benchmark] [reasoning] [knowledge]    │
├──────────────────────────────────────────┤
│ ☑ C-Eval                                 │
│   中文综合能力评估基准，覆盖52个学科      │
│   13,948 样本 | 198MB                    │
│   [benchmark] [chinese] [reasoning]      │
├──────────────────────────────────────────┤
│ ☑ HumanEval                              │
│   Python代码生成能力评估                 │
│   164 样本 | 12MB                        │
│   [coding] [benchmark]                   │
└──────────────────────────────────────────┘
```

**评测指标选择**（多选）：

```
┌────────────────┬────────────────┐
│ ☑ 准确率       │ ☑ BLEU Score  │
│   模型预测正确  │   机器翻译质量 │
│   [质量]       │   [质量]      │
├────────────────┼────────────────┤
│ ☑ 推理延迟     │ ☑ 吞吐量      │
│   单次推理延迟  │   每秒请求数   │
│   [性能]       │   [性能]      │
├────────────────┼────────────────┤
│ □ 毒性检测     │ □ 偏见检测    │
│   生成内容毒性  │   输出偏见程度 │
│   [安全]       │   [安全]      │
└────────────────┴────────────────┘
```

#### 步骤 4: 评测配置

**模型参数配置**：

```
批处理大小
├─────────────────────┤
1              16             32
            [  8  ]

Temperature
├─────────────────────┤
0.0            1.0           2.0
          [ 0.7 ]

控制输出的随机性，值越大越随机
```

**详细参数**：
- **批处理大小**: 1-32（默认 8）
- **Temperature**: 0.0-2.0（默认 0.7）
- **最大 Token 数**: 128-8192（默认 2048）
- **Top-P**: 0.0-1.0（默认 0.9）
- **Top-K**: 1-100（默认 50）

#### 步骤 5: 计算资源

**资源配置**：

```
GPU 型号
[NVIDIA A100 ▼]

GPU 数量
├─────────────────────┤
1                      8
    [  1  ] 张

内存 (GB)
├─────────────────────┤
16                    256
      [ 40 ] GB

存储 (GB)
├─────────────────────┤
50                    500
      [ 100 ] GB
```

**资源预览**：
```
┌─────────────────────────────────┐
│ 资源配置预览                     │
├─────────────────────────────────┤
│ GPU:      1x NVIDIA A100        │
│ 内存:     40 GB                 │
│ 存储:     100 GB                │
├─────────────────────────────────┤
│ 预估成本: ¥35.00/小时           │
└─────────────────────────────────┘
```

**成本计算公式**：
```
成本 = GPU数量 × 15 + 内存GB × 0.5
```

### 步骤导航

**顶部进度指示器**：
```
┌────────────────────────────────────────────────────────┐
│  ●━━━━━━━━○━━━━━━━━○━━━━━━━━○━━━━━━━━○                │
│  1.评测类型 2.模型选择 3.数据集 4.配置  5.资源         │
└────────────────────────────────────────────────────────┘
```

- ● 已完成步骤 - 绿色勾选
- ● 当前步骤 - 紫色高亮
- ○ 未完成步骤 - 灰色

**底部按钮**：
```
[← 上一步]                    [取消] [下一步 →]
                              [取消] [创建任务]  (最后一步)
```

### 表单验证

**实时验证规则**：

| 步骤 | 验证项 | 错误提示 |
|------|--------|----------|
| 1 | 任务名称 | "请输入任务名称" |
| 2 | 主模型 | "请选择模型" |
| 2 | 对比模型（对比评测） | "对比评测需要至少选择一个对比模型" |
| 3 | 数据集 | "请至少选择一个数据集" |
| 3 | 指标 | "请至少选择一个评测指标" |

### 访问方式

1. **模型评测页面**
   ```
   路径: /model-evaluation
   操作: 点击右上角"新建评测"按钮
   ```

2. **快捷键**（未来实现）
   ```
   Ctrl + N / Cmd + N
   ```

---

## 🎨 功能 2: Pipeline 可视化编辑器

### 特性总览

🎨 **拖拽式设计** - 从左侧面板拖拽步骤到画布  
🔗 **可视化连线** - 自动绘制步骤间的依赖关系  
⚙️ **实时配置** - 右侧面板实时编辑步骤属性  
🔄 **自动布局** - 一键优化步骤位置  
💾 **即时保存** - 保存草稿，随时恢复  

### 界面布局

```
┌────────┬──────────────────────────┬────────┐
│        │   流水线名称               │        │
│  步骤  │   流水线描述               │  属性  │
│  面板  │  [自动布局] [保存] [运行] │  面板  │
│        ├──────────────────────────┤        │
│  📊数据│                          │        │
│  预处理│        画布区域           │  步骤  │
│        │                          │  配置  │
│  🔄数据│      ┌──┐                │        │
│  增强  │      │S1│───┐            │  • 名称│
│        │      └──┘   │            │  • 描述│
│  🎯模型│           ┌─▼─┐          │  • 依赖│
│  训练  │           │S2 │          │  • 资源│
│        │           └─┬─┘          │        │
│  📈模型│             │            │        │
│  评测  │           ┌─▼─┐          │  [删除]│
│        │           │S3 │          │        │
│  ⚡模型│           └───┘          │        │
│  优化  │                          │        │
│        │                          │        │
│  🚀模型│                          │        │
│  部署  │                          │        │
└────────┴──────────────────────────┴────────┘
```

### 使用流程

#### 1. 创建 Pipeline

**访问编辑器**：
```
方式1: Pipeline 编排页面 → "新建 Pipeline" 按钮
方式2: 直接访问 /pipeline-editor
```

**编辑现有 Pipeline**：
```
Pipeline 列表 → 操作菜单 → "编辑"
URL: /pipeline-editor?id=pipeline-001
```

#### 2. 添加步骤

**方式 1: 拖拽添加**
```
1. 从左侧面板选择步骤类型
2. 按住鼠标左键拖拽
3. 拖到画布目标位置
4. 释放鼠标，步骤自动添加
```

**方式 2: 双击添加**（未来实现）
```
双击画布 → 选择步骤类型 → 确认
```

#### 3. 配置步骤

**点击步骤** → 右侧显示属性面板

**基本信息**：
```
┌────────────────────────────┐
│ 步骤配置                    │
├────────────────────────────┤
│ 步骤名称                    │
│ [模型训练            ]      │
│                            │
│ 描述                       │
│ [使用 LoRA 微调 Qwen2-7B] │
│                            │
│ 步骤类型                    │
│ [模型训练]                 │
└────────────────────────────┘
```

**依赖关系**：
```
┌────────────────────────────┐
│ 依赖步骤                    │
├────────────────────────────┤
│ [添加依赖步骤 ▼]           │
│                            │
│ • 数据预处理      [删除]   │
│ • 数据增强        [删除]   │
└────────────────────────────┘
```

**资源配置**：
```
┌────────────────────────────┐
│ 资源配置                    │
├────────────────────────────┤
│ CPU 核数                    │
│ [16          ]             │
│                            │
│ 内存 (GB)                   │
│ [64          ]             │
│                            │
│ GPU 型号 (训练/评测步骤)     │
│ [NVIDIA A100 ▼]            │
│                            │
│ GPU 数量                    │
│ [4           ]             │
└────────────────────────────┘
```

#### 4. 建立依赖

**方法**：
```
1. 点击步骤进入编辑模式
2. 在右侧"依赖步骤"下拉框选择前置步骤
3. 画布自动绘制连线
```

**依赖关系可视化**：
```
┌──┐
│S1│────────┐
└──┘        │
           ▼
         ┌──┐
         │S2│────┐
         └──┘    │
                ▼
              ┌──┐
              │S3│
              └──┘
```

- 箭头方向：从依赖步骤指向当前步骤
- 线条颜色：紫色（#8b5cf6）
- 线型：贝塞尔曲线

#### 5. 自动布局

**功能**：
- 自动计算步骤层级
- 优化步骤位置
- 防止重叠
- 美化连线

**算法**：
```typescript
1. 计算每个步骤的层级
   - 无依赖: 层级 0
   - 有依赖: max(依赖层级) + 1

2. 按层级分组
   - 层级 0: [步骤A, 步骤B]
   - 层级 1: [步骤C]
   - 层级 2: [步骤D, 步骤E]

3. 计算位置
   - X = 层级 × 250 + 50
   - Y = 索引 × 150 + 50
```

**布局示例**：
```
层级0       层级1       层级2
 ┌──┐
 │S1│────────┐
 └──┘        │
            ▼
 ┌──┐     ┌──┐      ┌──┐
 │S2│─────│S3│──────│S5│
 └──┘     └──┘      └──┘
            │         ▲
            └────────┐│
                    ▼▼
                   ┌──┐
                   │S4│
                   └──┘
```

#### 6. 保存和运行

**保存操作**：
```
1. 填写流水线名称（必填）
2. 填写流水线描述（可选）
3. 至少添加一个步骤
4. 点击"保存"按钮
5. 返回 Pipeline 列表
```

**运行操作**：
```
1. 完成 Pipeline 编辑
2. 点击"运行"按钮
3. 自动保存（如未保存）
4. 启动 Pipeline 执行
5. 跳转到 Pipeline 列表查看状态
```

### 步骤类型

| 图标 | 类型 | 名称 | 颜色 | 典型资源 |
|------|------|------|------|----------|
| 📊 | data-preparation | 数据预处理 | 蓝色 | 8核CPU, 32GB内存 |
| 🔄 | data-augmentation | 数据增强 | 青色 | 4核CPU, 16GB内存 |
| 🎯 | model-training | 模型训练 | 紫色 | 16核CPU, 64GB内存, 4xGPU |
| 📈 | model-evaluation | 模型评测 | 绿色 | 8核CPU, 32GB内存, 1xGPU |
| ⚡ | model-optimization | 模型优化 | 琥珀色 | 8核CPU, 32GB内存 |
| 🚀 | model-deployment | 模型部署 | 天蓝色 | 4核CPU, 16GB内存 |
| ⚙️ | custom | 自定义 | 灰色 | 自定义 |

### 画布操作

**缩放**（未来实现）：
```
滚轮: 放大/缩小
Ctrl + +: 放大
Ctrl + -: 缩小
Ctrl + 0: 重置缩放
```

**平移**（未来实现）：
```
鼠标中键拖动: 移动画布
空格 + 鼠标拖动: 移动画布
```

**选择**：
```
单击步骤: 选中并编辑
Esc: 取消选择
```

**删除**：
```
选中步骤 → 右侧面板"删除步骤"按钮
选中步骤 → Delete键 (未来实现)
```

### 快捷键（规划中）

| 操作 | 快捷键 |
|------|--------|
| 保存 | Ctrl/Cmd + S |
| 撤销 | Ctrl/Cmd + Z |
| 重做 | Ctrl/Cmd + Y |
| 删除 | Delete/Backspace |
| 全选 | Ctrl/Cmd + A |
| 自动布局 | Ctrl/Cmd + L |

---

## 🎨 设计亮点

### 创建评测任务对话框

1. **渐进式披露**
   - 分步展示，避免信息过载
   - 每步专注单一任务
   - 步骤间逻辑清晰

2. **视觉反馈**
   - 步骤完成状态：绿色勾选
   - 当前步骤：紫色高亮
   - 选中项：紫色边框和背景

3. **卡片式选择**
   - 评测类型：大卡片带图标
   - 数据集：详细信息卡片
   - 指标：紧凑卡片

4. **滑块控制**
   - 直观的参数调整
   - 实时数值显示
   - 合理的默认值

5. **资源预览**
   - 配置摘要
   - 成本预估
   - 帮助决策

### Pipeline 可视化编辑器

1. **三栏布局**
   - 左：步骤库（固定宽度）
   - 中：画布（自适应）
   - 右：属性（固定宽度）

2. **拖拽交互**
   - 平滑的拖拽动画
   - 释放时的吸附效果
   - 视觉反馈

3. **连线绘制**
   - 贝塞尔曲线平滑过渡
   - 紫色主题色
   - 箭头指示方向

4. **步骤节点**
   - 彩色图标区分类型
   - 名称居中显示
   - 选中状态明显

5. **空状态设计**
   - 友好的引导提示
   - 图标 + 文字
   - 操作建议

---

## 📊 技术实现

### 创建评测任务对话框

**核心技术**：
```typescript
// 状态管理
const [currentStep, setCurrentStep] = useState(1);
const [formData, setFormData] = useState({...});

// 步骤验证
const validateStep = (step: number): boolean => {
  switch (step) {
    case 1: return !!formData.name.trim();
    case 2: return !!formData.modelId;
    case 3: return formData.selectedDatasets.length > 0 
                && formData.selectedMetrics.length > 0;
    default: return true;
  }
};

// 提交创建
const handleSubmit = async () => {
  const task = await createEvaluationTask(formData);
  toast.success('评测任务创建成功');
  onSuccess?.();
};
```

**表单数据结构**：
```typescript
{
  // 步骤1
  type: 'benchmark' | 'custom' | 'comparison',
  name: string,
  description: string,
  
  // 步骤2
  modelId: string,
  modelName: string,
  modelVersion: string,
  comparisonModels: [...],
  
  // 步骤3
  selectedDatasets: string[],
  selectedMetrics: string[],
  
  // 步骤4
  batchSize: number,
  temperature: number,
  maxTokens: number,
  topP: number,
  topK: number,
  
  // 步骤5
  gpuType: string,
  gpuCount: number,
  memoryGB: number,
  storageGB: number,
}
```

### Pipeline 可视化编辑器

**核心技术**：
```typescript
// 步骤管理
const [steps, setSteps] = useState<PipelineStep[]>([]);
const [selectedStep, setSelectedStep] = useState<PipelineStep | null>(null);
const [connections, setConnections] = useState<Connection[]>([]);

// 拖拽处理
const handleCanvasDrop = (e: React.DragEvent) => {
  const x = e.clientX - rect.left - 60;
  const y = e.clientY - rect.top - 40;
  addStep(draggedStepType, x, y);
};

// 连线绘制
<svg>
  {connections.map(conn => {
    const path = `M ${x1} ${y1} C ${cpX1} ${cpY1}, ${cpX2} ${cpY2}, ${x2} ${y2}`;
    return <path d={path} stroke="#8b5cf6" />;
  })}
</svg>

// 自动布局
const autoLayout = () => {
  const levels = calculateLevels(steps);
  const positioned = steps.map(step => ({
    ...step,
    position: {
      x: levels[step.id] * 250 + 50,
      y: indexInLevel * 150 + 50,
    },
  }));
  setSteps(positioned);
};
```

**SVG 连线**：
```typescript
// 贝塞尔曲线
const x1 = fromStep.position.x + 120;  // 起点
const y1 = fromStep.position.y + 40;
const x2 = toStep.position.x;          // 终点
const y2 = toStep.position.y + 40;
const cpX = (x1 + x2) / 2;             // 控制点
const cpY = y1;                         // 控制点

// 路径
`M ${x1} ${y1} C ${cpX} ${cpY}, ${cpX} ${y2}, ${x2} ${y2}`
```

---

## 🚀 使用示例

### 示例 1: 创建基准评测

```
1. 点击"新建评测"
2. 选择"基准评测"
3. 输入名称: "Qwen2-7B 综合评测"
4. 下一步
5. 选择模型: Qwen2-7B-Instruct v1.0
6. 下一步
7. 选择数据集: MMLU, C-Eval, HumanEval
8. 选择指标: 准确率, 推理延迟, 吞吐量
9. 下一步
10. 配置参数: 
    - 批处理: 8
    - Temperature: 0.7
    - 最大Token: 2048
11. 下一步
12. 配置资源:
    - GPU: 1x NVIDIA A100
    - 内存: 40GB
    - 存储: 100GB
13. 创建任务
```

**结果**：
- 任务已创建，状态"等待中"
- 系统自动分配资源
- 开始执行评测

### 示例 2: 创建训练 Pipeline

```
1. 进入 Pipeline 编排页面
2. 点击"新建 Pipeline"
3. 输入名称: "Llama-3 微调流水线"
4. 输入描述: "使用自定义数据集微调 Llama-3-8B"
5. 从左侧拖拽"数据预处理"到画布
6. 拖拽"模型训练"到画布
7. 拖拽"模型评测"到画布
8. 点击"模型训练"步骤
9. 在右侧添加依赖: 数据预处理
10. 配置资源: 4x NVIDIA A100, 64GB内存
11. 点击"模型评测"步骤
12. 添加依赖: 模型训练
13. 配置资源: 1x NVIDIA A100, 32GB内存
14. 点击"自动布局"优化位置
15. 点击"保存"
```

**结果**：
- Pipeline 已保存
- 返回列表页面
- 可以点击"运行"执行

---

## 🎯 核心优势

### 用户体验

✅ **降低门槛** - 引导式流程，新手友好  
✅ **提高效率** - 可视化操作，直观快速  
✅ **减少错误** - 实时验证，及时反馈  
✅ **灵活配置** - 参数丰富，满足不同需求  
✅ **美观现代** - 设计精美，符合品牌调性

### 技术架构

✅ **组件化** - 高度解耦，易于维护  
✅ **类型安全** - TypeScript 全覆盖  
✅ **状态管理** - React Hooks，简洁高效  
✅ **响应式** - 适配各种屏幕  
✅ **可扩展** - 易于添加新功能

---

## 📝 后续改进计划

### 创建评测任务对话框

**Phase 2**:
- [ ] 支持快捷键导航（Enter/Esc）
- [ ] 添加"保存草稿"功能
- [ ] 支持从模板创建
- [ ] 高级配置折叠面板
- [ ] 实时预览评测报告

**Phase 3**:
- [ ] 批量创建评测任务
- [ ] 评测任务队列管理
- [ ] 智能参数推荐
- [ ] 历史配置复用

### Pipeline 可视化编辑器

**Phase 2**:
- [ ] 画布缩放和平移
- [ ] 框选多个步骤
- [ ] 步骤组group功能
- [ ] 复制粘贴步骤
- [ ] 撤销/重做功能

**Phase 3**:
- [ ] 步骤模板库
- [ ] 条件分支
- [ ] 循环执行
- [ ] 并行执行
- [ ] 实时执行预览

**Phase 4**:
- [ ] 协作编辑
- [ ] 版本历史
- [ ] 拖拽优化（吸附、对齐）
- [ ] 小地图导航
- [ ] 导入/导出YAML

---

## 🐛 已知问题

### 创建评测任务对话框

1. **移动端适配**
   - 状态: 部分完成
   - 影响: 小屏幕上步骤指示器可能折叠
   - 计划: Phase 2 优化

2. **表单持久化**
   - 状态: 未实现
   - 影响: 刷新页面会丢失填写内容
   - 计划: Phase 2 添加

### Pipeline 可视化编辑器

1. **画布滚动**
   - 状态: 有限支持
   - 影响: 大型 Pipeline 难以查看全局
   - 计划: Phase 2 添加缩放

2. **步骤拖动**
   - 状态: 未实现
   - 影响: 只能删除重建，不能移动
   - 计划: Phase 2 实现

3. **连线编辑**
   - 状态: 只能通过依赖关系
   - 影响: ���能直接拖拽连线
   - 计划: Phase 3 实现

---

## 📚 相关文档

1. **完整功能文档**
   - [模型评测与Pipeline编排](./MODEL_EVALUATION_AND_PIPELINE.md)

2. **快速开始指南**
   - [快速开始](./EVALUATION_PIPELINE_QUICK_START.md)

3. **实现总结**
   - [新模块总结](./NEW_MODULES_SUMMARY.md)

---

## 🎉 总结

通过这次功能发布，我们成功实现了：

✅ **创建评测任务对话框**
- 5步引导流程
- 3种评测类型
- 5个数据集 + 8个指标
- 完整的参数配置
- 资源配置和成本预估

✅ **Pipeline 可视化编辑器**
- 拖拽式步骤添加
- 可视化依赖连线
- 实时属性编辑
- 自动布局优化
- 保存和运行功能

这两个功能极大地提升了用户体验，降低了使用门槛，是费米集群系统迈向专业 AI 平台的重要一步！

---

**文档版本**: v1.0  
**最后更新**: 2024-11-14  
**状态**: ✅ 功能已发布
